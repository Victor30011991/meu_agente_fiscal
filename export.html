<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Exportação PDF</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;padding:20px}
canvas{max-width:500px;margin-bottom:20px}
</style>
</head>
<body>

<h2>Relatório financeiro</h2>

<button onclick="exportPDF()">Exportar PDF</button>

<br><br>

<canvas id="graficoPizza"></canvas>
<canvas id="graficoPerc"></canvas>
<canvas id="graficoResumo"></canvas>

<script>
/* ---------------- DADOS ---------------- */

const dados = [
  { data:"01/02/2026", desc:"Venda balcão", categoria:"Vendas", tipo:"Entrada", valor:150 },
  { data:"02/02/2026", desc:"Ifood", categoria:"Vendas", tipo:"Entrada", valor:220 },
  { data:"03/02/2026", desc:"Fornecedor pão", categoria:"Compras", tipo:"Saída", valor:90 },
  { data:"04/02/2026", desc:"Energia", categoria:"Fixo", tipo:"Saída", valor:120 },
  { data:"05/02/2026", desc:"Venda delivery", categoria:"Vendas", tipo:"Entrada", valor:180 }
];

/* ---------------- TEMA ---------------- */

const colors = {
  text:[60,60,60],
  entrada:[46,125,50],
  saida:[198,40,40],
  headerBg:[245,247,250],
  headerText:[80,80,80]
};

/* ---------------- UTIL ---------------- */

function money(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* ---------------- TOTAIS ---------------- */

const totalEnt = dados
  .filter(l=>l.tipo==="Entrada")
  .reduce((s,l)=>s+l.valor,0);

const totalSai = dados
  .filter(l=>l.tipo==="Saída")
  .reduce((s,l)=>s+l.valor,0);

/* ---------------- GRÁFICOS ---------------- */

const ctxPizza  = document.getElementById("graficoPizza");
const ctxPerc   = document.getElementById("graficoPerc");
const ctxResumo = document.getElementById("graficoResumo");

const categorias = {};
dados.filter(l=>l.tipo==="Saída").forEach(l=>{
  categorias[l.categoria]=(categorias[l.categoria]||0)+l.valor;
});

const chartPizza = new Chart(ctxPizza,{
  type:"pie",
  data:{
    labels:Object.keys(categorias),
    datasets:[{data:Object.values(categorias)}]
  }
});

const chartPerc = new Chart(ctxPerc,{
  type:"bar",
  data:{
    labels:["Entradas","Saídas"],
    datasets:[{
      data:[totalEnt,totalSai]
    }]
  }
});

const chartResumo = new Chart(ctxResumo,{
  type:"bar",
  data:{
    labels:["Resultado"],
    datasets:[{
      data:[totalEnt-totalSai]
    }]
  }
});

/* =========================================================
   EXPORTAÇÃO PDF COMPLETA
========================================================= */

function exportPDF(){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();

  const M = 15;
  let y = 18;

  const lineColor = [230,230,230];

  function linhaDivisoria(){
    doc.setDrawColor(...lineColor);
    doc.setLineWidth(0.3);
    doc.line(M,y,W-M,y);
    y+=6;
  }

  function novaPaginaSePreciso(esp=10){
    if(y+esp>H-15){
      doc.addPage();
      y=18;
    }
  }

  /* -------- TÍTULO -------- */

  doc.setFontSize(12);
  doc.setFont(undefined,"bold");
  doc.setTextColor(...colors.text);
  doc.text("Relatório financeiro",M,y);

  y+=8;
  linhaDivisoria();

  /* -------- TABELA -------- */

  doc.setFontSize(9);
  doc.text("Lançamentos",M,y);
  y+=6;

  const col={
    data:M,
    desc:M+22,
    cat:M+90,
    tipo:M+120,
    val:W-M
  };

  doc.setFillColor(...colors.headerBg);
  doc.rect(M,y-5,W-2*M,7,"F");

  doc.setFontSize(8);
  doc.setTextColor(...colors.headerText);
  doc.setFont(undefined,"bold");

  doc.text("Data",col.data,y);
  doc.text("Descrição",col.desc,y);
  doc.text("Categoria",col.cat,y);
  doc.text("Tipo",col.tipo,y);
  doc.text("Valor",col.val,y,{align:"right"});

  y+=6;
  doc.setFont(undefined,"normal");

  dados.forEach(l=>{

    novaPaginaSePreciso(8);

    doc.setTextColor(...colors.text);
    doc.text(l.data,col.data,y);
    doc.text(l.desc.substring(0,28),col.desc,y);
    doc.text(l.categoria.substring(0,15),col.cat,y);

    doc.setTextColor(...(l.tipo==="Entrada"?colors.entrada:colors.saida));
    doc.text(l.tipo,col.tipo,y);

    doc.text(money(l.valor),col.val,y,{align:"right"});

    y+=5;
  });

  linhaDivisoria();

  /* -------- GRÁFICOS -------- */

  function desenharGrafico(chart,titulo){

    novaPaginaSePreciso(75);

    doc.setFontSize(9);
    doc.setFont(undefined,"bold");
    doc.setTextColor(...colors.text);
    doc.text(titulo,M,y);
    y+=4;

    const img=chart.canvas.toDataURL("image/png",1.0);

    const largura=W-2*M;
    const altura=largura*0.55;

    doc.addImage(img,"PNG",M,y,largura,altura,undefined,"FAST");

    y+=altura+8;
    linhaDivisoria();
  }

  desenharGrafico(chartPizza,"Distribuição de gastos por categoria");
  desenharGrafico(chartPerc,"Entradas x saídas");
  desenharGrafico(chartResumo,"Resumo geral");

  /* -------- RESUMO INTERPRETATIVO -------- */

  const qtdEntradas=dados.filter(l=>l.tipo==="Entrada").length;
  const qtdSaidas=dados.filter(l=>l.tipo==="Saída").length;

  novaPaginaSePreciso(45);

  doc.setFontSize(9);
  doc.setFont(undefined,"bold");
  doc.text("Análise dos gráficos",M,y);
  y+=6;

  doc.setFontSize(8);
  doc.setFont(undefined,"normal");

  let texto1=
`Foram identificados ${qtdEntradas} lançamentos de entrada e ${qtdSaidas} lançamentos de saída no período analisado.
Esses dados representam a movimentação utilizada para gerar os gráficos.`;

  let linhas=doc.splitTextToSize(texto1,W-2*M);
  doc.text(linhas,M,y);
  y+=linhas.length*4+3;

  let texto2=
`O gráfico de categorias considera apenas as saídas e agrupa os valores por categoria.
O gráfico de entradas e saídas compara os totais financeiros de cada tipo.
O gráfico de resumo consolida o resultado final pela diferença entre entradas e saídas.`;

  linhas=doc.splitTextToSize(texto2,W-2*M);
  doc.text(linhas,M,y);
  y+=linhas.length*4+3;

  const saldo=totalEnt-totalSai;

  let texto3="";
  if(saldo>0){
    texto3="A saúde financeira do período é positiva, pois as entradas superaram as saídas.";
  }else if(saldo<0){
    texto3="A saúde financeira do período exige atenção, pois as saídas superaram as entradas.";
  }else{
    texto3="A saúde financeira do período é neutra, sem resultado positivo ou negativo.";
  }

  linhas=doc.splitTextToSize(texto3,W-2*M);
  doc.text(linhas,M,y);
  y+=linhas.length*4+4;

  linhaDivisoria();

  /* -------- RESUMO FINANCEIRO -------- */

  novaPaginaSePreciso(20);

  doc.setFontSize(9);
  doc.setFont(undefined,"bold");
  doc.text("Resumo financeiro",M,y);
  y+=6;

  doc.setFontSize(8);
  doc.setFont(undefined,"normal");

  doc.setTextColor(...colors.text);
  doc.text("Entradas:",M,y);
  doc.setTextColor(...colors.entrada);
  doc.text(money(totalEnt),M+22,y);

  doc.setTextColor(...colors.text);
  doc.text("Saídas:",M+60,y);
  doc.setTextColor(...colors.saida);
  doc.text(money(totalSai),M+78,y);

  doc.setTextColor(...colors.text);
  doc.text("Resultado:",M+118,y);

  const corResultado=saldo>=0?colors.entrada:colors.saida;
  doc.setTextColor(...corResultado);
  doc.text(money(saldo),M+145,y);

  y+=6;
  linhaDivisoria();

  doc.save("relatorio-financeiro.pdf");
}
</script>

</body>
</html>
