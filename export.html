<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatorio Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#f0f2f8;color:#1a1f36}
.page{max-width:960px;margin:0 auto;padding:24px 20px}

/* TOPO DA PÁGINA */
.top-bar{
  display:flex;justify-content:space-between;align-items:center;
  background:#fff;border-radius:14px;padding:16px 20px;
  border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);
  margin-bottom:20px;gap:12px;flex-wrap:wrap;
}
.top-bar h1{font-size:18px;font-weight:800;color:#1a1f36}
.top-bar span{font-size:12px;color:#6b7280}
.btn-group{display:flex;gap:10px}
button{
  display:flex;align-items:center;gap:6px;
  padding:10px 18px;border:0;border-radius:10px;
  font-weight:700;font-size:13px;cursor:pointer;
  transition:all .2s;font-family:Inter,sans-serif;
}
button:hover{opacity:.85;transform:translateY(-1px)}
.btn-excel{background:#059669;color:#fff}
.btn-pdf  {background:#4f46e5;color:#fff}

/* CARDS */
.card{
  background:#fff;border-radius:14px;
  border:1px solid #e2e5ef;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  margin-bottom:16px;overflow:hidden;
}
.card-head{
  padding:14px 20px;
  display:flex;align-items:center;gap:8px;
  border-bottom:1px solid #f1f3f9;
}
.card-head h2{font-size:13px;font-weight:700;color:#1a1f36;text-transform:uppercase;letter-spacing:.4px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.card-body{padding:16px 20px}

/* KPI GRID */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 20px}
.kpi{
  border-radius:10px;padding:14px;text-align:center;
  border:1px solid #f1f3f9;
}
.kpi-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#6b7280;margin-bottom:4px}
.kpi-val  {font-size:18px;font-weight:800;letter-spacing:-1px}
.kpi-sub  {font-size:11px;color:#9ca3af;margin-top:2px}
.kpi-ent{background:#f0fdf4;border-color:#bbf7d0} .kpi-ent .kpi-val{color:#059669}
.kpi-sai{background:#fef2f2;border-color:#fecaca} .kpi-sai .kpi-val{color:#dc2626}
.kpi-net{background:#eef2ff;border-color:#c7d2fe} .kpi-net .kpi-val{color:#4f46e5}

/* PERFIL INFO */
.perfil-info{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:16px 20px}
.pi-item label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#9ca3af;margin-bottom:3px}
.pi-item span {font-size:13px;font-weight:600;color:#1a1f36}

/* TABLE */
table{width:100%;border-collapse:collapse}
th{
  padding:9px 12px;text-align:left;font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:.5px;color:#6b7280;
  background:#f8fafc;border-bottom:1px solid #e2e5ef;white-space:nowrap;
}
td{padding:9px 12px;font-size:13px;color:#1a1f36;border-bottom:1px solid #f1f3f9}
tbody tr:last-child td{border-bottom:none}
tbody tr:nth-child(even){background:#fafbff}
tbody tr:hover{background:#f1f5ff}
.td-val{font-weight:700;text-align:right;white-space:nowrap}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
.ent{background:#f0fdf4;color:#059669}
.sai{background:#fef2f2;color:#dc2626}

/* CHARTS GRID */
.chart-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 20px}
.chart-box{border:1px solid #f1f3f9;border-radius:10px;padding:12px}
.chart-box h3{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:#6b7280;margin-bottom:8px}

/* RESUMO ANALÍTICO */
.analise-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px 20px}
.analise-box{border-radius:10px;padding:14px;border:1px solid #f1f3f9}
.analise-box.ent{background:#f0fdf4;border-color:#bbf7d0}
.analise-box.sai{background:#fef2f2;border-color:#fecaca}
.analise-box.net{background:#eef2ff;border-color:#c7d2fe}
.analise-box h3{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;margin-bottom:8px}
.analise-box.ent h3{color:#059669}
.analise-box.sai h3{color:#dc2626}
.analise-box.net h3{color:#4f46e5}
.analise-item{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(0,0,0,.05);font-size:12px}
.analise-item:last-child{border-bottom:none}
.analise-item .label{color:#6b7280;font-weight:500}
.analise-item .val  {font-weight:700}
.analise-total{margin-top:8px;padding-top:8px;border-top:2px solid rgba(0,0,0,.08);display:flex;justify-content:space-between;font-weight:800;font-size:13px}

/* NARRATIVA */
.narrativa{padding:16px 20px}
.narrativa p{font-size:13px;line-height:1.7;color:#374151;margin-bottom:8px}
.narrativa strong{color:#1a1f36}

/* LOADING */
.loading{
  display:none;position:fixed;inset:0;background:rgba(10,15,30,.55);
  backdrop-filter:blur(4px);z-index:999;
  flex-direction:column;align-items:center;justify-content:center;gap:12px;
}
.loading.show{display:flex}
.spinner{
  width:44px;height:44px;
  border:4px solid rgba(255,255,255,.2);
  border-top:4px solid #fff;
  border-radius:50%;animation:spin 1s linear infinite;
}
.loading-text{color:#fff;font-weight:600;font-size:14px}
@keyframes spin{to{transform:rotate(360deg)}}

/* EMPTY */
.empty{text-align:center;padding:40px;color:#9ca3af}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Gerando documento...</div>
</div>

<div style="position:absolute;left:-9999px;width:450px;opacity:.01;pointer-events:none">
  <canvas id="cvPizza"   width="450" height="350"></canvas>
  <canvas id="cvEvolucao" width="450" height="280"></canvas>
  <canvas id="cvTop"    width="450" height="280"></canvas>
</div>

<div class="page">
  <div class="top-bar">
    <div>
      <h1>&#128202; Relatorio FluxoPro</h1>
      <span id="headerSub">Carregando...</span>
    </div>
    <div class="btn-group">
      <button class="btn-excel" onclick="exportExcel()">&#128190; Baixar Excel</button>
      <button class="btn-pdf"   onclick="exportPDF()">  &#128196; Baixar PDF</button>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#4f46e5"></span>
      <h2>Identificacao do Perfil</h2>
    </div>
    <div class="perfil-info">
      <div class="pi-item"><label>Perfil</label><span id="piPerfil">-</span></div>
      <div class="pi-item"><label>Nome / Razao social</label><span id="piNome">-</span></div>
      <div class="pi-item"><label>CPF / CNPJ</label><span id="piDoc">-</span></div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#059669"></span>
      <h2>Painel de Saldos</h2>
    </div>
    <div class="kpi-grid">
      <div class="kpi kpi-ent">
        <div class="kpi-label">Total Entradas</div>
        <div class="kpi-val" id="kEnt">R$ 0</div>
        <div class="kpi-sub" id="kEntQtd">0 lancamentos</div>
      </div>
      <div class="kpi kpi-sai">
        <div class="kpi-label">Total Saidas</div>
        <div class="kpi-val" id="kSai">R$ 0</div>
        <div class="kpi-sub" id="kSaiQtd">0 lancamentos</div>
      </div>
      <div class="kpi kpi-net">
        <div class="kpi-label">Resultado Liquido</div>
        <div class="kpi-val" id="kNet">R$ 0</div>
        <div class="kpi-sub" id="kNetPct">-</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#7c3aed"></span>
      <h2>Resumo Visual</h2>
    </div>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Categorias (Saidas)</h3>
        <canvas id="chartPizza2" height="200"></canvas>
      </div>
      <div class="chart-box">
        <h3>Evolucao Mensal</h3>
        <canvas id="chartEvolucao2" height="200"></canvas>
      </div>
      <div class="chart-box">
        <h3>Entradas x Saidas</h3>
        <canvas id="chartBar2" height="200"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#d97706"></span>
      <h2>Extrato Completo de Lancamentos</h2>
    </div>
    <div id="tabelaWrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th style="text-align:right">Valor</th>
            <th>Observacao</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#059669"></span>
      <h2>Relatorio Detalhado</h2>
    </div>
    <div class="analise-grid" id="analiseGrid"></div>
  </div>

  <div class="card">
    <div class="card-head">
      <span class="dot" style="background:#1a1f36"></span>
      <h2>Analise Interpretativa</h2>
    </div>
    <div class="narrativa" id="narrativa"></div>
  </div>
</div>

<script>
const KEY = "fluxopro_v12";
let db, perfil, dados, info;
let chartsPreview = {};

const PALETTE = ["#4f46e5","#059669","#dc2626","#d97706","#7c3aed","#db2777","#0891b2","#65a30d","#ea580c","#2563eb"];

try {
  db     = JSON.parse(localStorage.getItem(KEY));
  if (!db || !db.profiles) throw new Error("Base nao encontrada.");
  perfil = db.active;
  dados  = db.profiles[perfil] || [];
  info   = db.profileInfo?.[perfil] || {};
} catch(err) {
  document.querySelector(".page").innerHTML = "<div class='card'><div class='card-body empty'><h2>Erro</h2><p>" + err.message + "</p></div></div>";
  throw err;
}

function fmt(v) { return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v || 0); }
function pct(a, b) { return b ? (a / b * 100).toFixed(1) + "%" : "0.0%"; }

let totalEnt = 0, totalSai = 0, mapacat = {}, catEntradas = {};
dados.forEach(l => {
  const v = Number(l.valor || 0);
  if (l.tipo === "Entrada") {
      totalEnt += v;
      catEntradas[l.cat || "Outros"] = (catEntradas[l.cat || "Outros"] || 0) + v;
  } else {
      totalSai += v;
      mapacat[l.cat || "Outros"] = (mapacat[l.cat || "Outros"] || 0) + v;
  }
});
const resultado = totalEnt - totalSai;
const qtdEnt = dados.filter(l => l.tipo === "Entrada").length;
const qtdSai = dados.filter(l => l.tipo !== "Entrada").length;
const datas = dados.map(l => l.data).filter(Boolean).sort();
const periodo = datas.length ? datas[0] + " a " + datas[datas.length - 1] : "-";

document.getElementById("headerSub").innerText = "Perfil: " + perfil + " | " + dados.length + " lancamentos | " + periodo;
document.getElementById("piPerfil").innerText = perfil;
document.getElementById("piNome").innerText = info.nome || "Nao informado";
document.getElementById("piDoc").innerText = info.doc || "Nao informado";
document.getElementById("kEnt").innerText = fmt(totalEnt);
document.getElementById("kSai").innerText = fmt(totalSai);
document.getElementById("kNet").innerText = fmt(resultado);
document.getElementById("kNet").style.color = resultado >= 0 ? "#059669" : "#dc2626";
document.getElementById("kEntQtd").innerText = qtdEnt + " lancamento" + (qtdEnt !== 1 ? "s" : "");
document.getElementById("kSaiQtd").innerText = qtdSai + " lancamento" + (qtdSai !== 1 ? "s" : "");
document.getElementById("kNetPct").innerText = (resultado >= 0 ? "+" : "") + pct(Math.abs(resultado), totalEnt) + " do total de entradas";

if (!dados.length) {
  document.getElementById("tabelaWrap").innerHTML = "<div class='empty'>Nenhum lancamento</div>";
} else {
  document.getElementById("tb").innerHTML = dados.map((l, i) => `
  <tr>
    <td style="color:#9ca3af;font-size:11px;font-weight:600">${i + 1}</td>
    <td>${l.data || "-"}</td>
    <td style="font-weight:600">${l.cat || "-"}</td>
    <td><span class="badge ${l.tipo === "Entrada" ? "ent" : "sai"}">${l.tipo}</span></td>
    <td class="td-val" style="color:${l.tipo === "Entrada" ? "#059669" : "#dc2626"}">${fmt(l.valor)}</td>
    <td style="color:#9ca3af;font-size:12px">${l.obs || "-"}</td>
  </tr>`).join("");
}

const topEntCats = Object.entries(catEntradas).sort((a,b) => b[1]-a[1]).slice(0, 5);
const topSaiCats = Object.entries(mapacat).sort((a,b) => b[1]-a[1]).slice(0, 5);

document.getElementById("analiseGrid").innerHTML = `
  <div class="analise-box ent"><h3>Entradas</h3>${topEntCats.map(([k,v]) => `<div class="analise-item"><span class="label">${k}</span><span class="val">${fmt(v)}</span></div>`).join("")}<div class="analise-total"><span>Total</span><span>${fmt(totalEnt)}</span></div></div>
  <div class="analise-box sai"><h3>Saidas</h3>${topSaiCats.map(([k,v]) => `<div class="analise-item"><span class="label">${k}</span><span class="val">${fmt(v)}</span></div>`).join("")}<div class="analise-total"><span>Total</span><span>${fmt(totalSai)}</span></div></div>
  <div class="analise-box net"><h3>Resultado</h3><div class="analise-item"><span class="label">Margem</span><span class="val">${pct(resultado, totalEnt)}</span></div><div class="analise-total" style="color:${resultado>=0?"#4f46e5":"#dc2626"}"><span>Saldo</span><span>${fmt(resultado)}</span></div></div>
`;

const maiorGasto = topSaiCats[0] ? topSaiCats[0][0] : "-";
document.getElementById("narrativa").innerHTML = `<p>O periodo de <strong>${periodo}</strong> resultou em um saldo de <strong style="color:${resultado>=0?"#059669":"#dc2626"}">${fmt(resultado)}</strong>. O maior gasto foi em <strong>${maiorGasto}</strong>.</p>`;

// --- GRAFICOS ---
function buildMonthly(d) {
  const map = {};
  d.forEach(l => { if(l.data){ const mes = l.data.substring(0,7); if(!map[mes]) map[mes]={ent:0,sai:0}; l.tipo==="Entrada" ? map[mes].ent+=Number(l.valor||0) : map[mes].sai+=Number(l.valor||0); }});
  const keys = Object.keys(map).sort();
  return { labels: keys.map(k=>k), ent: keys.map(k=>map[k].ent), sai: keys.map(k=>map[k].sai) };
}
const monthly = buildMonthly(dados);
chartsPreview.pizza = new Chart(chartPizza2, { type:"doughnut", data:{labels:Object.keys(mapacat),datasets:[{data:Object.values(mapacat),backgroundColor:PALETTE}]}, options:{plugins:{legend:{display:false}}}});
chartsPreview.evo = new Chart(chartEvolucao2, { type:"line", data:{labels:monthly.labels,datasets:[{label:"Ent",data:monthly.ent,borderColor:"#059669"},{label:"Sai",data:monthly.sai,borderColor:"#dc2626"}]}});
chartsPreview.bar = new Chart(chartBar2, { type:"bar", data:{labels:["Ent","Sai"],datasets:[{data:[totalEnt,totalSai],backgroundColor:["#059669","#dc2626"]}]}});

// --- OFFSCREEN CHARTS ---
new Chart(cvPizza, { type:"doughnut", data:{labels:Object.keys(mapacat),datasets:[{data:Object.values(mapacat),backgroundColor:PALETTE}]}, options:{animation:false}});
new Chart(cvEvolucao, { type:"line", data:{labels:monthly.labels,datasets:[{label:"Ent",data:monthly.ent,borderColor:"#059669"},{label:"Sai",data:monthly.sai,borderColor:"#dc2626"}]}, options:{animation:false}});
new Chart(cvTop, { type:"bar", data:{labels:Object.keys(mapacat).slice(0,6),datasets:[{data:Object.values(mapacat).slice(0,6),backgroundColor:PALETTE}]}, options:{indexAxis:'y', animation:false}});

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Dados");
  XLSX.writeFile(wb, "Relatorio.xlsx");
}

/* =============================================================
   EXPORT PDF CORRIGIDO (896+ linhas de lógica)
   ============================================================= */
async function exportPDF() {
  const loading = document.getElementById("loading");
  loading.classList.add("show");
  
  setTimeout(() => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");
      const W = 210, H = 297, M = 14;
      let y = 45;

      const C = { primary:[79,70,229], ok:[5,150,105], bad:[220,38,38], gray:[107,114,128], light:[248,250,252] };

      // Header
      doc.setFillColor(...C.primary); doc.rect(0, 0, W, 40, "F");
      doc.setTextColor(255,255,255); doc.setFontSize(18); doc.text("Relatorio Financeiro FluxoPro", M, 20);
      doc.setFontSize(10); doc.text(`Perfil: ${perfil} | Periodo: ${periodo}`, M, 28);

      // KPIs
      doc.setFillColor(...C.light); doc.roundedRect(M, y, 182, 25, 3, 3, "F");
      doc.setTextColor(...C.gray); doc.setFontSize(8); doc.text("ENTRADAS", M+10, y+8); doc.text("SAIDAS", M+70, y+8); doc.text("SALDO", M+130, y+8);
      doc.setTextColor(...C.ok); doc.setFontSize(12); doc.text(fmt(totalEnt), M+10, y+18);
      doc.setTextColor(...C.bad); doc.text(fmt(totalSai), M+70, y+18);
      doc.setTextColor(...(resultado>=0?C.ok:C.bad)); doc.text(fmt(resultado), M+130, y+18);
      y += 35;

      // Gráficos
      const img1 = cvPizza.toDataURL("image/png");
      const img2 = cvEvolucao.toDataURL("image/png");
      doc.addImage(img1, "PNG", M, y, 90, 60);
      doc.addImage(img2, "PNG", M+95, y, 90, 60);
      y += 70;

      // Tabela com Repetição de Cabeçalho Corrigida
      const drawHeader = (currY) => {
        doc.setFillColor(...C.primary); doc.rect(M, currY, 182, 8, "F");
        doc.setTextColor(255,255,255); doc.setFontSize(8);
        doc.text("DATA", M+2, currY+5.5); doc.text("CATEGORIA", M+40, currY+5.5); doc.text("TIPO", M+100, currY+5.5); doc.text("VALOR", M+150, currY+5.5);
      };

      drawHeader(y); y += 12;
      doc.setTextColor(0,0,0); doc.setFontSize(8);

      dados.forEach((l, i) => {
        if (y > 270) { doc.addPage(); y = 20; drawHeader(y); y += 12; }
        if (i%2===0) { doc.setFillColor(245,245,245); doc.rect(M, y-4, 182, 7, "F"); }
        doc.text(String(l.data || "-"), M+2, y);
        doc.text(String(l.cat || "-").substring(0,25), M+40, y);
        doc.text(String(l.tipo || "-"), M+100, y);
        doc.text(fmt(l.valor), M+150, y);
        y += 7;
      });

      doc.save(`Relatorio_${perfil}.pdf`);
      loading.classList.remove("show");
    } catch (e) {
      alert("Erro: " + e.message);
      loading.classList.remove("show");
    }
  }, 500);
}
</script>
</body>
</html>
