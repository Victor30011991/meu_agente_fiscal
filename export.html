<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px 0}
.box{border-radius:12px;padding:15px;text-align:center;font-weight:700;color:#fff}
.entrada{background:#22c55e}
.saida{background:#ef4444}
.liquido{background:#3b82f6}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:12px}
th{background:#fafafa}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="container">
  <div class="top">
    <h1>Relatório FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
      <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
    </div>
  </div>

  <div class="card">
    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box entrada" id="ent"></div>
      <div class="box saida" id="sai"></div>
      <div class="box liquido" id="res"></div>
    </div>

    <div id="conteudo">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Gráficos offscreen -->
<div style="position:absolute;left:-9999px;width:400px">
  <canvas id="chartPizza" width="400" height="400"></canvas>
  <canvas id="chartPerc" width="400" height="400"></canvas>
  <canvas id="chartResumo" width="400" height="300"></canvas>
</div>

<script>
const KEY="fluxopro_v12";
let db = JSON.parse(localStorage.getItem(KEY)) || {active:"default", profiles:{default:[]}, profileInfo:{}};
let perfil = db.active;
let dados = db.profiles[perfil] || [];
let info = db.profileInfo?.[perfil] || {};

function money(v){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0); }

document.getElementById("perfilTitulo").innerText = "Perfil: " + perfil;
document.getElementById("perfilDados").innerHTML = `<p><b>Nome:</b> ${info.nome||"-"}</p><p><b>Documento:</b> ${info.doc||"-"}</p>`;

let totalEnt=0,totalSai=0;
dados.forEach(l=>{ const v=Number(l.valor||0); if(l.tipo==="Entrada") totalEnt+=v; if(l.tipo==="Saída") totalSai+=v; });
const resultado=totalEnt-totalSai;

document.getElementById("ent").innerText = "Entradas\n" + money(totalEnt);
document.getElementById("sai").innerText = "Saídas\n" + money(totalSai);
document.getElementById("res").innerText = "Resultado\n" + money(resultado);

const tb = document.getElementById("tb");
tb.innerHTML = dados.map(l=>`
<tr>
<td>${l.data||"-"}</td>
<td>${l.cat||"-"}</td>
<td style="color:${l.tipo==="Entrada"?"#10b981":"#ef4444"}">${l.tipo}</td>
<td>${money(l.valor)}</td>
<td>${l.obs||"-"}</td>
</tr>`).join("");

/* ==== Gráficos ==== */
let charts = {};
function createCharts(){
  let mapa={};
  dados.forEach(l=>{ if(l.tipo==="Saída") mapa[l.cat||"Outros"]=(mapa[l.cat||"Outros"]||0)+Number(l.valor||0); });

  charts.pizza=new Chart(chartPizza,{type:"doughnut",data:{labels:Object.keys(mapa),datasets:[{data:Object.values(mapa),backgroundColor:["#3b82f6","#10b981","#ef4444","#f59e0b","#8b5cf6"]}]},options:{responsive:false,plugins:{legend:{position:"bottom"}}}});
  charts.perc=new Chart(chartPerc,{type:"pie",data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai],backgroundColor:["#10b981","#ef4444"]}]},options:{responsive:false,plugins:{legend:{position:"bottom"}}}});
  charts.resumo=new Chart(chartResumo,{type:"bar",data:{labels:["Entradas","Saídas","Resultado"],datasets:[{data:[totalEnt,totalSai,resultado],backgroundColor:["#10b981","#ef4444","#3b82f6"]}]},options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}
createCharts();

/* ==== Export Excel ==== */
function exportExcel(){
  if(!dados.length){alert("Sem dados"); return;}
  let ws = XLSX.utils.json_to_sheet(dados);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"FluxoPro");
  XLSX.writeFile(wb,`fluxopro_${perfil}_${Date.now()}.xlsx`);
}

/* ==== Export PDF ==== */
async function exportPDF(){
  if(!dados.length){alert("Sem dados"); return;}
  const loading=document.getElementById("loading");
  loading.classList.add("show");

  setTimeout(async ()=>{
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF("p","mm","a4");
    const W = 210, H = 297, M=12;
    let y = 20;

    // Cabeçalho colorido
    doc.setFillColor(59,130,246); // azul tema
    doc.rect(0,0,W,30,"F");
    doc.setFontSize(16); doc.setTextColor(255,255,255); doc.setFont(undefined,"bold");
    doc.text("Relatório FluxoPro", W/2, 18, {align:"center"});

    y+=25;

    doc.setFontSize(10); doc.setFont(undefined,"normal"); doc.setTextColor(31,41,55);
    doc.text(`Perfil: ${perfil}`, M, y); y+=4;
    doc.text(`Nome: ${info.nome||"-"}`, M, y); y+=4;
    doc.text(`Documento: ${info.doc||"-"}`, M, y); y+=6;

    // Painel de saldos moderno
    const boxW = (W-2*M-20)/3, boxH = 15;
    const boxes = [
      {label:"Entradas", value:money(totalEnt), color:[16,185,129]},
      {label:"Saídas", value:money(totalSai), color:[239,68,68]},
      {label:"Resultado", value:money(resultado), color:[59,130,246]}
    ];
    let xBox = M;
    boxes.forEach(b=>{
      doc.setFillColor(...b.color);
      doc.roundedRect(xBox,y,boxW,boxH,2,2,"F");
      doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont(undefined,"bold");
      doc.text(`${b.label}: ${b.value}`, xBox+boxW/2, y+10, {align:"center"});
      xBox += boxW+10;
    });
    y+=boxH+15;

    // Gráficos - transformar em imagens
    const chartElements = [chartPizza, chartPerc, chartResumo];
    let chartX = M, chartY = y;
    for(let c of chartElements){
      const img = c.toDataURL("image/png",1.0);
      doc.addImage(img,"PNG",chartX,chartY,60,60);
      chartX += 70;
    }
    y+=70;

    // Tabela
    doc.setFont(undefined,"bold"); doc.setFontSize(9); doc.setTextColor(31,41,55);
    doc.text("Lançamentos",M,y); y+=5;
    doc.setFont(undefined,"normal"); doc.setFontSize(8);

    // Cabeçalho tabela
    const headers=["Data","Categoria","Tipo","Valor","Observação"];
    let x = M;
    headers.forEach((h,i)=>{ doc.text(h,x,y); x+=i===0?25:i===1?35:i===2?25:i===3?25:30; });
    y+=4;

    dados.forEach((l,i)=>{
      if(y>H-20){doc.addPage(); y=20;}
      x = M;
      doc.text(l.data||"-",x,y); x+=25;
      doc.text((l.cat||"-").substring(0,15),x,y); x+=35;
      doc.setFont(undefined,"bold");
      doc.setTextColor(l.tipo==="Entrada"?16,185,129:239,68,68);
      doc.text(l.tipo||"-",x,y); x+=25;
      doc.setFont(undefined,"normal"); doc.setTextColor(31,41,55);
      doc.text(money(l.valor),x,y); x+=25;
      doc.text((l.obs||"-").substring(0,22),x,y);
      y+=5;
    });

    // Relatório resumido
    y+=5;
    doc.setFont(undefined,"bold"); doc.setFontSize(9); doc.setTextColor(31,41,55);
    doc.text("Resumo detalhado:",M,y); y+=5;
    doc.setFont(undefined,"normal"); doc.setFontSize(8);
    doc.text(`Total de Entradas: ${money(totalEnt)}`,M,y); y+=4;
    doc.text(`Total de Saídas: ${money(totalSai)}`,M,y); y+=4;
    doc.text(`Saldo Líquido: ${money(resultado)} (${resultado>=0?"Positivo":"Negativo"})`,M,y); y+=4;
    doc.text(`Número de lançamentos: ${dados.length}`,M,y); y+=4;

    doc.save(`fluxopro_${perfil}_${Date.now()}.pdf`);
    loading.classList.remove("show");
  },300);
}
</script>

</body>
</html>
