<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
th{background:#fafafa}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700;text-align:center}
.entrada{color:#10b981}
.saida{color:#ef4444}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="container">
  <div class="top">
    <h1>Relatório FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
      <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
    </div>
  </div>

  <div class="card">
    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box">Entradas<br><span id="ent" class="entrada"></span></div>
      <div class="box">Saídas<br><span id="sai" class="saida"></span></div>
      <div class="box">Resultado<br><span id="res"></span></div>
    </div>

    <div id="conteudo">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>

<div style="position:absolute;left:-9999px;width:400px">
  <canvas id="chartPizza" width="400" height="400"></canvas>
  <canvas id="chartPerc" width="400" height="400"></canvas>
  <canvas id="chartResumo" width="400" height="300"></canvas>
</div>

<script>
const KEY="fluxopro_v12";
let db = JSON.parse(localStorage.getItem(KEY)) || {profiles:{default:[]},active:'default'};
let perfil = db.active;
let dados = db.profiles[perfil] || [];
let info = db.profileInfo?.[perfil] || {};

function money(v){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);}

let totalEnt = dados.filter(l=>l.tipo==="Entrada").reduce((a,b)=>a+b.valor,0);
let totalSai = dados.filter(l=>l.tipo==="Saída").reduce((a,b)=>a+b.valor,0);
let resultado = totalEnt-totalSai;

document.getElementById("perfilTitulo").innerText = "Perfil: "+perfil;
document.getElementById("perfilDados").innerHTML = `<p><b>Nome:</b> ${info.nome||"-"}</p><p><b>Documento:</b> ${info.doc||"-"}</p>`;
document.getElementById("ent").innerText = money(totalEnt);
document.getElementById("sai").innerText = money(totalSai);
document.getElementById("res").innerText = money(resultado);
document.getElementById("res").style.color = resultado>=0?"#10b981":"#ef4444";

if(!dados.length) document.getElementById("conteudo").innerHTML=`<div class="empty">Nenhum lançamento</div>`;
else{
  tb.innerHTML=dados.map(l=>`<tr>
    <td>${l.data||"-"}</td>
    <td>${l.cat||"-"}</td>
    <td style="color:${l.tipo==="Entrada"?"#10b981":"#ef4444"}">${l.tipo}</td>
    <td>${money(l.valor)}</td>
    <td>${l.obs||"-"}</td>
  </tr>`).join("");
}

let charts={};
function createCharts(){
  let mapa={};
  dados.forEach(l=>{if(l.tipo==="Saída")mapa[l.cat||"Outros"]=(mapa[l.cat||"Outros"]||0)+l.valor;});

  charts.pizza = new Chart(document.getElementById("chartPizza"),{
    type:"doughnut",
    data:{labels:Object.keys(mapa),datasets:[{data:Object.values(mapa)}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });
  charts.perc = new Chart(document.getElementById("chartPerc"),{
    type:"pie",
    data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai]}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });
  charts.resumo = new Chart(document.getElementById("chartResumo"),{
    type:"bar",
    data:{labels:["Entradas","Saídas","Resultado"],datasets:[{data:[totalEnt,totalSai,resultado],backgroundColor:['#10b981','#ef4444','#4f46e5']}]},
    options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
createCharts();

/* ===== EXPORT EXCEL ===== */
function exportExcel(){
  if(!dados.length)return alert("Sem dados");
  const ws=XLSX.utils.json_to_sheet(dados.map(l=>({
    Data:l.data,Categoria:l.cat,Tipo:l.tipo,Valor:l.valor,Observacao:l.obs
  })));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"FluxoPro");
  XLSX.writeFile(wb,`fluxopro_${perfil}_${Date.now()}.xlsx`);
}

/* ===== EXPORT PDF ===== */
function exportPDF(){
  if(!dados.length){alert("Sem dados");return;}
  const loading=document.getElementById("loading"); loading.classList.add("show");
  setTimeout(()=>{
    try{
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF("p","mm","a4");
      const W=210,H=297,M=12; let y=20;
      doc.setFontSize(14); doc.setFont(undefined,"bold"); doc.text("Relatório financeiro – FluxoPro",M,y); y+=6;
      doc.setFontSize(9); doc.setFont(undefined,"normal");
      doc.text(`Perfil: ${perfil}`,M,y);y+=4;
      doc.text(`Nome: ${info.nome||"-"}`,M,y);y+=4;
      doc.text(`Documento: ${info.doc||"-"}`,M,y);y+=6;
      doc.setDrawColor(220,220,220); doc.setLineWidth(0.2); doc.line(M,y,W-M,y); y+=6;
      doc.setFont(undefined,"bold"); doc.setFontSize(9); doc.text("Lançamentos",M,y); y+=5;
      doc.setFont(undefined,"normal"); doc.setFontSize(8);
      doc.text("Data",M,y); doc.text("Categoria",M+25,y); doc.text("Tipo",M+75,y); doc.text("Valor",M+95,y); doc.text("Obs",M+120,y); y+=4;
      dados.forEach((l,i)=>{
        if(y>H-20){doc.addPage();y=20;}
        if(i%2===0){doc.setFillColor(249,250,251); doc.rect(M,y-3,W-2*M,5,"F");}
        doc.setTextColor(31,41,55);
        doc.text(l.data||"-",M,y);
        doc.text((l.cat||"-").substring(0,15),M+25,y);
        doc.setFont(undefined,"bold"); doc.setTextColor(l.tipo==="Entrada"?16,185,129:239,68,68);
        doc.text(l.tipo||"-",M+75,y);
        doc.setFont(undefined,"normal"); doc.setTextColor(31,41,55);
        doc.text(money(l.valor),M+95,y);
        doc.text((l.obs||"-").substring(0,22),M+120,y);
        y+=5;
      });
      // adicionar gráficos
      doc.addPage();
      doc.setFont(undefined,"bold"); doc.setFontSize(9); doc.text("Resumo visual",M,20);
      const imgPizza=charts.pizza.toBase64Image();
      const imgPerc=charts.perc.toBase64Image();
      const imgRes=charts.resumo.toBase64Image();
      doc.addImage(imgPizza,"PNG",M,30,60,60);
      doc.addImage(imgPerc,"PNG",M+70,30,60,60);
      doc.addImage(imgRes,"PNG",M+140,30,60,50);
      doc.save(`fluxopro_${perfil}_${Date.now()}.pdf`);
      loading.classList.remove("show");
    }catch(e){console.error(e);loading.classList.remove("show");alert("Erro ao gerar PDF");}
  },300);
}
</script>

</body>
</html>
