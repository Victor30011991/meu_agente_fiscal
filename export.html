<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>FluxoPro ‚Äì Exporta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    body{font-family:Inter;background:#f5f7fb;margin:0;color:#1f2937;}
    .container{max-width:800px;margin:auto;padding:30px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th, td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;text-align:left;}
    th{background:#f9fafb;font-weight:700;}
    button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s;margin-right:10px;}
    button:hover{opacity:.8;transform:translateY(-1px);}
    .btn-main{background:#4f46e5;color:#fff;}
    .btn-cancel{background:#ef4444;color:#fff;}
    .status{padding:10px;border-radius:10px;margin:10px 0;font-weight:700;}
    .status.success{background:#ecfdf5;color:#10b981;}
    .status.error{background:#fef2f2;color:#ef4444;}
    @media(max-width:600px){
      .actions{flex-direction:column;}
      button{width:100%;margin-bottom:10px;}
    }
  </style>
</head>
<body>

<div class="container">

  <div class="card">
    <h2>üì§ Exporta√ß√£o de Dados</h2>
    <div class="actions" style="margin-top:15px">
      <button class="btn-main" onclick="exportExcel()">üìä Exportar para Excel</button>
      <button class="btn-main" onclick="exportPDF()">üìÑ Exportar para PDF</button>
      <button class="btn-cancel" onclick="window.close()">‚ùå Fechar</button>
    </div>
    <div id="statusBox"></div>
  </div>

  <div class="card">
    <h3>Visualiza√ß√£o r√°pida</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Data</th>
          <th>Categoria</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Observa√ß√£o</th>
        </tr>
      </thead>
      <tbody id="previewTbody"></tbody>
    </table>
  </div>

</div>

<script>
const KEY="fluxopro_v12";
const params=new URLSearchParams(location.search);
let perfil=params.get("perfil");

let db = JSON.parse(localStorage.getItem(KEY)) || { active: "default", profiles: {} };
if(!perfil) perfil = db.active;

const dados = db.profiles[perfil] || [];

/* RENDER PREVIEW */
function renderPreview(){
  if(!dados.length){
    previewTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999">Nenhum lan√ßamento</td></tr>`;
    return;
  }

  previewTbody.innerHTML = dados.map((l,i) => `
    <tr>
      <td>${i+1}</td>
      <td>${l.data}</td>
      <td>${l.cat}</td>
      <td>${l.tipo}</td>
      <td>R$ ${l.valor.toFixed(2)}</td>
      <td>${l.obs||""}</td>
    </tr>
  `).join("");
}

/* EXPORT EXCEL */
function exportExcel(){
  if(!dados.length){ alert("‚ö†Ô∏è Nenhum dado para exportar"); return; }

  const ws = XLSX.utils.json_to_sheet(dados.map((d,i)=>({
    "#": i+1,
    Data: d.data,
    Categoria: d.cat,
    Tipo: d.tipo,
    Valor: d.valor.toFixed(2),
    Observacao: d.obs
  })));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Lan√ßamentos");
  XLSX.writeFile(wb, `${perfil}_FluxoPro.xlsx`);

  alert("‚úÖ Exportado para Excel!");
}

/* EXPORT PDF */
async function exportPDF(){
  if(!dados.length){ alert("‚ö†Ô∏è Nenhum dado para exportar"); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text(`FluxoPro ‚Äì Perfil: ${perfil}`, 14, 20);

  doc.setFontSize(12);
  let startY = 30;
  doc.text("# | Data | Categoria | Tipo | Valor | Observa√ß√£o", 14, startY);
  startY += 6;

  dados.forEach((l,i)=>{
    const row = `${i+1} | ${l.data} | ${l.cat} | ${l.tipo} | ${l.valor.toFixed(2)} | ${l.obs||""}`;
    doc.text(row, 14, startY);
    startY += 6;
    if(startY > 280){ doc.addPage(); startY = 20; }
  });

  doc.save(`${perfil}_FluxoPro.pdf`);
  alert("‚úÖ Exportado para PDF!");
}

/* INIT */
renderPreview();
</script>

</body>
</html>
