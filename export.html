<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatorio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#f0f2f8;color:#1a1f36}
.page{max-width:960px;margin:0 auto;padding:24px 20px}
/* TOPO, CARDS, KPI, TABELA, GRAFICOS e demais estilos mantidos igual ao original */
...
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Gerando documento...</div>
</div>

<div style="position:absolute;left:-9999px;width:450px;opacity:.01;pointer-events:none">
  <canvas id="cvPizza" width="450" height="350"></canvas>
  <canvas id="cvEvolucao" width="450" height="280"></canvas>
  <canvas id="cvTop" width="450" height="280"></canvas>
</div>

<div class="page">
  <!-- TOPO, PERFIL, KPI, GRAFICOS, EXTRATO, ANALISE, NARRATIVA mantidos iguais -->
  ...
</div>

<script>
/* =============================================================
   INICIALIZACAO
   ============================================================= */
const KEY = "fluxopro_v12";
let db, perfil, dados, info;
let chartsPreview = {};

const PALETTE = [
  "#4f46e5","#059669","#dc2626","#d97706","#7c3aed",
  "#db2777","#0891b2","#65a30d","#ea580c","#2563eb"
];

try {
  db     = JSON.parse(localStorage.getItem(KEY));
  if (!db || !db.profiles) throw new Error("Base nao encontrada. Abra o FluxoPro primeiro.");
  perfil = db.active;
  dados  = db.profiles[perfil] || [];
  info   = db.profileInfo?.[perfil] || {};
} catch(err) {
  document.querySelector(".page").innerHTML =
    "<div class='card'><div class='card-body empty'><h2>Erro</h2><p>" + err.message + "</p></div></div>";
  throw err;
}

/* =============================================================
   VALIDACAO E FORMATACAO DE DADOS
   ============================================================= */
dados = (dados || []).filter(l => l && typeof l === "object");
dados = dados.map(l => ({
  data: l.data || "-",
  tipo: l.tipo || "Saida",
  cat: l.cat || "Outros",
  valor: Number(l.valor) || 0,
  obs: l.obs || "-"
}));

/* =============================================================
   FORMATADORES
   ============================================================= */
function fmt(v) {
  return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v || 0);
}
function pct(a, b) {
  if (typeof a !== "number" || typeof b !== "number" || b === 0) return "-";
  return (a / b * 100).toFixed(1) + "%";
}

/* =============================================================
   CALCULOS
   ============================================================= */
let totalEnt = 0, totalSai = 0;
let mapacat  = {};
let catEntradas = {};

dados.forEach(l => {
  const v = l.valor;
  if (l.tipo === "Entrada") {
    totalEnt += v;
    catEntradas[l.cat] = (catEntradas[l.cat] || 0) + v;
  } else {
    totalSai += v;
    mapacat[l.cat] = (mapacat[l.cat] || 0) + v;
  }
});

const resultado = totalEnt - totalSai;
const qtdEnt    = dados.filter(l => l.tipo === "Entrada").length;
const qtdSai    = dados.length - qtdEnt;

/* =============================================================
   PREENCHER PAGINA HTML
   ============================================================= */
const datas = dados.map(l => l.data).filter(Boolean).sort();
const periodo = datas.length ? datas[0] + " a " + datas[datas.length - 1] : "-";

document.getElementById("headerSub").innerText =
  "Perfil: " + perfil + "  |  " + dados.length + " lancamentos  |  " + periodo;

document.getElementById("piPerfil").innerText = perfil;
document.getElementById("piNome").innerText   = info.nome || "Nao informado";
document.getElementById("piDoc").innerText    = info.doc  || "Nao informado";

document.getElementById("kEnt").innerText    = fmt(totalEnt);
document.getElementById("kSai").innerText    = fmt(totalSai);
document.getElementById("kNet").innerText    = fmt(resultado);
document.getElementById("kNet").style.color  = resultado >= 0 ? "#059669" : "#dc2626";
document.getElementById("kEntQtd").innerText = qtdEnt + " lancamento" + (qtdEnt !== 1 ? "s" : "");
document.getElementById("kSaiQtd").innerText = qtdSai + " lancamento" + (qtdSai !== 1 ? "s" : "");
document.getElementById("kNetPct").innerText =
  (resultado >= 0 ? "+" : "") + pct(Math.abs(resultado), totalEnt) + " do total de entradas";

/* --- Tabela --- */
if (!dados.length) {
  document.getElementById("tabelaWrap").innerHTML = "<div class='empty'>Nenhum lancamento</div>";
} else {
  document.getElementById("tb").innerHTML = dados.map((l, i) => `
  <tr>
    <td style="color:#9ca3af;font-size:11px;font-weight:600">${i + 1}</td>
    <td style="font-weight:600;font-size:12px;color:#6b7280">${l.data}</td>
    <td style="font-weight:600">${l.cat}</td>
    <td><span class="badge ${l.tipo === "Entrada" ? "ent" : "sai"}">${l.tipo}</span></td>
    <td class="td-val" style="color:${l.tipo === "Entrada" ? "#059669" : "#dc2626"}">${fmt(l.valor)}</td>
    <td style="color:#9ca3af;font-size:12px">${l.obs}</td>
  </tr>`).join("");
}

/* --- Analise Detalhada --- */
const topEntCats = Object.entries(catEntradas).sort((a,b) => b[1]-a[1]).slice(0,5);
const topSaiCats = Object.entries(mapacat).sort((a,b) => b[1]-a[1]).slice(0,5);

const maiorGasto  = topSaiCats[0] ? topSaiCats[0][0] : "-";
const maiorEntrada = topEntCats[0] ? topEntCats[0][0] : "-";
const saude = resultado > 0 ? "positiva" : resultado < 0 ? "negativa" : "neutra";

/* =============================================================
   RESTANTE DO CÓDIGO (gráficos, export PDF, export Excel)
   ============================================================= */
// TODO: Mantidos exatamente iguais ao seu código original
// Apenas substitua as seções de cálculos e percentuais pelas melhorias acima
</script>
</body>
</html>
