<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Fonts e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter,sans-serif;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#4f46e5;color:#fff}

.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px}

.resumo{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:20px 0}
.box{background:#f0f4ff;padding:15px;border-radius:12px;font-weight:700;text-align:center;font-size:14px;border:1px solid #e5e7eb}
.box span{display:block;font-size:16px;margin-top:5px;font-weight:800}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
th{background:#fafafa;font-weight:600}

canvas{background:#fff;border-radius:12px;padding:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-bottom:15px}

.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

hr{border:none;border-top:1px solid #e5e7eb;margin:10px 0}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="container">
  <div class="top">
    <h1>Relatório FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" id="btnExcel">Baixar Excel</button>
      <button class="btn-pdf" id="btnPDF">Baixar PDF</button>
    </div>
  </div>

  <div class="card">
    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo" id="resumoSaldos">
      <div class="box" id="boxEnt">Entradas<br><span id="ent"></span></div>
      <div class="box" id="boxSai">Saídas<br><span id="sai"></span></div>
      <div class="box" id="boxLiquido">Líquido<br><span id="res"></span></div>
      <div class="box" id="boxSaude">Saúde Financeira<br><span id="saude"></span></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between">
      <canvas id="chartPizza" width="300" height="300"></canvas>
      <canvas id="chartPerc" width="300" height="300"></canvas>
      <canvas id="chartResumo" width="300" height="300"></canvas>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
const KEY="fluxopro_v12";
let db = JSON.parse(localStorage.getItem(KEY)) || {active:"default", profiles:{default:[]}, profileInfo:{}};
let perfil = db.active;
if(!db.profiles[perfil]) db.profiles[perfil] = [];
let dados = db.profiles[perfil];
let info = db.profileInfo?.[perfil] || {};

const ent = document.getElementById("ent");
const sai = document.getElementById("sai");
const res = document.getElementById("res");
const saude = document.getElementById("saude");
const tb  = document.getElementById("tb");
const perfilTitulo = document.getElementById("perfilTitulo");
const perfilDados  = document.getElementById("perfilDados");
const loading = document.getElementById("loading");

function money(v){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0); }

function calcSaude(totalEnt,totalSai){
  const liquido = totalEnt-totalSai;
  if(liquido>=0.8*totalEnt) return "Excelente";
  if(liquido>=0.5*totalEnt) return "Boa";
  if(liquido>=0) return "Regular";
  return "Crítica";
}

function renderDados(){
  let totalEnt=0,totalSai=0;
  dados.forEach(l=>{
    const v = Number(l.valor||0);
    if(l.tipo==="Entrada") totalEnt+=v;
    else if(l.tipo==="Saída") totalSai+=v;
  });
  const liquido = totalEnt-totalSai;

  perfilTitulo.innerText="Perfil: "+perfil;
  perfilDados.innerHTML=`<p><b>Nome:</b> ${info.nome||"-"}</p><p><b>Documento:</b> ${info.doc||"-"}</p>`;

  ent.innerText = money(totalEnt);
  sai.innerText = money(totalSai);
  res.innerText = money(liquido);
  saude.innerText = calcSaude(totalEnt,totalSai);

  res.style.color = liquido>=0?"#10b981":"#ef4444";

  tb.innerHTML = dados.map(l=>`
    <tr>
      <td>${l.data||"-"}</td>
      <td>${l.cat||"-"}</td>
      <td style="color:${l.tipo==="Entrada"?"#10b981":"#ef4444"}">${l.tipo}</td>
      <td>${money(Number(l.valor||0))}</td>
      <td>${l.obs||"-"}</td>
    </tr>`).join("");
}
renderDados();

// ==== Charts ====
let charts={};
function renderCharts(){
  let mapa={};
  dados.forEach(l=>{ if(l.tipo==="Saída") mapa[l.cat||"Outros"]=(mapa[l.cat]||0)+Number(l.valor||0); });
  const totalEnt = dados.filter(l=>l.tipo==="Entrada").reduce((a,l)=>a+Number(l.valor||0),0);
  const totalSai = dados.filter(l=>l.tipo==="Saída").reduce((a,l)=>a+Number(l.valor||0),0);
  const liquido = totalEnt-totalSai;

  charts.pizza = new Chart(document.getElementById("chartPizza"),{
    type:"doughnut",
    data:{labels:Object.keys(mapa),datasets:[{data:Object.values(mapa),backgroundColor:["#ef4444","#f59e0b","#4f46e5","#10b981","#6366f1"]}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.perc = new Chart(document.getElementById("chartPerc"),{
    type:"pie",
    data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai],backgroundColor:["#10b981","#ef4444"]}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.resumo = new Chart(document.getElementById("chartResumo"),{
    type:"bar",
    data:{labels:["Entradas","Saídas","Líquido"],datasets:[{data:[totalEnt,totalSai,liquido],backgroundColor:["#10b981","#ef4444","#4f46e5"]}]},
    options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
renderCharts();

// ==== Export Excel ====
document.getElementById("btnExcel").onclick = function(){
  if(!dados.length){alert("Sem dados"); return;}
  const ws = XLSX.utils.json_to_sheet(dados.map(l=>({
    Data:l.data,
    Categoria:l.cat,
    Tipo:l.tipo,
    Valor:Number(l.valor||0),
    Observacao:l.obs
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Lançamentos");
  XLSX.writeFile(wb, `fluxopro_${perfil}_${Date.now()}.xlsx`);
};

// ==== Export PDF ====
document.getElementById("btnPDF").onclick = function(){
  if(!dados.length){alert("Sem dados"); return;}
  loading.classList.add("show");
  setTimeout(()=>{
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF("p","mm","a4");
    const W=210,H=297,M=12;
    let y=20;

    // Cabeçalho colorido
    doc.setFillColor(79,70,229);
    doc.rect(0,0,W,25,"F");
    doc.setFontSize(14); doc.setTextColor(255,255,255);
    doc.setFont(undefined,"bold");
    doc.text("Relatório FluxoPro",M,18);

    // Perfil
    doc.setFontSize(10); doc.setFont(undefined,"normal"); doc.setTextColor(31,41,55);
    doc.text(`Perfil: ${perfil}`,M,y+20);
    doc.text(`Nome: ${info.nome||"-"}`,M,y+26);
    doc.text(`Documento: ${info.doc||"-"}`,M,y+32);
    y+=40;

    // Painel de saldos
    const totalEnt = dados.filter(l=>l.tipo==="Entrada").reduce((a,l)=>a+Number(l.valor||0),0);
    const totalSai = dados.filter(l=>l.tipo==="Saída").reduce((a,l)=>a+Number(l.valor||0),0);
    const liquido = totalEnt-totalSai;
    const saudeStr = calcSaude(totalEnt,totalSai);

    const boxes = [
      {text:"Entradas",val:totalEnt,color:[16,185,129]},
      {text:"Saídas",val:totalSai,color:[239,68,68]},
      {text:"Líquido",val:liquido,color:[79,70,229]},
      {text:"Saúde Financeira",val:0,color:[99,102,241],text2:saudeStr}
    ];

    let boxX = M;
    boxes.forEach(b=>{
      doc.setFillColor(...b.color);
      doc.setDrawColor(...b.color);
      doc.roundedRect(boxX,y,45,20,3,"FD");
      doc.setTextColor(255,255,255);
      doc.setFontSize(8); doc.setFont(undefined,"bold");
      doc.text(b.text,boxX+3,y+6);
      if(b.text2) doc.text(b.text2,boxX+3,y+13);
      else doc.text(money(b.val),boxX+3,y+13);
      boxX += 50;
    });
    y+=30;

    doc.setFont(undefined,"bold"); doc.setFontSize(9);
    doc.text("Lançamentos",M,y); y+=5;
    doc.setFont(undefined,"normal"); doc.setFontSize(8);

    dados.forEach(l=>{
      if(y>H-20){doc.addPage(); y=20;}
      doc.text(l.data||"-",M,y);
      doc.text((l.cat||"-").substring(0,15),M+25,y);
      doc.setFont(undefined,"bold");
      doc.setTextColor(l.tipo==="Entrada"?16,185,129:239,68,68);
      doc.text(l.tipo||"-",M+70,y);
      doc.setFont(undefined,"normal"); doc.setTextColor(31,41,55);
      doc.text(money(Number(l.valor||0)),M+95,y);
      doc.text((l.obs||"-").substring(0,25),M+120,y);
      y+=5;
    });

    doc.save(`fluxopro_${perfil}_${Date.now()}.pdf`);
    loading.classList.remove("show");
  },300);
};
});
</script>
</body>
</html>
