<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
th{background:#fafafa}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700;text-align:center}
.entrada{color:#10b981}
.saida{color:#ef4444}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="container">
  <div class="top">
    <h1>Relatorio FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
      <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
    </div>
  </div>

  <div class="card">

    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box">Entradas<br><span id="ent" class="entrada"></span></div>
      <div class="box">Saidas<br><span id="sai" class="saida"></span></div>
      <div class="box">Resultado<br><span id="res"></span></div>
    </div>

    <div id="conteudo">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observacao</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>

  </div>
</div>

<div style="position:absolute;left:-9999px;width:400px">
  <canvas id="chartPizza" width="400" height="400"></canvas>
  <canvas id="chartPerc" width="400" height="400"></canvas>
  <canvas id="chartResumo" width="400" height="300"></canvas>
</div>

<script>
/* -------- todo o seu JS anterior permanece igual -------- */
/* -------- somente exportPDF foi ajustado abaixo -------- */

function exportPDF(){

  if(!dados.length){
    alert("Nao ha dados para exportar");
    return;
  }

  loading.classList.add("show");

  setTimeout(()=>{

    try{

      const {jsPDF} = window.jspdf;
      const doc = new jsPDF("p","mm","a4");

      const W = 210;
      const H = 297;
      const M = 12;

      let y = 25;

      function novaPaginaSePreciso(alt){
        if(y + alt > H - 15){
          doc.addPage();
          y = 20;
        }
      }

      function linhaDivisoria(){
        doc.setDrawColor(220,220,220);
        doc.setLineWidth(0.2);
        doc.line(M, y, W - M, y);
        y += 6;
      }

      /* ---------- CABEÇALHO ---------- */

      doc.setFontSize(14);
      doc.setFont(undefined,"bold");
      doc.setTextColor(...colors.text);
      doc.text("Relatório financeiro – FluxoPro", M, y);

      y+=6;

      doc.setFontSize(9);
      doc.setFont(undefined,"normal");
      doc.text(`Perfil: ${perfil}`, M, y);
      y+=4;
      doc.text(`Nome: ${info.nome||"Nao informado"}`, M, y);
      y+=4;
      doc.text(`Documento: ${info.doc||"Nao informado"}`, M, y);
      y+=6;

      linhaDivisoria();

      /* ---------- TABELA ---------- */

      doc.setFont(undefined,"bold");
      doc.setFontSize(9);
      doc.text("Lançamentos", M, y);
      y+=5;

      doc.setFontSize(8);
      doc.text("Data",M,y);
      doc.text("Categoria",M+25,y);
      doc.text("Tipo",M+75,y);
      doc.text("Valor",M+95,y);
      doc.text("Obs",M+120,y);

      y+=4;
      doc.setFont(undefined,"normal");

      dados.forEach((l,i)=>{

        novaPaginaSePreciso(6);

        if(i%2===0){
          doc.setFillColor(...colors.zebra);
          doc.rect(M,y-3,W-2*M,5,"F");
        }

        doc.setTextColor(...colors.text);
        doc.text(l.data||"-",M,y);
        doc.text((l.cat||"-").substring(0,15),M+25,y);

        doc.setFont(undefined,"bold");
        doc.setTextColor(...(l.tipo==="Entrada"?colors.entrada:colors.saida));
        doc.text(l.tipo||"-",M+75,y);

        doc.setFont(undefined,"normal");
        doc.setTextColor(...colors.text);
        doc.text(money(l.valor),M+95,y);
        doc.text((l.obs||"-").substring(0,22),M+120,y);

        y+=5;

      });

      y+=2;
      linhaDivisoria();

      /* ---------- GRÁFICOS ---------- */

      novaPaginaSePreciso(70);

      doc.setFont(undefined,"bold");
      doc.setFontSize(9);
      doc.setTextColor(...colors.text);
      doc.text("Resumo visual",M,y);
      y+=5;

      const imgPizza  = chartPizza.toDataURL("image/png",1);
      const imgPerc   = chartPerc.toDataURL("image/png",1);
      const imgResumo = chartResumo.toDataURL("image/png",1);

      const gW = 50;
      const gH = 50;
      const gap = 8;

      const gx = M;
      const gy = y;

      doc.setFontSize(7);
      doc.setTextColor(120,120,120);

      doc.text("Categorias",gx,gy-2);
      doc.text("Entradas x Saídas",gx+gW+gap,gy-2);
      doc.text("Resumo geral",gx+(gW+gap)*2,gy-2);

      doc.addImage(imgPizza,"PNG",gx,gy,gW,gH,undefined,"FAST");
      doc.addImage(imgPerc,"PNG",gx+gW+gap,gy,gW,gH,undefined,"FAST");
      doc.addImage(imgResumo,"PNG",gx+(gW+gap)*2,gy,gW,gH*0.9,undefined,"FAST");

      y = gy + gH + 8;

      linhaDivisoria();

      /* =====================================================
         RESUMO INTERPRETATIVO DOS GRÁFICOS
      ===================================================== */

      const qtdEntradas = dados.filter(l=>l.tipo==="Entrada").length;
      const qtdSaidas   = dados.filter(l=>l.tipo==="Saída").length;

      novaPaginaSePreciso(35);

      doc.setFontSize(9);
      doc.setFont(undefined,"bold");
      doc.setTextColor(...colors.text);
      doc.text("Análise dos gráficos",M,y);

      y+=6;

      doc.setFontSize(8);
      doc.setFont(undefined,"normal");

      let textoQtd =
`Foram identificados ${qtdEntradas} lançamentos de entrada e ${qtdSaidas} lançamentos de saída no período analisado. 
Esses registros compõem a base utilizada para a geração dos gráficos apresentados neste relatório.`;

      let linhasQtd = doc.splitTextToSize(textoQtd,W-2*M);
      doc.text(linhasQtd,M,y);
      y+=linhasQtd.length*4+3;

      let textoCalc =
`O gráfico de categorias apresenta somente os valores de saída, agrupados por categoria, permitindo identificar onde se concentram os maiores gastos.
O gráfico de entradas e saídas compara o volume financeiro total de cada tipo.
O gráfico de resumo consolida entradas, saídas e o resultado final, calculado pela diferença entre o total de entradas e o total de saídas.`;

      let linhasCalc = doc.splitTextToSize(textoCalc,W-2*M);
      doc.text(linhasCalc,M,y);
      y+=linhasCalc.length*4+3;

      const saldo = totalEnt-totalSai;

      let textoSaude="";

      if(saldo>0){
        textoSaude =
"A saúde financeira do período é considerada positiva, pois o total de entradas superou o total de saídas, indicando geração de resultado e maior equilíbrio financeiro.";
      }else if(saldo<0){
        textoSaude =
"A saúde financeira do período é considerada em atenção, pois o total de saídas foi superior ao total de entradas, indicando consumo maior que a capacidade de geração de recursos.";
      }else{
        textoSaude =
"A saúde financeira do período é considerada neutra, pois o total de entradas e saídas apresentou o mesmo valor.";
      }

      let linhasSaude = doc.splitTextToSize(textoSaude,W-2*M);
      doc.text(linhasSaude,M,y);
      y+=linhasSaude.length*4+4;

      linhaDivisoria();

      /* ---------- RODAPÉ ---------- */

      doc.setFontSize(7);
      doc.setTextColor(140,140,140);
      doc.text(`Total de lançamentos: ${dados.length}`,M,H-8);
      doc.text(`FluxoPro Engine v12 – ${new Date().toLocaleDateString("pt-BR")}`,W-M,H-8,{align:"right"});

      doc.save(`fluxopro_${perfil}_${Date.now()}.pdf`);

      loading.classList.remove("show");

    }catch(e){
      loading.classList.remove("show");
      console.error(e);
      alert("Erro ao gerar PDF");
    }

  },300);
}
</script>

</body>
</html>
