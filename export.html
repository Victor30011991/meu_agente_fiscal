<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatﾃｳrio Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#f0f2f8;color:#1a1f36}
.page{max-width:960px;margin:0 auto;padding:24px 20px}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:16px 20px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:20px;gap:12px;flex-wrap:wrap}
.top-bar h1{font-size:17px;font-weight:800;color:#1a1f36}
.btn-group{display:flex;gap:10px}
button{display:flex;align-items:center;gap:6px;padding:10px 18px;border:0;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
.btn-excel{background:#059669;color:#fff}
.btn-pdf{background:#4f46e5;color:#fff}
.card{background:#fff;border-radius:14px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:16px;overflow:hidden}
.card-head{padding:14px 20px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f3f9}
.card-head h2{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 20px}
.kpi{border-radius:10px;padding:14px;text-align:center;border:1px solid transparent}
.kpi-label{font-size:10px;font-weight:700;text-transform:uppercase;margin-bottom:5px}
.kpi-val{font-size:19px;font-weight:800}
.kpi-ent{background:#f0fdf4;border-color:#bbf7d0;color:#059669}
.kpi-sai{background:#fef2f2;border-color:#fecaca;color:#dc2626}
.kpi-net{background:#eef2ff;border-color:#c7d2fe;color:#4f46e5}
table{width:100%;border-collapse:collapse}
th{padding:10px 12px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;background:#f8fafc;color:#6b7280;border-bottom:1px solid #e2e5ef}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid #f1f3f9}
.badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase}
.ent{background:#f0fdf4;color:#059669}
.sai{background:#fef2f2;color:#dc2626}
.chart-container{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px 20px}
.chart-box{border:1px solid #f1f3f9;border-radius:12px;padding:15px;background:#fff}
.chart-box h3{font-size:11px;margin-bottom:15px;color:#6b7280;text-align:center;text-transform:uppercase}
</style>
</head>
<body>

<div class="page">
    <div class="top-bar">
        <div>
            <h1>投 FluxoPro Intelligence</h1>
            <span id="headerSub">Processando dados...</span>
        </div>
        <div class="btn-group">
            <button class="btn-excel" onclick="exportExcel()">Excel</button>
            <button class="btn-pdf" onclick="exportPDF()">PDF</button>
        </div>
    </div>

    <div class="card">
        <div class="kpi-grid">
            <div class="kpi kpi-ent"><div class="kpi-label">Total Entradas</div><div class="kpi-val" id="vEnt">R$ 0</div></div>
            <div class="kpi kpi-sai"><div class="kpi-label">Total Saﾃｭdas</div><div class="kpi-val" id="vSai">R$ 0</div></div>
            <div class="kpi kpi-net"><div class="kpi-label">Saldo Final</div><div class="kpi-val" id="vNet">R$ 0</div></div>
        </div>
    </div>

    <div class="card">
        <div class="card-head"><span class="dot" style="background:#7c3aed"></span><h2>Anﾃ｡lise Visual Completa</h2></div>
        <div class="chart-container">
            <div class="chart-box">
                <h3>Gastos por Categoria (Dinﾃ｢mico)</h3>
                <canvas id="canvasPizza"></canvas>
            </div>
            <div class="chart-box">
                <h3>Comparativo de Volume</h3>
                <canvas id="canvasBarra"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-head"><span class="dot" style="background:#d97706"></span><h2>Extrato Ordenado (Cronolﾃｳgico)</h2></div>
        <table>
            <thead>
                <tr><th>Data</th><th>Categoria</th><th>Tipo</th><th style="text-align:right">Valor</th></tr>
            </thead>
            <tbody id="tbBody"></tbody>
        </table>
    </div>
</div>

<script>
const KEY = "fluxopro_v12";
let dadosOrdenados = [];
const CORES = ["#4f46e5","#059669","#dc2626","#d97706","#7c3aed","#db2777","#0891b2","#65a30d","#f59e0b","#10b981"];

function fmt(v) { return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0); }

// INICIALIZAﾃﾃグ E ORDENAﾃﾃグ POR DATA
try {
    const db = JSON.parse(localStorage.getItem(KEY));
    const perfil = db.active;
    const brutos = db.profiles[perfil] || [];
    
    // CORREﾃﾃグ DA DATA: Garante que 31/10/2025 apareﾃｧa na posiﾃｧﾃ｣o correta
    dadosOrdenados = brutos.sort((a, b) => new Date(a.data) - new Date(b.data));
    
    processar();
} catch(e) { console.error("Erro ao carregar dados", e); }

function processar() {
    let tEnt = 0, tSai = 0;
    const mapaCategorias = {}; // Mapeia dinamicamente qualquer categoria
    const tb = document.getElementById("tbBody");
    tb.innerHTML = "";

    dadosOrdenados.forEach(l => {
        const v = parseFloat(l.valor || 0);
        const tipo = l.tipo.toLowerCase();
        const isEnt = tipo.includes("entrada");
        
        isEnt ? tEnt += v : tSai += v;

        // GRﾃ：ICO DINﾃMICO: Se a categoria nﾃ｣o existe no mapa, ela ﾃｩ criada agora
        const nomeCat = l.cat || "Outros";
        mapaCategorias[nomeCat] = (mapaCategorias[nomeCat] || 0) + v;

        tb.innerHTML += `
            <tr>
                <td><b>${l.data}</b></td>
                <td>${l.cat}</td>
                <td><span class="badge ${isEnt?'ent':'sai'}">${l.tipo}</span></td>
                <td style="text-align:right; font-weight:bold; color:${isEnt?'#059669':'#dc2626'}">${fmt(v)}</td>
            </tr>`;
    });

    document.getElementById("vEnt").innerText = fmt(tEnt);
    document.getElementById("vSai").innerText = fmt(tSai);
    const saldo = tEnt - tSai;
    document.getElementById("vNet").innerText = fmt(saldo);
    document.getElementById("vNet").style.color = saldo >= 0 ? "#059669" : "#dc2626";
    
    document.getElementById("headerSub").innerText = `Perfil: ${KEY} | ${dadosOrdenados.length} registros ordenados.`;

    renderGraficos(tEnt, tSai, saldo, mapaCategorias);
}

function renderGraficos(ent, sai, saldo, categorias) {
    // PIZZA: Mostra TUDO o que foi encontrado nas categorias (sem travar em nomes especﾃｭficos)
    new Chart(document.getElementById('canvasPizza'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(categorias),
            datasets: [{
                data: Object.values(categorias),
                backgroundColor: CORES,
                borderWidth: 0
            }]
        },
        options: { 
            plugins: { 
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } 
            } 
        }
    });

    // BARRA: Comparativo de Volume (Exatamente o que vocﾃｪ pediu: Entradas / Saﾃｭdas / Saldo)
    new Chart(document.getElementById('canvasBarra'), {
        type: 'bar',
        data: {
            labels: ['Entradas', 'Saﾃｭdas', 'Saldo Final'],
            datasets: [{
                label: 'Volume R$',
                data: [ent, sai, saldo],
                backgroundColor: ['#059669', '#dc2626', '#4f46e5'],
                borderRadius: 4
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(dadosOrdenados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    XLSX.writeFile(wb, "FluxoPro_Relatorio.xlsx");
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("Relatﾃｳrio FluxoPro - Completo", 14, 20);
    
    let y = 30;
    dadosOrdenados.forEach(l => {
        if(y > 280) { doc.addPage(); y = 20; }
        doc.setFontSize(8);
        doc.text(`${l.data} | ${l.cat} | ${l.tipo} | ${fmt(l.valor)}`, 14, y);
        y += 6;
    });
    doc.save("Relatorio_FluxoPro.pdf");
}
</script>
</body>
</html>
