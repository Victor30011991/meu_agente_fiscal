<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700}
</style>
</head>
<body>

<div class="container">
  <div class="top">
    <h1>Relatório FluxoPro</h1>
    <div>
      <button onclick="exportExcel()">Excel</button>
      <button onclick="exportPDF()">PDF</button>
    </div>
  </div>

  <div class="card">

    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box">Entradas<br><span id="ent"></span></div>
      <div class="box">Saídas<br><span id="sai"></span></div>
      <div class="box">Resultado<br><span id="res"></span></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Categoria</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Observação</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>

  </div>
</div>

<script>
const KEY="fluxopro_v11";

const db = JSON.parse(localStorage.getItem(KEY));
const perfil = db.active;
const dados = db.profiles[perfil] || [];
const info  = db.profileInfo?.[perfil] || {};

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

let totalEnt = 0;
let totalSai = 0;

dados.forEach(l=>{
  if(l.tipo==="Entrada") totalEnt += Number(l.valor||0);
  else totalSai += Number(l.valor||0);
});

perfilTitulo.innerText = "Perfil: " + perfil;

perfilDados.innerHTML = `
<p><b>Nome:</b> ${info.nome||""}</p>
<p><b>Documento:</b> ${info.doc||""}</p>
`;

ent.innerText = money(totalEnt);
sai.innerText = money(totalSai);
res.innerText = money(totalEnt-totalSai);

tb.innerHTML = dados.map(l=>`
<tr>
<td>${l.data||""}</td>
<td>${l.cat||""}</td>
<td>${l.tipo||""}</td>
<td>${money(l.valor)}</td>
<td>${l.obs||""}</td>
</tr>
`).join("");

/* =========================================================
   EXCEL — SEM FÓRMULAS (valores já calculados)
========================================================= */
function exportExcel(){

  const rows = [];

  rows.push(["Relatório FluxoPro"]);
  rows.push([]);
  rows.push(["Perfil", perfil]);
  rows.push(["Nome", info.nome||""]);
  rows.push(["Documento", info.doc||""]);
  rows.push([]);

  rows.push(["Entradas", totalEnt]);
  rows.push(["Saídas", totalSai]);
  rows.push(["Resultado", totalEnt - totalSai]);
  rows.push([]);

  rows.push(["Data","Categoria","Tipo","Valor","Observação"]);

  dados.forEach(l=>{
    rows.push([
      l.data || "",
      l.cat || "",
      l.tipo || "",
      Number(l.valor||0),
      l.obs || ""
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);

  ws["!cols"] = [
    {wch:14},
    {wch:22},
    {wch:14},
    {wch:14},
    {wch:30}
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Relatorio");

  XLSX.writeFile(wb, `fluxopro_${perfil}.xlsx`);
}


/* =========================================================
   PDF — mantém o modelo que você já aprovou
========================================================= */
function exportPDF(){

  const {jsPDF} = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  let y = 12;

  doc.setFontSize(14);
  doc.text(`Relatório FluxoPro`,10,y);
  y+=8;

  doc.setFontSize(11);
  doc.text(`Perfil: ${perfil}`,10,y); y+=6;
  doc.text(`Nome: ${info.nome||""}`,10,y); y+=6;
  doc.text(`Documento: ${info.doc||""}`,10,y); y+=8;

  doc.text(`Entradas: ${money(totalEnt)}`,10,y); y+=6;
  doc.text(`Saídas: ${money(totalSai)}`,10,y); y+=6;
  doc.text(`Resultado: ${money(totalEnt-totalSai)}`,10,y); y+=8;

  doc.setFontSize(10);

  dados.forEach(l=>{

    if(y > 280){
      doc.addPage();
      y = 12;
    }

    doc.text(
      `${l.data||""} | ${l.cat||""} | ${l.tipo||""} | ${money(l.valor)} | ${l.obs||""}`,
      10,
      y
    );

    y += 5;
  });

  doc.save(`fluxopro_${perfil}.pdf`);
}
</script>
</body>
</html>
