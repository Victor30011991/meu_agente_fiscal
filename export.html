<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relat칩rio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Relat칩rio FluxoPro</h2>

<button onclick="exportExcel()">Baixar Excel</button>
<button onclick="exportPDF()">Baixar PDF</button>

<script>
const KEY="fluxopro_v12";

let db,perfil,dados,info;

try{
  db=JSON.parse(localStorage.getItem(KEY));
  if(!db||!db.profiles) throw "erro";
  perfil=db.active;
  dados=db.profiles[perfil]||[];
  info=db.profileInfo?.[perfil]||{};
}catch{
  alert("Erro ao carregar base");
  throw new Error("DB inv치lido");
}

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

function exportPDF(){

  if(!dados.length){
    alert("Sem dados");
    return;
  }

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();

  let y=10;

  doc.text("Relat칩rio FluxoPro",10,y);y+=6;
  doc.text("Perfil: "+perfil,10,y);y+=6;

  dados.forEach(l=>{
    doc.text(
      `${l.data} | ${l.cat} | ${l.tipo} | ${money(l.valor)}`,
      10,y
    );
    y+=6;
    if(y>280){doc.addPage();y=10;}
  });

  doc.save("fluxopro_"+perfil+".pdf");
}

function exportExcel(){

  if(!dados.length){
    alert("Sem dados");
    return;
  }

  const planilha=dados.map(l=>({
    Data:l.data,
    Categoria:l.cat,
    Tipo:l.tipo,
    Valor:l.valor,
    Observacao:l.obs
  }));

  const ws=XLSX.utils.json_to_sheet(planilha);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Lancamentos");
  XLSX.writeFile(wb,"fluxopro_"+perfil+".xlsx");
}
</script>

</body>
</html>
