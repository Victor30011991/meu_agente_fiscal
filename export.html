<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatﾃｳrio Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#f0f2f8;color:#1a1f36}
.page{max-width:960px;margin:0 auto;padding:24px 20px}

/* HEADER E BOTﾃ髭S */
.top-bar{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:16px 20px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:20px;gap:12px;flex-wrap:wrap}
.top-bar h1{font-size:17px;font-weight:800;color:#1a1f36}
.top-bar span{font-size:12px;color:#6b7280}
.btn-group{display:flex;gap:10px}
button{display:flex;align-items:center;gap:6px;padding:10px 18px;border:0;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s;font-family:Inter,sans-serif}
button:hover{opacity:.85;transform:translateY(-1px)}
.btn-excel{background:#059669;color:#fff}
.btn-pdf{background:#4f46e5;color:#fff}

/* CARDS */
.card{background:#fff;border-radius:14px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:16px;overflow:hidden}
.card-head{padding:14px 20px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f3f9}
.card-head h2{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}

/* PAINEL DE SALDOS */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 20px}
.kpi{border-radius:10px;padding:14px;text-align:center;border:1px solid transparent}
.kpi-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.kpi-val{font-size:19px;font-weight:800;letter-spacing:-1px}
.kpi-ent{background:#f0fdf4;border-color:#bbf7d0;color:#059669}
.kpi-sai{background:#fef2f2;border-color:#fecaca;color:#dc2626}
.kpi-net{background:#eef2ff;border-color:#c7d2fe;color:#4f46e5}

/* GRﾃ：ICOS */
.chart-container{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px 20px}
.chart-box{border:1px solid #f1f3f9;border-radius:12px;padding:15px;background:#fff;text-align:center}
.chart-box h3{font-size:11px;margin-bottom:15px;color:#6b7280;text-transform:uppercase}

/* TABELA */
table{width:100%;border-collapse:collapse}
th{padding:10px 12px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;background:#f8fafc;color:#6b7280;border-bottom:1px solid #e2e5ef}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid #f1f3f9}
.badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase}
.ent{background:#f0fdf4;color:#059669}
.sai{background:#fef2f2;color:#dc2626}

.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;color:#fff;font-weight:bold}
.loading.show{display:flex}
</style>
</head>
<body>

<div class="loading" id="loading">Gerando Documentos...</div>

<div class="page">
    <div class="top-bar">
        <div>
            <h1>投 Relatﾃｳrio Dinﾃ｢mico FluxoPro</h1>
            <span id="headerSub">Organizando dados cronologicamente...</span>
        </div>
        <div class="btn-group">
            <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
            <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
        </div>
    </div>

    <div class="card">
        <div class="kpi-grid">
            <div class="kpi kpi-ent">
                <div class="kpi-label">Total Entradas</div>
                <div id="vEnt" class="kpi-val">R$ 0,00</div>
            </div>
            <div class="kpi kpi-sai">
                <div class="kpi-label">Total Saﾃｭdas</div>
                <div id="vSai" class="kpi-val">R$ 0,00</div>
            </div>
            <div class="kpi kpi-net">
                <div class="kpi-label">Saldo Final</div>
                <div id="vNet" class="kpi-val">R$ 0,00</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-head"><span class="dot" style="background:#7c3aed"></span><h2>Anﾃ｡lise Automﾃ｡tica de Categorias</h2></div>
        <div class="chart-container">
            <div class="chart-box">
                <h3>Distribuiﾃｧﾃ｣o por Categoria</h3>
                <canvas id="canvasPizza"></canvas>
            </div>
            <div class="chart-box">
                <h3>Volume por Tipo (Entrada vs Saﾃｭda)</h3>
                <canvas id="canvasBarra"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-head"><span class="dot" style="background:#d97706"></span><h2>Extrato Completo (Ordenado por Data)</h2></div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Tipo</th>
                    <th style="text-align:right">Valor</th>
                </tr>
            </thead>
            <tbody id="tbBody"></tbody>
        </table>
    </div>
</div>

<script>
const KEY = "fluxopro_v12";
let dadosOrdenados = [];
const CORES = ["#4f46e5","#059669","#dc2626","#d97706","#7c3aed","#db2777","#0891b2","#65a30d","#f59e0b","#10b981"];

function fmt(v) { return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0); }

// INICIALIZAﾃﾃグ E ORDENAﾃﾃグ
try {
    const db = JSON.parse(localStorage.getItem(KEY));
    const perfil = db.active;
    const brutos = db.profiles[perfil] || [];
    
    // CORREﾃﾃグ DE DATA: Transforma strings em datas reais para ordenar corretamente
    dadosOrdenados = brutos.sort((a, b) => new Date(a.data) - new Date(b.data));
    
    processarDados();
} catch(e) { 
    console.error("Erro ao carregar base:", e);
    alert("Dados nﾃ｣o encontrados. Verifique se o FluxoPro possui lanﾃｧamentos.");
}

function processarDados() {
    let somaEnt = 0, somaSai = 0;
    const categoriasMapa = {}; // Para o grﾃ｡fico de pizza dinﾃ｢mico
    const tb = document.getElementById("tbBody");
    tb.innerHTML = "";

    dadosOrdenados.forEach(item => {
        const val = parseFloat(item.valor || 0);
        const tipo = (item.tipo || "").toLowerCase();
        const isEntrada = tipo.includes("entrada");
        
        if(isEntrada) somaEnt += val; else somaSai += val;

        // MAPEAR CATEGORIAS PARA O GRﾃ：ICO (Soma automﾃ｡tica de qualquer nome que existir)
        const catNome = item.cat || "Geral";
        categoriasMapa[catNome] = (categoriasMapa[catNome] || 0) + val;

        // INSERIR NA TABELA
        tb.innerHTML += `
            <tr>
                <td><b>${item.data}</b></td>
                <td>${item.cat}</td>
                <td><span class="badge ${isEntrada?'ent':'sai'}">${item.tipo}</span></td>
                <td style="text-align:right; font-weight:bold; color:${isEntrada?'#059669':'#dc2626'}">${fmt(val)}</td>
            </tr>`;
    });

    // ATUALIZAR PAINEL
    document.getElementById("vEnt").innerText = fmt(somaEnt);
    document.getElementById("vSai").innerText = fmt(somaSai);
    const liquido = somaEnt - somaSai;
    document.getElementById("vNet").innerText = fmt(liquido);
    document.getElementById("vNet").style.color = liquido >= 0 ? "#059669" : "#dc2626";
    document.getElementById("headerSub").innerText = `Exibindo ${dadosOrdenados.length} lanﾃｧamentos em ordem cronolﾃｳgica.`;

    renderizarGraficos(somaEnt, somaSai, categoriasMapa);
}

function renderizarGraficos(ent, sai, mapa) {
    // 1. Grﾃ｡fico de Categorias (Lﾃｪ qualquer categoria criada)
    new Chart(document.getElementById('canvasPizza'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(mapa),
            datasets: [{
                data: Object.values(mapa),
                backgroundColor: CORES,
                borderWidth: 0
            }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
    });

    // 2. Grﾃ｡fico de Tipos (Soma total de Entradas vs Saﾃｭdas)
    new Chart(document.getElementById('canvasBarra'), {
        type: 'bar',
        data: {
            labels: ['Entradas', 'Saﾃｭdas'],
            datasets: [{
                label: 'Volume (R$)',
                data: [ent, sai],
                backgroundColor: ['#059669', '#dc2626'],
                borderRadius: 5
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });
}

// FUNﾃﾃ髭S DE EXPORTAﾃﾃグ
function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(dadosOrdenados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Lancamentos_Ordenados");
    XLSX.writeFile(wb, "Relatorio_FluxoPro.xlsx");
}

function exportPDF() {
    const loading = document.getElementById("loading");
    loading.classList.add("show");
    
    setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text("EXTRATO FINANCEIRO FLUXOPRO", 14, 20);
        doc.setFontSize(10);
        doc.text("Dados organizados por data cronolﾃｳgica", 14, 28);
        
        let y = 40;
        doc.setFont(undefined, 'bold');
        doc.text("DATA", 14, y);
        doc.text("CATEGORIA", 45, y);
        doc.text("TIPO", 95, y);
        doc.text("VALOR", 145, y);
        doc.line(14, y+2, 190, y+2);
        y += 10;

        doc.setFont(undefined, 'normal');
        dadosOrdenados.forEach(l => {
            if (y > 280) { doc.addPage(); y = 20; }
            doc.text(l.data, 14, y);
            doc.text(String(l.cat).substring(0, 20), 45, y);
            doc.text(l.tipo, 95, y);
            doc.text(fmt(l.valor), 145, y);
            y += 7;
        });

        doc.save("Relatorio_FluxoPro_Final.pdf");
        loading.classList.remove("show");
    }, 500);
}
</script>
</body>
</html>
