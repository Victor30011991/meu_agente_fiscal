<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* CSS original mantido */
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
th{background:#fafafa}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700;text-align:center}
.entrada{color:#10b981}
.saida{color:#ef4444}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<!-- HTML estrutural mantido -->

<script>
const KEY="fluxopro_v12";

let db, perfil, dados, info, theme;

try{
  db = JSON.parse(localStorage.getItem(KEY));
  if(!db || !db.profiles) throw new Error("Base não encontrada");

  perfil = db.active;
  theme  = db.theme || "";

  dados = db.profiles[perfil] || [];
  info  = db.profileInfo?.[perfil] || {};

}catch(err){
  document.querySelector('.container').innerHTML = `
  <div class="card empty">
    <h2>Erro</h2>
    <p>${err.message}</p>
  </div>`;
  throw err;
}

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

let totalEnt=0,totalSai=0;

dados.forEach(l=>{
  const v=Number(l.valor||0);
  if(l.tipo==="Entrada") totalEnt+=v;
  if(l.tipo==="Saída") totalSai+=v;
});

const resultado=totalEnt-totalSai;

/* --------- correção importante: destruir gráficos antes de recriar --------- */

let charts={};

function createCharts(){

  Object.values(charts).forEach(c=>{
    try{ c.destroy(); }catch{}
  });

  charts={};

  let mapa={};
  dados.forEach(l=>{
    if(l.tipo==="Saída"){
      mapa[l.cat||"Outros"]=(mapa[l.cat||"Outros"]||0)+Number(l.valor||0);
    }
  });

  charts.pizza=new Chart(chartPizza,{
    type:"doughnut",
    data:{labels:Object.keys(mapa),datasets:[{data:Object.values(mapa)}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.perc=new Chart(chartPerc,{
    type:"pie",
    data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai]}]},
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.resumo=new Chart(chartResumo,{
    type:"bar",
    data:{labels:["Entradas","Saídas","Resultado"],datasets:[{data:[totalEnt,totalSai,resultado]}]},
    options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

createCharts();

/* resto do arquivo e da função exportPDF permanece igual ao seu */

</script>
</body>
</html>
