<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700;text-align:center}
.entrada{color:#10b981}
.saida{color:#ef4444}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="container">
  <div class="top">
    <h1>Relatorio FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
      <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
    </div>
  </div>

  <div class="card">

    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box">Entradas<br><span id="ent" class="entrada"></span></div>
      <div class="box">Saidas<br><span id="sai" class="saida"></span></div>
      <div class="box">Resultado<br><span id="res"></span></div>
    </div>

    <div id="conteudo">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observacao</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- GRAFICOS OCULTOS PARA CAPTURA -->
<div style="position:absolute;left:-9999px;width:400px">
  <canvas id="chartPizza" width="400" height="400"></canvas>
  <canvas id="chartPerc" width="400" height="400"></canvas>
  <canvas id="chartResumo" width="400" height="300"></canvas>
</div>

<script>
const KEY="fluxopro_v12";

let db, perfil, dados, info, theme;

try {
  db = JSON.parse(localStorage.getItem(KEY));
  
  if(!db || !db.profiles){
    throw new Error("Base de dados nao encontrada");
  }
  
  perfil = db.active;
  theme = db.theme || "";
  
  if(!perfil || !db.profiles[perfil]){
    throw new Error("Perfil ativo nao encontrado");
  }
  
  dados = db.profiles[perfil] || [];
  info = db.profileInfo?.[perfil] || {};
  
} catch(err) {
  document.querySelector('.container').innerHTML = `
    <div class="card empty">
      <h2>Erro ao carregar dados</h2>
      <p>${err.message}</p>
      <p>Verifique se o sistema FluxoPro esta configurado corretamente.</p>
      <button onclick="window.close()">Fechar</button>
    </div>
  `;
  throw err;
}

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

let totalEnt = 0;
let totalSai = 0;

dados.forEach(l=>{
  const val = Number(l.valor||0);
  if(l.tipo==="Entrada") {
    totalEnt += val;
  } else if(l.tipo==="Saída") {
    totalSai += val;
  }
});

perfilTitulo.innerText = "Perfil: " + perfil;

perfilDados.innerHTML = `
<p><b>Nome:</b> ${info.nome||"Nao informado"}</p>
<p><b>Documento:</b> ${info.doc||"Nao informado"}</p>
`;

ent.innerText = money(totalEnt);
sai.innerText = money(totalSai);

const resultado = totalEnt - totalSai;
res.innerText = money(resultado);
res.style.color = resultado >= 0 ? "#10b981" : "#ef4444";

if(!dados.length){
  document.getElementById("conteudo").innerHTML = `
    <div class="empty">
      <p>Nenhum lancamento encontrado neste perfil</p>
      <p>Adicione lancamentos no sistema para gerar relatorios.</p>
    </div>
  `;
} else {
  tb.innerHTML = dados.map(l=>`
  <tr>
    <td>${l.data||"-"}</td>
    <td>${l.cat||"-"}</td>
    <td style="color:${l.tipo==="Entrada"?"#10b981":"#ef4444"}">${l.tipo||"-"}</td>
    <td><b>${money(l.valor)}</b></td>
    <td>${l.obs||"-"}</td>
  </tr>
  `).join("");
}

let charts = {};

function createCharts(){
  
  if(!dados.length) return;
  
  let mapa = {};
  dados.forEach(l => {
    if(l.tipo === "Saída") {
      mapa[l.cat || "Outros"] = (mapa[l.cat || "Outros"] || 0) + l.valor;
    }
  });
  
  charts.pizza = new Chart(chartPizza, {
    type: "doughnut",
    data: {
      labels: Object.keys(mapa),
      datasets: [{
        data: Object.values(mapa),
        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899']
      }]
    },
    options: {
      responsive: false,
      plugins: {
        legend: {position: 'bottom', labels: {font: {size: 11}}}
      }
    }
  });
  
  charts.perc = new Chart(chartPerc, {
    type: "pie",
    data: {
      labels: ["Entradas", "Saidas"],
      datasets: [{
        data: [totalEnt, totalSai],
        backgroundColor: ['#10b981', '#ef4444']
      }]
    },
    options: {
      responsive: false,
      plugins: {
        legend: {position: 'bottom', labels: {font: {size: 11}}}
      }
    }
  });
  
  charts.resumo = new Chart(chartResumo, {
    type: "bar",
    data: {
      labels: ["Entradas", "Saidas", "Resultado"],
      datasets: [{
        data: [totalEnt, totalSai, totalEnt - totalSai],
        backgroundColor: ['#10b981', '#ef4444', totalEnt >= totalSai ? '#10b981' : '#ef4444']
      }]
    },
    options: {
      responsive: false,
      plugins: {legend: {display: false}},
      scales: {y: {beginAtZero: true}}
    }
  });
}

createCharts();

const themePalettes = {
  "": {
    primary: [79, 70, 229],
    bg: [255, 255, 255],
    text: [31, 41, 55],
    textLight: [255, 255, 255],
    card: [255, 255, 255],
    entrada: [16, 185, 129],
    saida: [239, 68, 68],
    zebra: [249, 250, 251],
    accent: [238, 242, 255]
  },
  "dark": {
    primary: [30, 41, 59],
    bg: [15, 23, 42],
    text: [241, 245, 249],
    textLight: [241, 245, 249],
    card: [30, 41, 59],
    entrada: [16, 185, 129],
    saida: [239, 68, 68],
    zebra: [15, 23, 42],
    accent: [51, 65, 85]
  },
  "emerald": {
    primary: [16, 185, 129],
    bg: [236, 253, 245],
    text: [6, 95, 70],
    textLight: [255, 255, 255],
    card: [255, 255, 255],
    entrada: [5, 150, 105],
    saida: [239, 68, 68],
    zebra: [209, 250, 229],
    accent: [167, 243, 208]
  },
  "gold": {
    primary: [245, 158, 11],
    bg: [255, 247, 237],
    text: [120, 53, 15],
    textLight: [255, 255, 255],
    card: [255, 255, 255],
    entrada: [16, 185, 129],
    saida: [239, 68, 68],
    zebra: [254, 243, 199],
    accent: [253, 230, 138]
  },
  "indigo": {
    primary: [99, 102, 241],
    bg: [238, 242, 255],
    text: [55, 48, 163],
    textLight: [255, 255, 255],
    card: [255, 255, 255],
    entrada: [16, 185, 129],
    saida: [239, 68, 68],
    zebra: [224, 231, 255],
    accent: [199, 210, 254]
  },
  "rose": {
    primary: [251, 113, 133],
    bg: [255, 241, 242],
    text: [136, 19, 55],
    textLight: [255, 255, 255],
    card: [255, 255, 255],
    entrada: [16, 185, 129],
    saida: [239, 68, 68],
    zebra: [255, 228, 230],
    accent: [254, 205, 211]
  }
};

const colors = themePalettes[theme] || themePalettes[""];

function exportExcel(){
  
  if(!dados.length){
    alert("Nao ha dados para exportar");
    return;
  }
  
  loading.classList.add("show");
  
  setTimeout(()=>{
    try{
      const rows = [];

      rows.push(["Relatorio FluxoPro"]);
      rows.push([]);
      rows.push(["Perfil", perfil]);
      rows.push(["Nome", info.nome||""]);
      rows.push(["Documento", info.doc||""]);
      rows.push([]);

      rows.push(["Entradas", totalEnt]);
      rows.push(["Saidas", totalSai]);
      rows.push(["Resultado", totalEnt - totalSai]);
      rows.push([]);

      rows.push(["Data","Categoria","Tipo","Valor","Observacao"]);

      dados.forEach(l=>{
        rows.push([
          l.data || "",
          l.cat || "",
          l.tipo || "",
          Number(l.valor||0),
          l.obs || ""
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);

      ws["!cols"] = [
        {wch:14},
        {wch:22},
        {wch:14},
        {wch:14},
        {wch:30}
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Relatorio");

      XLSX.writeFile(wb, `fluxopro_${perfil}_${Date.now()}.xlsx`);
      
      loading.classList.remove("show");
      alert("Excel gerado com sucesso!");
      
    }catch(err){
      loading.classList.remove("show");
      alert("Erro ao gerar Excel: " + err.message);
    }
  }, 100);
}

function exportPDF(){
  
  if(!dados.length){
    alert("Nao ha dados para exportar");
    return;
  }
  
  loading.classList.add("show");
  
  setTimeout(()=>{
    try{
      const {jsPDF} = window.jspdf;
      const doc = new jsPDF("p","mm","a4");
      
      const W = 210;
      const H = 297;
      const M = 15;
      
      // ===========================================
      // SLIDE 1: CAPA PROFISSIONAL
      // ===========================================
      
      doc.setFillColor(...colors.primary);
      doc.rect(0, 0, W, 60, 'F');
      
      doc.setTextColor(...colors.textLight);
      doc.setFontSize(32);
      doc.setFont(undefined, 'bold');
      doc.text("RELATORIO FINANCEIRO", W/2, 30, {align: 'center'});
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'normal');
      doc.text("FluxoPro Engine", W/2, 42, {align: 'center'});
      
      if(theme){
        doc.setFontSize(9);
        const tNames = {dark:"Dark Mode",emerald:"Emerald",gold:"Gold",indigo:"Indigo",rose:"Rose"};
        doc.text("Tema: " + (tNames[theme] || theme), W/2, 52, {align: 'center'});
      }
      
      doc.setFillColor(...colors.card);
      doc.roundedRect(M, 75, W-2*M, 70, 3, 3, 'F');
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text("DADOS DO PERFIL", M+5, 88);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text("Perfil:", M+5, 100);
      doc.setFont(undefined, 'bold');
      doc.text(perfil, M+25, 100);
      
      doc.setFont(undefined, 'normal');
      doc.text("Nome:", M+5, 108);
      doc.text(info.nome || "Nao informado", M+25, 108);
      
      doc.text("Documento:", M+5, 116);
      doc.text(info.doc || "Nao informado", M+25, 116);
      
      doc.setDrawColor(200, 200, 200);
      doc.line(M+5, 122, W-M-5, 122);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text("Gerado em: " + new Date().toLocaleString('pt-BR'), M+5, 136);
      
      doc.setFillColor(...colors.accent);
      doc.roundedRect(M, 155, W-2*M, 50, 3, 3, 'F');
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("RESUMO FINANCEIRO", M+5, 168);
      
      const boxW = (W - 2*M - 20) / 3;
      const boxY = 175;
      
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(M+5, boxY, boxW, 22, 2, 2, 'F');
      doc.roundedRect(M+10+boxW, boxY, boxW, 22, 2, 2, 'F');
      doc.roundedRect(M+15+2*boxW, boxY, boxW, 22, 2, 2, 'F');
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text("ENTRADAS", M+5+boxW/2, boxY+6, {align: 'center'});
      
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(...colors.entrada);
      doc.text(money(totalEnt), M+5+boxW/2, boxY+16, {align: 'center'});
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text("SAIDAS", M+10+boxW+boxW/2, boxY+6, {align: 'center'});
      
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(...colors.saida);
      doc.text(money(totalSai), M+10+boxW+boxW/2, boxY+16, {align: 'center'});
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text("RESULTADO", M+15+2*boxW+boxW/2, boxY+6, {align: 'center'});
      
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      const resC = (totalEnt - totalSai) >= 0 ? colors.entrada : colors.saida;
      doc.setTextColor(...resC);
      doc.text(money(totalEnt - totalSai), M+15+2*boxW+boxW/2, boxY+16, {align: 'center'});
      
      const percEnt = totalEnt + totalSai > 0 ? (totalEnt / (totalEnt + totalSai) * 100).toFixed(1) : 0;
      const percSai = totalEnt + totalSai > 0 ? (totalSai / (totalEnt + totalSai) * 100).toFixed(1) : 0;
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(...colors.text);
      doc.text(`Entradas representam ${percEnt}% do total`, M+5, 218);
      doc.text(`Saidas representam ${percSai}% do total`, M+5, 225);
      
      if(totalEnt >= totalSai){
        doc.setTextColor(...colors.entrada);
        doc.text("Situacao: Saude financeira positiva", M+5, 232);
      } else {
        doc.setTextColor(...colors.saida);
        doc.text("Situacao: Atencao, gastos maiores que entradas", M+5, 232);
      }
      
      // ===========================================
      // SLIDE 2: GRAFICOS
      // ===========================================
      doc.addPage();
      
      doc.setFillColor(...colors.primary);
      doc.rect(0, 0, W, 35, 'F');
      
      doc.setTextColor(...colors.textLight);
      doc.setFontSize(22);
      doc.setFont(undefined, 'bold');
      doc.text("DASHBOARD VISUAL", W/2, 22, {align: 'center'});
      
      const imgPizza = chartPizza.toDataURL('image/png', 1.0);
      const imgPerc = chartPerc.toDataURL('image/png', 1.0);
      const imgResumo = chartResumo.toDataURL('image/png', 1.0);
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      
      doc.text("Distribuicao por Categoria", M, 52);
      doc.addImage(imgPizza, 'PNG', M, 56, 85, 85);
      
      doc.text("Proporcao Entradas x Saidas", W/2 + 5, 52);
      doc.addImage(imgPerc, 'PNG', W/2 + 5, 56, 85, 85);
      
      doc.text("Resumo Comparativo", M, 152);
      doc.addImage(imgResumo, 'PNG', M, 156, W - 2*M, 90);
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text("Graficos gerados automaticamente pelo sistema FluxoPro Engine", W/2, 260, {align: 'center'});
      
      // ===========================================
      // SLIDE 3: TABELA DE LANCAMENTOS
      // ===========================================
      doc.addPage();
      
      doc.setFillColor(...colors.primary);
      doc.rect(0, 0, W, 35, 'F');
      
      doc.setTextColor(...colors.textLight);
      doc.setFontSize(22);
      doc.setFont(undefined, 'bold');
      doc.text("LANCAMENTOS DETALHADOS", W/2, 22, {align: 'center'});
      
      let y = 48;
      
      doc.setFillColor(...colors.accent);
      doc.rect(M, y-5, W-2*M, 8, 'F');
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(9);
      doc.setFont(undefined, 'bold');
      doc.text("DATA", M+2, y);
      doc.text("CATEGORIA", M+32, y);
      doc.text("TIPO", M+85, y);
      doc.text("VALOR", M+115, y);
      doc.text("OBSERVACAO", M+150, y);
      
      y += 8;
      doc.setFont(undefined, 'normal');
      
      dados.forEach((l, idx) => {
        
        if(y > 270){
          doc.addPage();
          
          doc.setFillColor(...colors.primary);
          doc.rect(0, 0, W, 20, 'F');
          doc.setTextColor(...colors.textLight);
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text("LANCAMENTOS (continuacao)", W/2, 13, {align: 'center'});
          
          y = 30;
          doc.setTextColor(...colors.text);
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
        }
        
        if(idx % 2 === 0){
          doc.setFillColor(...colors.zebra);
          doc.rect(M, y-5, W-2*M, 6, 'F');
        }
        
        doc.setTextColor(...colors.text);
        doc.text(l.data || "-", M+2, y);
        doc.text((l.cat || "-").substring(0, 18), M+32, y);
        
        if(l.tipo === "Entrada"){
          doc.setTextColor(...colors.entrada);
        } else {
          doc.setTextColor(...colors.saida);
        }
        doc.setFont(undefined, 'bold');
        doc.text(l.tipo || "-", M+85, y);
        
        doc.setTextColor(...colors.text);
        doc.text(money(l.valor), M+115, y);
        
        doc.setFont(undefined, 'normal');
        doc.text((l.obs || "-").substring(0, 22), M+150, y);
        
        y += 6;
      });
      
      doc.setFontSize(8);
      doc.setTextColor(120, 120, 120);
      doc.text(`Total de lancamentos: ${dados.length}`, M, H - 10);
      doc.text(`Documento gerado em ${new Date().toLocaleDateString('pt-BR')}`, W - M, H - 10, {align: 'right'});
      
      // ===========================================
      // SLIDE 4: INSIGHTS E ANALISES
      // ===========================================
      doc.addPage();
      
      doc.setFillColor(...colors.primary);
      doc.rect(0, 0, W, 35, 'F');
      
      doc.setTextColor(...colors.textLight);
      doc.setFontSize(22);
      doc.setFont(undefined, 'bold');
      doc.text("ANALISES E INSIGHTS", W/2, 22, {align: 'center'});
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("Resumo Executivo", M, 50);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      let texto = `Este relatorio apresenta a situacao financeira do perfil "${perfil}" `;
      texto += `com base em ${dados.length} lancamento(s) registrado(s). `;
      
      if(totalEnt >= totalSai){
        texto += `O periodo analisado apresenta saude financeira positiva, `;
        texto += `com superavit de ${money(totalEnt - totalSai)}. `;
      } else {
        texto += `O periodo analisado apresenta deficit de ${money(totalSai - totalEnt)}, `;
        texto += `indicando que as saidas superam as entradas. `;
      }
      
      const linhas = doc.splitTextToSize(texto, W - 2*M);
      doc.text(linhas, M, 58);
      
      let yAnalise = 58 + linhas.length * 5 + 10;
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text("Principais Categorias de Gastos", M, yAnalise);
      
      yAnalise += 8;
      
      let mapaGastos = {};
      dados.forEach(l => {
        if(l.tipo === "Saída") {
          mapaGastos[l.cat || "Outros"] = (mapaGastos[l.cat || "Outros"] || 0) + l.valor;
        }
      });
      
      const topCats = Object.entries(mapaGastos).sort((a,b) => b[1] - a[1]).slice(0, 5);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      if(topCats.length > 0){
        topCats.forEach(([cat, val], idx) => {
          const perc = (val / totalSai * 100).toFixed(1);
          doc.setTextColor(...colors.text);
          doc.text(`${idx+1}. ${cat}:`, M+5, yAnalise);
          doc.setTextColor(...colors.saida);
          doc.setFont(undefined, 'bold');
          doc.text(`${money(val)} (${perc}%)`, M+70, yAnalise);
          doc.setFont(undefined, 'normal');
          yAnalise += 6;
        });
      } else {
        doc.text("Nenhuma saida registrada no periodo", M+5, yAnalise);
        yAnalise += 6;
      }
      
      yAnalise += 10;
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text("Recomendacoes", M, yAnalise);
      
      yAnalise += 8;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      if(totalEnt >= totalSai){
        doc.text("- Manter o controle de gastos atual", M+5, yAnalise);
        yAnalise += 6;
        doc.text("- Considerar investir o superavit", M+5, yAnalise);
        yAnalise += 6;
        doc.text("- Criar uma reserva de emergencia se ainda nao possui", M+5, yAnalise);
      } else {
        doc.text("- Revisar as principais categorias de gastos", M+5, yAnalise);
        yAnalise += 6;
        doc.text("- Buscar reduzir despesas nao essenciais", M+5, yAnalise);
        yAnalise += 6;
        doc.text("- Explorar oportunidades de aumentar as receitas", M+5, yAnalise);
      }
      
      yAnalise += 15;
      
      doc.setFillColor(...colors.accent);
      doc.roundedRect(M, yAnalise, W-2*M, 40, 3, 3, 'F');
      
      doc.setTextColor(...colors.text);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text("Sobre este Relatorio", M+5, yAnalise+10);
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.text("Este documento foi gerado automaticamente pelo FluxoPro Engine,", M+5, yAnalise+18);
      doc.text("um sistema completo de controle financeiro desenvolvido em tecnologia web.", M+5, yAnalise+24);
      doc.text("Para mais informacoes ou suporte, visite a area de configuracoes do sistema.", M+5, yAnalise+30);
      
      doc.setFontSize(7);
      doc.setTextColor(120, 120, 120);
      doc.text("FluxoPro Engine v12 - Relatorio confidencial", W/2, H - 8, {align: 'center'});
      
      doc.save(`fluxopro_${perfil}_${Date.now()}.pdf`);
      
      loading.classList.remove("show");
      alert(`PDF profissional gerado com tema ${theme || "padrao"}!`);
      
    }catch(err){
      loading.classList.remove("show");
      alert("Erro ao gerar PDF: " + err.message);
      console.error(err);
    }
  }, 600);
}
</script>
</body>
</html>
