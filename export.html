<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1000px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left;font-size:13px}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-excel{background:#10b981;color:#fff}
.btn-pdf{background:#ef4444;color:#fff}
.resumo{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
.box{background:#f3f4f6;padding:10px;border-radius:10px;font-weight:700;text-align:center}
.entrada{color:#10b981}
.saida{color:#ef4444}
.loading{display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:9999}
.loading.show{display:flex}
.spinner{border:4px solid #f3f4f6;border-top:4px solid #4f46e5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<div class="container">
  <div class="top">
    <h1>Relatório FluxoPro</h1>
    <div style="display:flex;gap:10px">
      <button class="btn-excel" onclick="exportExcel()">Baixar Excel</button>
      <button class="btn-pdf" onclick="exportPDF()">Baixar PDF</button>
    </div>
  </div>

  <div class="card">

    <h2 id="perfilTitulo"></h2>
    <div id="perfilDados"></div>

    <div class="resumo">
      <div class="box">Entradas<br><span id="ent" class="entrada"></span></div>
      <div class="box">Saídas<br><span id="sai" class="saida"></span></div>
      <div class="box">Resultado<br><span id="res"></span></div>
    </div>

    <div id="conteudo">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- GRÁFICOS OCULTOS PARA EXPORTAÇÃO -->
<div style="position:absolute;left:-9999px;width:400px">
  <canvas id="chartPizza" width="400" height="300"></canvas>
  <canvas id="chartPerc" width="400" height="400"></canvas>
  <canvas id="chartResumo" width="400" height="300"></canvas>
</div>

<script>
const KEY="fluxopro_v12";

let db, perfil, dados, info;

try {

  db = JSON.parse(localStorage.getItem(KEY));

  if(!db || !db.profiles){
    throw new Error("Base de dados não encontrada");
  }

  perfil = db.active;

  if(!perfil || !db.profiles[perfil]){
    throw new Error("Perfil ativo não encontrado");
  }

  dados = db.profiles[perfil] || [];
  info = db.profileInfo?.[perfil] || {};

} catch(err){

  document.querySelector('.container').innerHTML = `
    <div class="card empty">
      <h2>Erro ao carregar dados</h2>
      <p>${err.message}</p>
      <button onclick="window.close()">Fechar</button>
    </div>
  `;
  throw err;
}

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

let totalEnt = 0;
let totalSai = 0;

dados.forEach(l=>{
  const val = Number(l.valor||0);
  if(l.tipo==="Entrada") totalEnt += val;
  if(l.tipo==="Saída") totalSai += val;
});

perfilTitulo.innerText = "Perfil: " + perfil;

perfilDados.innerHTML = `
<p><b>Nome:</b> ${info.nome||"Não informado"}</p>
<p><b>Documento:</b> ${info.doc||"Não informado"}</p>
`;

ent.innerText = money(totalEnt);
sai.innerText = money(totalSai);

const resultado = totalEnt - totalSai;
res.innerText = money(resultado);
res.style.color = resultado >= 0 ? "#10b981" : "#ef4444";

if(!dados.length){

  document.getElementById("conteudo").innerHTML = `
    <div class="empty">
      <p>Nenhum lançamento encontrado neste perfil</p>
    </div>
  `;

}else{

  tb.innerHTML = dados.map(l=>`
    <tr>
      <td>${l.data||"-"}</td>
      <td>${l.cat||"-"}</td>
      <td style="color:${l.tipo==="Entrada"?"#10b981":"#ef4444"}">${l.tipo||"-"}</td>
      <td><b>${money(l.valor)}</b></td>
      <td>${l.obs||"-"}</td>
    </tr>
  `).join("");

}

let charts = {};

function createCharts(){

  if(!dados.length) return;

  const map = {};

  dados.forEach(l=>{
    if(!l.data) return;
    const mes = l.data.substring(0,7);
    if(!map[mes]) map[mes] = {ent:0,sai:0};
    if(l.tipo==="Entrada") map[mes].ent += Number(l.valor||0);
    if(l.tipo==="Saída") map[mes].sai += Number(l.valor||0);
  });

  const labels = Object.keys(map).sort();
  const entMes = labels.map(m=>map[m].ent);
  const saiMes = labels.map(m=>map[m].sai);

  charts.evolucao = new Chart(chartPizza,{
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"Entradas",
          data:entMes,
          borderColor:"#10b981",
          backgroundColor:"rgba(16,185,129,.15)",
          tension:.3,
          fill:true
        },
        {
          label:"Saídas",
          data:saiMes,
          borderColor:"#ef4444",
          backgroundColor:"rgba(239,68,68,.15)",
          tension:.3,
          fill:true
        }
      ]
    },
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.pizza = new Chart(chartPerc,{
    type:"pie",
    data:{
      labels:["Entradas","Saídas"],
      datasets:[{
        data:[totalEnt,totalSai],
        backgroundColor:['#10b981','#ef4444']
      }]
    },
    options:{responsive:false,plugins:{legend:{position:"bottom"}}}
  });

  charts.resumo = new Chart(chartResumo,{
    type:"bar",
    data:{
      labels:["Entradas","Saídas","Resultado"],
      datasets:[{
        data:[totalEnt,totalSai,totalEnt-totalSai],
        backgroundColor:[
          "#10b981",
          "#ef4444",
          (totalEnt-totalSai)>=0?"#10b981":"#ef4444"
        ]
      }]
    },
    options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

}

createCharts();

/* --------------------------
   EXPORTAÇÃO EXCEL
---------------------------*/
function exportExcel(){

  if(!dados.length){
    alert("Não há dados para exportar.");
    return;
  }

  const linhas = dados.map(l=>({
    Data: l.data || "",
    Categoria: l.cat || "",
    Tipo: l.tipo || "",
    Valor: Number(l.valor||0),
    Observação: l.obs || ""
  }));

  linhas.push({});
  linhas.push({Data:"TOTAL ENTRADAS", Valor: totalEnt});
  linhas.push({Data:"TOTAL SAÍDAS", Valor: totalSai});
  linhas.push({Data:"RESULTADO", Valor: totalEnt-totalSai});

  const ws = XLSX.utils.json_to_sheet(linhas);
  const wb = XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(wb, ws, "Relatório");

  XLSX.writeFile(wb, `Relatorio_${perfil}.xlsx`);
}

/* --------------------------
   EXPORTAÇÃO PDF
---------------------------*/
async function exportPDF(){

  if(!dados.length){
    alert("Não há dados para exportar.");
    return;
  }

  const loading = document.getElementById("loading");
  loading.classList.add("show");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  let y = 10;

  doc.setFontSize(14);
  doc.text("Relatório FluxoPro",10,y); y+=7;

  doc.setFontSize(10);
  doc.text(`Perfil: ${perfil}`,10,y); y+=5;
  doc.text(`Nome: ${info.nome||"-"}`,10,y); y+=5;
  doc.text(`Documento: ${info.doc||"-"}`,10,y); y+=7;

  doc.text(`Entradas: ${money(totalEnt)}`,10,y); y+=5;
  doc.text(`Saídas: ${money(totalSai)}`,10,y); y+=5;
  doc.text(`Resultado: ${money(totalEnt-totalSai)}`,10,y); y+=8;

  doc.setFontSize(9);

  for(const l of dados){

    if(y>280){
      doc.addPage();
      y=10;
    }

    const linha =
      `${l.data||""} | ${l.cat||""} | ${l.tipo||""} | ${money(l.valor)} | ${l.obs||""}`;

    doc.text(linha.substring(0,110),10,y);
    y+=5;
  }

  // Gráficos
  doc.addPage();

  doc.text("Gráficos",10,10);

  const img1 = chartPizza.toDataURL("image/png",1.0);
  const img2 = chartPerc.toDataURL("image/png",1.0);
  const img3 = chartResumo.toDataURL("image/png",1.0);

  doc.addImage(img1,"PNG",10,15,90,60);
  doc.addImage(img2,"PNG",110,15,80,80);
  doc.addImage(img3,"PNG",10,85,180,70);

  doc.save(`Relatorio_${perfil}.pdf`);

  loading.classList.remove("show");
}
</script>
</body>
</html>
