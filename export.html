<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Exportação</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
body{
  font-family:Inter,system-ui;
  background:#f1f5f9;
  margin:0;
  padding:20px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:20px;
  max-width:1100px;
  margin:auto;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
h1{margin-top:0}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
}
th{
  background:#2563eb;
  color:#fff;
  text-align:left;
}
.resumo{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:16px;
}
.box{
  background:#f8fafc;
  border-radius:10px;
  padding:12px;
  text-align:center;
}
button{
  padding:10px 14px;
  border:0;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  cursor:pointer;
  margin-right:10px;
}
</style>
</head>
<body>

<div class="card">
  <h1>Exportação – FluxoPro</h1>

  <div id="perfilInfo"></div>

  <div class="resumo">
    <div class="box">
      <strong>Entradas</strong>
      <div id="ent"></div>
    </div>
    <div class="box">
      <strong>Saídas</strong>
      <div id="sai"></div>
    </div>
    <div class="box">
      <strong>Resultado</strong>
      <div id="res"></div>
    </div>
  </div>

  <div style="margin-bottom:15px">
    <button onclick="exportPDF()">Baixar PDF</button>
    <button onclick="exportExcel()">Baixar Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Categoria</th>
        <th>Tipo</th>
        <th>Valor</th>
        <th>Observação</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const params = new URLSearchParams(location.search);
const perfil = params.get("perfil");

const db = JSON.parse(localStorage.getItem("fluxopro_db")||"{}");

const dados = db?.profiles?.[perfil]?.lancamentos || [];
const info  = db?.profiles?.[perfil]?.info || {};

let totalEnt = 0;
let totalSai = 0;

dados.forEach(l=>{
  if(l.tipo==="Entrada") totalEnt+=Number(l.valor||0);
  if(l.tipo==="Saída")   totalSai+=Number(l.valor||0);
});

document.getElementById("perfilInfo").innerHTML = `
<b>Perfil:</b> ${perfil}<br>
<b>Nome / Razão social:</b> ${info.nome||""}<br>
<b>Documento:</b> ${info.doc||""}
`;

document.getElementById("ent").innerText = money(totalEnt);
document.getElementById("sai").innerText = money(totalSai);
document.getElementById("res").innerText = money(totalEnt-totalSai);

const tbody = document.getElementById("tbody");

dados.forEach(l=>{
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${l.data||""}</td>
    <td>${l.cat||""}</td>
    <td>${l.tipo||""}</td>
    <td>${money(l.valor||0)}</td>
    <td>${l.obs||""}</td>
  `;
  tbody.appendChild(tr);
});

function money(v){
  return Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* ---------------- PDF bonito ---------------- */

function exportPDF(){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFillColor(37,99,235);
  doc.rect(0,0,210,28,"F");

  doc.setTextColor(255,255,255);
  doc.setFontSize(16);
  doc.text("FluxoPro – Relatório Financeiro",10,18);

  doc.setTextColor(0,0,0);

  let y=40;

  doc.setFillColor(241,245,249);
  doc.roundedRect(10,y-8,190,28,4,4,"F");

  doc.setFontSize(11);
  doc.text(`Perfil: ${perfil}`,14,y); y+=6;
  doc.text(`Nome: ${info.nome||""}`,14,y); y+=6;
  doc.text(`Documento: ${info.doc||""}`,14,y);

  y+=16;

  doc.autoTable({
    startY:y,
    head:[["Entradas","Saídas","Resultado"]],
    body:[[money(totalEnt),money(totalSai),money(totalEnt-totalSai)]],
    theme:"grid",
    headStyles:{fillColor:[37,99,235]},
    styles:{halign:"center"}
  });

  y = doc.lastAutoTable.finalY + 10;

  doc.autoTable({
    startY:y,
    head:[["Data","Categoria","Tipo","Valor","Observação"]],
    body:dados.map(l=>[
      l.data||"",
      l.cat||"",
      l.tipo||"",
      money(l.valor||0),
      l.obs||""
    ]),
    theme:"striped",
    headStyles:{fillColor:[37,99,235],textColor:255},
    alternateRowStyles:{fillColor:[241,245,249]},
    styles:{fontSize:9}
  });

  doc.save(`fluxopro_${perfil}.pdf`);
}

/* ---------------- Excel organizado ---------------- */

function exportExcel(){

  const rows = [];

  rows.push(["FluxoPro – Relatório Financeiro"]);
  rows.push([]);
  rows.push(["Perfil",perfil]);
  rows.push(["Nome / Razão social",info.nome||""]);
  rows.push(["Documento",info.doc||""]);
  rows.push([]);
  rows.push(["Entradas",totalEnt]);
  rows.push(["Saídas",totalSai]);
  rows.push(["Resultado",totalEnt-totalSai]);
  rows.push([]);
  rows.push(["Data","Categoria","Tipo","Valor","Observação"]);

  dados.forEach(l=>{
    rows.push([l.data||"",l.cat||"",l.tipo||"",Number(l.valor||0),l.obs||""]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);

  ws["!cols"]=[
    {wch:12},{wch:22},{wch:14},{wch:14},{wch:35}
  ];

  ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Relatório");

  XLSX.writeFile(wb,`fluxopro_${perfil}.xlsx`);
}
</script>
</body>
</html>
