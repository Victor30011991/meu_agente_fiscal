<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb}
.container{max-width:1100px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.05)}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}

.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-bottom:16px;
}
.box{
  background:#f3f6fb;
  padding:12px;
  border-radius:10px;
  font-weight:700;
}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:13px}
th{background:#f8fafc}
</style>
</head>
<body>

<div class="container">

<div class="top">
<h1>Relatório FluxoPro</h1>
<div>
<button onclick="exportExcel()">Excel</button>
<button onclick="exportPDF()">PDF</button>
</div>
</div>

<div class="card">

<h3 id="perfilTitulo"></h3>
<div id="perfilDados"></div>

<div class="grid">
  <div class="box">Entradas<br><span id="ent"></span></div>
  <div class="box">Saídas<br><span id="sai"></span></div>
  <div class="box">Resultado<br><span id="res"></span></div>
</div>

<table>
<thead>
<tr>
<th>Data</th>
<th>Categoria</th>
<th>Tipo</th>
<th>Valor</th>
<th>Observação</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>

</div>
</div>

<script>
const KEY="fluxopro_v11";

const db = JSON.parse(localStorage.getItem(KEY));
const perfil = db.active;
const dados = db.profiles[perfil] || [];
const info = db.profileInfo?.[perfil] || {};

function money(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

perfilTitulo.innerText = "Perfil: " + perfil;
perfilDados.innerHTML = `
<p><b>Nome:</b> ${info.nome||""}</p>
<p><b>Documento:</b> ${info.doc||""}</p>
`;

let totalEnt=0,totalSai=0;

dados.forEach(l=>{
  if(l.tipo==="Entrada") totalEnt+=Number(l.valor||0);
  else totalSai+=Number(l.valor||0);
});

ent.innerText = money(totalEnt);
sai.innerText = money(totalSai);
res.innerText = money(totalEnt-totalSai);

tb.innerHTML = dados.map(l=>`
<tr>
<td>${l.data||""}</td>
<td>${l.cat||""}</td>
<td>${l.tipo||""}</td>
<td>${money(l.valor)}</td>
<td>${l.obs||""}</td>
</tr>
`).join("");

/* =========================================================
   EXCEL – layout igual ao relatório + fórmulas
========================================================= */
function exportExcel(){

  const header = [
    ["Relatório FluxoPro"],
    [],
    ["Perfil", perfil],
    ["Nome", info.nome||""],
    ["Documento", info.doc||""],
    [],
    ["Entradas", "", "Saídas", "", "Resultado"],
    ["=SUMIF(B12:B1000,\"Entrada\",D12:D1000)","","=SUMIF(B12:B1000,\"Saída\",D12:D1000)","","=A8-C8"],
    [],
    ["Data","Categoria","Tipo","Valor","Observação"]
  ];

  const linhas = dados.map(l=>[
    l.data||"",
    l.tipo||"",
    l.cat||"",
    Number(l.valor||0),
    l.obs||""
  ]);

  const sheetData = header.concat(linhas);

  const ws = XLSX.utils.aoa_to_sheet(sheetData);

  ws["!merges"] = [
    {s:{r:0,c:0},e:{r:0,c:4}},
  ];

  ws["!cols"] = [
    {wch:14},
    {wch:12},
    {wch:20},
    {wch:14},
    {wch:35}
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Relatório");

  XLSX.writeFile(wb, `fluxopro_${perfil}.xlsx`);
}

/* =========================================================
   PDF – estilo visual (cards + tabela) tipo relatório
========================================================= */
function exportPDF(){

  const {jsPDF} = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  let y = 15;

  doc.setFontSize(18);
  doc.text("Relatório FluxoPro", 14, y);
  y+=10;

  doc.setFontSize(11);
  doc.text(`Perfil: ${perfil}`,14,y); y+=6;
  doc.text(`Nome: ${info.nome||""}`,14,y); y+=6;
  doc.text(`Documento: ${info.doc||""}`,14,y); y+=10;

  function card(x,y,w,h,title,value){
    doc.setDrawColor(230);
    doc.setFillColor(245,247,251);
    doc.roundedRect(x,y,w,h,3,3,"F");
    doc.setTextColor(60);
    doc.setFontSize(10);
    doc.text(title,x+4,y+6);
    doc.setFontSize(13);
    doc.text(value,x+4,y+14);
  }

  card(14,y,55,22,"Entradas",money(totalEnt));
  card(75,y,55,22,"Saídas",money(totalSai));
  card(136,y,55,22,"Resultado",money(totalEnt-totalSai));

  y+=30;

  doc.setFontSize(10);

  const headers=["Data","Categoria","Tipo","Valor","Obs"];
  const col=[14,40,85,115,140];

  headers.forEach((h,i)=>doc.text(h,col[i],y));
  y+=4;
  doc.line(14,y,196,y);
  y+=5;

  dados.forEach(l=>{
    if(y>280){
      doc.addPage();
      y=15;
    }

    doc.text(String(l.data||""),col[0],y);
    doc.text(String(l.cat||""),col[1],y);
    doc.text(String(l.tipo||""),col[2],y);
    doc.text(money(l.valor),col[3],y);
    doc.text(String(l.obs||""),col[4],y);

    y+=6;
  });

  doc.save(`fluxopro_${perfil}.pdf`);
}

</script>
</body>
</html>
