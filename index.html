<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v12</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link id="themeCSS" rel="stylesheet" href="">
<style>
/* ── VARIÁVEIS – tema padrão claro. themes/*.css sobrescreve. ── */
:root {
  --bg:#f0f2f8; --bg2:#e6e9f4; --card:#fff; --card-border:#e2e5ef;
  --header-bg:#fff; --header-border:#e2e5ef;
  --text:#1a1f36; --text2:#6b7280; --text3:#9ca3af; --text-inv:#fff;
  --primary:#4f46e5; --primary-l:#eef2ff; --primary-d:#3730a3;
  --ok:#059669; --ok-l:#d1fae5; --ok-b:#a7f3d0;
  --bad:#dc2626; --bad-l:#fee2e2; --bad-b:#fecaca;
  --warn:#d97706; --warn-l:#fef3c7;
  --table-alt:#f8fafc; --table-hover:#eef2ff;
  --input-bg:#f8fafc; --input-border:#d1d5db;
  --shadow-sm:0 1px 3px rgba(0,0,0,.06); --shadow:0 4px 16px rgba(0,0,0,.07);
  --shadow-lg:0 12px 32px rgba(0,0,0,.10);
  --radius:14px; --radius-sm:8px; --radius-xs:5px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text);transition:background .3s,color .3s;min-height:100vh}
a{color:var(--primary)}
::selection{background:var(--primary-l);color:var(--primary-d)}
.hidden{display:none!important}

/* ── HEADER ── */
header{background:var(--header-bg);border-bottom:1px solid var(--header-border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:200;box-shadow:var(--shadow-sm)}
.header-brand{display:flex;align-items:center;gap:10px}
.header-logo{width:34px;height:34px;background:var(--primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-1px}
.header-brand h1{font-size:15px;font-weight:800;color:var(--text);letter-spacing:-.3px}
.header-brand span{font-size:10px;color:var(--text3);display:block;font-weight:400}
.header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.perfil-select-wrap{display:flex;align-items:center;gap:6px}
.perfil-select-wrap select{padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-family:inherit;font-size:12px;font-weight:600}
.btn-icon{width:30px;height:30px;border-radius:6px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text2);font-weight:700;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:inherit}
.btn-icon:hover{background:var(--primary-l);border-color:var(--primary);color:var(--primary)}

/* ── TABS ── */
.tabs{display:flex;gap:2px;background:var(--bg2);padding:3px;border-radius:10px;border:1px solid var(--card-border)}
.tabs button{border:none;padding:5px 13px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;background:transparent;color:var(--text2);transition:all .2s;font-family:inherit;white-space:nowrap}
.tabs button.active{background:var(--card);color:var(--primary);box-shadow:var(--shadow-sm)}

/* ── LAYOUT ── */
.container{max-width:1420px;margin:0 auto;padding:20px 18px}
.layout{display:grid;grid-template-columns:288px 1fr;gap:18px;align-items:flex-start}
.sidebar{position:sticky;top:64px;display:flex;flex-direction:column;gap:12px}
@media(max-width:980px){.layout{grid-template-columns:1fr}.sidebar{position:relative;top:0}}
@media(max-width:640px){header{padding:0 14px}.container{padding:14px 12px}}

/* ── CARDS ── */
.card{background:var(--card);border-radius:var(--radius);border:1px solid var(--card-border);box-shadow:var(--shadow);transition:background .3s,border-color .3s;overflow:hidden}
.card-head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--card-border);gap:8px}
.card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);display:flex;align-items:center;gap:7px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--primary);flex-shrink:0;display:inline-block}

/* ── KPI ── */
.kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 16px 16px}
@media(max-width:640px){.kpi-row{grid-template-columns:1fr}}
.kpi-card{border-radius:10px;padding:12px 14px;border:1px solid transparent;transition:all .3s;position:relative;overflow:hidden}
.kpi-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:2px 2px 0 0}
.kpi-card.ent{background:var(--ok-l);border-color:var(--ok-b)} .kpi-card.ent::after{background:var(--ok)}
.kpi-card.sai{background:var(--bad-l);border-color:var(--bad-b)} .kpi-card.sai::after{background:var(--bad)}
.kpi-card.net{background:var(--primary-l);border-color:#c7d2fe} .kpi-card.net::after{background:var(--primary)}
.kpi-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px}
.kpi-card.ent .kpi-label{color:#047857} .kpi-card.sai .kpi-label{color:#b91c1c} .kpi-card.net .kpi-label{color:var(--primary-d)}
.kpi-value{font-size:18px;font-weight:800;letter-spacing:-1px;line-height:1;margin-bottom:4px}
.kpi-card.ent .kpi-value{color:var(--ok)} .kpi-card.sai .kpi-value{color:var(--bad)} .kpi-card.net .kpi-value{color:var(--primary)}
.kpi-meta{font-size:10px;color:var(--text2)}
.kpi-bar{height:3px;border-radius:2px;background:rgba(0,0,0,.08);margin-top:8px;overflow:hidden}
.kpi-bar-fill{height:100%;border-radius:2px;transition:width .7s cubic-bezier(.4,0,.2,1)}

/* ── GRÁFICOS ── */
.chart-wrap{padding:10px 16px 12px}
.chart-note{font-size:10px;color:var(--text2);padding:0 16px 12px;line-height:1.5}
.chart-hidden{display:none!important}

/* ── PERFIL ── */
.perfil-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px 16px 14px}
.perfil-field label{display:block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:4px}
.perfil-field input{width:100%;padding:7px 10px;border-radius:var(--radius-sm);border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-family:inherit;font-size:13px;font-weight:500;transition:border-color .2s}
.perfil-field input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}

/* ── BOTÕES ── */
.lanc-header{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
.btn-new{display:flex;align-items:center;gap:6px;padding:9px 16px;border:none;border-radius:var(--radius-sm);background:var(--primary);color:#fff;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(79,70,229,.25);font-family:inherit}
.btn-new:hover{background:var(--primary-d);transform:translateY(-1px);box-shadow:0 4px 14px rgba(79,70,229,.35)}
.btn-sec{display:flex;align-items:center;gap:5px;padding:8px 13px;border:1px solid var(--card-border);border-radius:var(--radius-sm);background:var(--card);color:var(--text);font-weight:600;font-size:12px;cursor:pointer;transition:all .2s;font-family:inherit}
.btn-sec:hover{background:var(--primary-l);border-color:var(--primary);color:var(--primary)}

/* ── FILTROS ── */
.filter-bar{display:flex;gap:6px;flex-wrap:wrap;padding:10px 16px 12px;align-items:center}
.filter-bar input[type="text"],.filter-bar select,.filter-bar input[type="date"]{padding:7px 10px;border-radius:var(--radius-sm);border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-family:inherit;font-size:12px;transition:border-color .2s}
.filter-bar input:focus,.filter-bar select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
.filter-search{flex:1;min-width:140px;padding-left:30px!important;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2.5'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:9px center}
.filter-date-wrap{display:flex;align-items:center;gap:4px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:var(--radius-sm);padding:2px 6px}
.filter-date-wrap span{font-size:10px;color:var(--text2);font-weight:600}
.filter-date-wrap input[type="date"]{border:none;background:transparent;padding:5px 4px;box-shadow:none!important}
.quick-filters{display:flex;gap:4px;flex-wrap:wrap}
.qf-btn{padding:5px 9px;border-radius:20px;border:1px solid var(--card-border);background:var(--card);color:var(--text2);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit;white-space:nowrap}
.qf-btn:hover,.qf-btn.active{background:var(--primary-l);border-color:var(--primary);color:var(--primary)}

/* ── TABELA ── */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead tr{background:var(--bg2)}
th{padding:9px 12px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);white-space:nowrap;border-bottom:2px solid var(--card-border);cursor:default;user-select:none}
th.sortable{cursor:pointer} th.sortable:hover{color:var(--primary)}
th .sort-icon{margin-left:3px;opacity:.4}
th.asc .sort-icon::after{content:' ↑';opacity:1} th.desc .sort-icon::after{content:' ↓';opacity:1}
td{padding:9px 12px;border-bottom:1px solid var(--card-border);font-size:12px;color:var(--text);vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:nth-child(even){background:var(--table-alt)}
tbody tr:hover{background:var(--table-hover)}
td[contenteditable]{cursor:text;transition:background .15s}
td[contenteditable]:focus{outline:2px solid var(--primary);outline-offset:-1px;background:var(--primary-l);border-radius:3px}
.td-date{font-weight:600;font-size:11px;color:var(--text2);white-space:nowrap}
.td-cat{font-weight:600} .td-value{font-weight:700;text-align:right;white-space:nowrap}

/* ── BADGE / RODAPÉ / DEL ── */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-weight:700;font-size:10px;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.3px;white-space:nowrap;user-select:none}
.badge:hover{filter:brightness(.9);transform:scale(1.04)}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
.entrada{background:var(--ok-l);color:var(--ok)} .saida{background:var(--bad-l);color:var(--bad)}
.table-footer{padding:8px 16px;display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text2);border-top:1px solid var(--card-border);background:var(--table-alt);flex-wrap:wrap;gap:4px}
.btn-del{width:26px;height:26px;border-radius:var(--radius-xs);border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;font-family:inherit}
.btn-del:hover{background:var(--bad-l);color:var(--bad)}
.empty-state{text-align:center;padding:48px 20px;color:var(--text2)}
.empty-state .es-icon{font-size:38px;margin-bottom:10px}
.empty-state h3{font-size:15px;color:var(--text);margin-bottom:5px;font-weight:700}
.empty-state p{font-size:12px;line-height:1.6;max-width:280px;margin:0 auto}

/* ── CONFIGURAÇÕES ── */
.conf-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 16px 18px}
@media(max-width:700px){.conf-grid{grid-template-columns:1fr}}
.conf-block{background:var(--bg2);border:1px solid var(--card-border);border-radius:10px;padding:13px}
.conf-block-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.conf-block-title span{font-size:15px}
.theme-selector{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.theme-btn{width:30px;height:30px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .2s,box-shadow .2s;flex-shrink:0}
.theme-btn:hover{transform:scale(1.18)}
.theme-btn.active{box-shadow:0 0 0 2px var(--card),0 0 0 4px var(--primary)}
.theme-default{background:linear-gradient(135deg,#e0e7ff,#4f46e5)} .theme-dark{background:linear-gradient(135deg,#1e293b,#0f172a)}
.theme-emerald{background:linear-gradient(135deg,#a7f3d0,#059669)} .theme-gold{background:linear-gradient(135deg,#fde68a,#d97706)}
.theme-indigo{background:linear-gradient(135deg,#c7d2fe,#6366f1)} .theme-rose{background:linear-gradient(135deg,#fecdd3,#e11d48)}
.theme-custom{background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red)}
.color-picker-wrap{position:relative;display:inline-flex;align-items:center}
.color-picker-wrap input[type="color"]{position:absolute;width:30px;height:30px;opacity:0;cursor:pointer;border:none;padding:0}
.theme-label{font-size:10px;color:var(--text2);margin-top:8px;display:block}
.toggle-list{display:flex;flex-direction:column;gap:10px}
.toggle-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.toggle-row label{font-size:12px;font-weight:500;color:var(--text);cursor:pointer;flex:1}
.toggle-row .toggle-desc{font-size:10px;color:var(--text2)}
.switch{position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:var(--card-border);border-radius:20px;transition:.2s}
.slider::before{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:white;left:3px;bottom:3px;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.switch input:checked+.slider{background:var(--primary)}
.switch input:checked+.slider::before{transform:translateX(16px)}
.conf-actions{display:flex;flex-direction:column;gap:7px}
.conf-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--radius-sm);font-weight:600;font-size:11px;cursor:pointer;transition:all .15s;border:1px solid var(--card-border);background:var(--card);color:var(--text);font-family:inherit;text-align:left}
.conf-btn:hover{background:var(--primary-l);border-color:var(--primary);color:var(--primary)}
.conf-btn.danger{border-color:var(--bad-b);background:var(--bad-l);color:var(--bad)}
.conf-btn.danger:hover{background:var(--bad);color:#fff}
.conf-info-row{display:flex;justify-content:space-between;font-size:11px;padding:5px 0;border-bottom:1px solid var(--card-border)}
.conf-info-row:last-child{border-bottom:none}
.conf-info-row span{color:var(--text2)} .conf-info-row strong{color:var(--text);font-weight:600}

/* ── MODAL ── */
.modal{position:fixed;inset:0;background:rgba(10,10,20,.48);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
.modal-box{background:var(--card);border:1px solid var(--card-border);border-radius:18px;width:100%;max-width:420px;box-shadow:var(--shadow-lg);overflow:hidden;animation:modalIn .2s ease}
@keyframes modalIn{from{transform:scale(.93) translateY(12px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.modal-header{padding:16px 20px 0;display:flex;align-items:center;justify-content:space-between}
.modal-header h3{font-size:15px;font-weight:800;color:var(--text)}
.modal-close{width:26px;height:26px;border:none;background:var(--bg2);border-radius:var(--radius-xs);cursor:pointer;color:var(--text2);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:inherit}
.modal-close:hover{background:var(--bad-l);color:var(--bad)}
.modal-body{padding:16px 20px 20px}
.form-group{margin-bottom:11px}
.form-group label{display:block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:4px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 11px;border-radius:var(--radius-sm);border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);font-family:inherit;font-size:13px;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-actions{display:flex;gap:8px;margin-top:14px}
.btn-save{flex:1;padding:9px;border:none;border-radius:var(--radius-sm);background:var(--primary);color:#fff;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s;font-family:inherit}
.btn-save:hover{background:var(--primary-d)}
.btn-cancel-modal{padding:9px 14px;border:1px solid var(--card-border);border-radius:var(--radius-sm);background:var(--card);color:var(--text2);font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;font-family:inherit}
.btn-cancel-modal:hover{background:var(--bg2)}

/* ── TOAST ── */
.toast{position:fixed;bottom:22px;right:22px;background:var(--text);color:var(--text-inv);padding:9px 16px;border-radius:10px;font-size:12px;font-weight:600;box-shadow:var(--shadow-lg);z-index:10000;animation:toastIn .22s ease;max-width:300px}
@keyframes toastIn{from{transform:translateY(8px) scale(.95);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="header-logo">FP</div>
    <div><h1>FluxoPro</h1><span>Engine v12 &mdash; Controle financeiro</span></div>
  </div>
  <div class="header-right">
    <div class="perfil-select-wrap">
      <select id="perfilSelect"></select>
      <button class="btn-icon" id="novoPerfil" title="Novo perfil">+</button>
    </div>
    <div class="tabs">
      <button data-tab="lanc" class="active">Lançamentos</button>
      <button data-tab="conf">Configurações</button>
    </div>
  </div>
</header>

<div class="container"><div class="layout">

<aside class="sidebar">
  <div class="card" id="card-pizza">
    <div class="card-head"><span class="card-title"><span class="dot" style="background:var(--primary)"></span>Gastos por Categoria</span></div>
    <div class="chart-wrap"><canvas id="chartPizza" height="200"></canvas></div>
    <p class="chart-note" id="txtPizza"></p>
  </div>
  <div class="card" id="card-evolucao">
    <div class="card-head"><span class="card-title"><span class="dot" style="background:var(--ok)"></span>Evolução Mensal</span></div>
    <div class="chart-wrap"><canvas id="chartEvolucao" height="180"></canvas></div>
    <p class="chart-note" id="txtEvolucao"></p>
  </div>
  <div class="card" id="card-saldo">
    <div class="card-head"><span class="card-title"><span class="dot" style="background:var(--warn)"></span>Saldo Acumulado</span></div>
    <div class="chart-wrap"><canvas id="chartSaldo" height="160"></canvas></div>
    <p class="chart-note" id="txtSaldo"></p>
  </div>
  <div class="card" id="card-top">
    <div class="card-head"><span class="card-title"><span class="dot" style="background:var(--bad)"></span>Top Gastos</span></div>
    <div class="chart-wrap"><canvas id="chartTop" height="160"></canvas></div>
    <p class="chart-note" id="txtTop"></p>
  </div>
</aside>

<main>
  <!-- ABA LANÇAMENTOS -->
  <section id="tab-lanc">
    <div class="lanc-header">
      <button class="btn-new" id="novoLanc">&#10133; Novo lançamento</button>
      <button class="btn-sec" id="importar">&#128229; Importar</button>
      <button class="btn-sec" id="exportarBtn">&#128202; Exportar</button>
      <button class="btn-sec" id="refreshBtn">&#8635;</button>
    </div>

    <div class="card" style="margin-bottom:14px">
      <div class="card-head">
        <span class="card-title"><span class="dot" style="background:var(--warn)"></span>Dados do Perfil</span>
        <span style="font-size:10px;color:var(--text2)" id="periodoLabel"></span>
      </div>
      <div class="perfil-grid">
        <div class="perfil-field"><label>Nome / Razão social</label><input id="perfilNome" placeholder="Ex: João Silva ou Empresa Ltda."></div>
        <div class="perfil-field"><label>CPF ou CNPJ</label><input id="perfilDoc" placeholder="000.000.000-00"></div>
      </div>
      <div class="kpi-row">
        <div class="kpi-card ent">
          <div class="kpi-label">Entradas &mdash; ganhos</div>
          <div class="kpi-value" id="sumEnt">R$&nbsp;0,00</div>
          <div class="kpi-meta" id="sumEntQtd">0 lançamentos</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="barEnt" style="background:var(--ok);width:0%"></div></div>
        </div>
        <div class="kpi-card sai">
          <div class="kpi-label">Saídas &mdash; gastos</div>
          <div class="kpi-value" id="sumSai">R$&nbsp;0,00</div>
          <div class="kpi-meta" id="sumSaiQtd">0 lançamentos</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="barSai" style="background:var(--bad);width:0%"></div></div>
        </div>
        <div class="kpi-card net">
          <div class="kpi-label">Resultado líquido</div>
          <div class="kpi-value" id="sumRes">R$&nbsp;0,00</div>
          <div class="kpi-meta" id="sumResPct">—</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="barRes" style="background:var(--primary);width:50%"></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <span class="card-title"><span class="dot"></span>Extrato de Lançamentos</span>
        <span id="totalLanc" style="font-size:10px;color:var(--text2);font-weight:600"></span>
      </div>
      <div class="filter-bar">
        <input type="text" class="filter-search" id="fBusca" placeholder="Buscar categoria ou observação...">
        <select id="fTipo">
          <option value="">Todos os tipos</option>
          <option value="Entrada">Entradas</option>
          <option value="Saida">Saídas</option>
        </select>
        <div class="filter-date-wrap">
          <input type="date" id="fDataDe" title="Data inicial">
          <span>até</span>
          <input type="date" id="fDataAte" title="Data final">
        </div>
        <button class="btn-sec" id="clearFilter" style="padding:6px 10px;font-size:11px">&#10005; Limpar</button>
      </div>
      <div class="filter-bar" style="padding-top:0;padding-bottom:10px">
        <div class="quick-filters">
          <button class="qf-btn" data-qf="hoje">Hoje</button>
          <button class="qf-btn" data-qf="semana">Esta semana</button>
          <button class="qf-btn" data-qf="mes">Este mês</button>
          <button class="qf-btn" data-qf="tri">Trim. atual</button>
          <button class="qf-btn" data-qf="ano">Este ano</button>
          <button class="qf-btn" data-qf="tudo">Tudo</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th class="sortable" data-col="data">Data<span class="sort-icon"></span></th>
            <th class="sortable" data-col="cat">Categoria<span class="sort-icon"></span></th>
            <th>Tipo</th>
            <th class="sortable" data-col="valor" style="text-align:right">Valor<span class="sort-icon"></span></th>
            <th>Observação</th>
            <th style="width:36px"></th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="table-footer">
        <span id="footerCount"></span>
        <span id="footerTotal" style="font-weight:600"></span>
      </div>
    </div>
  </section>

  <!-- ABA CONFIGURAÇÕES -->
  <section id="tab-conf" class="hidden">
    <div class="card">
      <div class="card-head"><span class="card-title"><span class="dot" style="background:var(--warn)"></span>Configurações do Sistema</span></div>
      <div class="conf-grid">

        <div class="conf-block">
          <div class="conf-block-title"><span>&#127912;</span> Tema Visual</div>
          <div class="theme-selector" id="themeSelector">
            <button class="theme-btn theme-default active" data-theme="" title="Padrão"></button>
            <button class="theme-btn theme-dark"    data-theme="dark"    title="Dark"></button>
            <button class="theme-btn theme-emerald" data-theme="emerald" title="Verde"></button>
            <button class="theme-btn theme-gold"    data-theme="gold"    title="Dourado"></button>
            <button class="theme-btn theme-indigo"  data-theme="indigo"  title="Índigo"></button>
            <button class="theme-btn theme-rose"    data-theme="rose"    title="Rosa"></button>
            <div class="color-picker-wrap" title="Cor personalizada">
              <button class="theme-btn theme-custom" data-theme="custom" title="Personalizado"></button>
              <input type="color" id="colorPicker" value="#4f46e5">
            </div>
          </div>
          <span class="theme-label" id="themeLabel">Tema: Padrão</span>
        </div>

        <div class="conf-block">
          <div class="conf-block-title"><span>&#128200;</span> Gráficos na Sidebar</div>
          <div class="toggle-list">
            <div class="toggle-row"><div><label for="tog-pizza">Gastos por Categoria</label><div class="toggle-desc">Donut das saídas</div></div><label class="switch"><input type="checkbox" id="tog-pizza" data-chart="pizza" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><div><label for="tog-evolucao">Evolução Mensal</label><div class="toggle-desc">Linha ent. x saídas</div></div><label class="switch"><input type="checkbox" id="tog-evolucao" data-chart="evolucao" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><div><label for="tog-saldo">Saldo Acumulado</label><div class="toggle-desc">Evolução do saldo</div></div><label class="switch"><input type="checkbox" id="tog-saldo" data-chart="saldo" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><div><label for="tog-top">Top Gastos</label><div class="toggle-desc">Barras maiores categ.</div></div><label class="switch"><input type="checkbox" id="tog-top" data-chart="top" checked><span class="slider"></span></label></div>
          </div>
        </div>

        <div class="conf-block">
          <div class="conf-block-title"><span>&#128100;</span> Perfil Ativo</div>
          <div class="conf-info-row"><span>Perfil</span><strong id="confPerfilNome">—</strong></div>
          <div class="conf-info-row"><span>Nome</span><strong id="confNome">—</strong></div>
          <div class="conf-info-row"><span>Documento</span><strong id="confDoc">—</strong></div>
          <div class="conf-info-row"><span>Entradas</span><strong id="confEntradas">—</strong></div>
          <div class="conf-info-row"><span>Saídas</span><strong id="confSaidas">—</strong></div>
          <div class="conf-info-row"><span>Lançamentos</span><strong id="confQtd">0</strong></div>
        </div>

        <div class="conf-block">
          <div class="conf-block-title"><span>&#128202;</span> Exportação</div>
          <div class="conf-actions">
            <button class="conf-btn" id="exportAll">&#128196; Gerar Relatório (PDF + Excel)</button>
            <button class="conf-btn" onclick="abrirImport()">&#128229; Importar (Excel / PDF)</button>
          </div>
        </div>

        <div class="conf-block">
          <div class="conf-block-title"><span>&#128193;</span> Gerenciar Perfis</div>
          <div class="conf-actions">
            <button class="conf-btn" id="btnNovoPerfil2">&#10133; Criar novo perfil</button>
            <button class="conf-btn" id="btnRenamePerfil">&#9998; Renomear perfil atual</button>
            <button class="conf-btn danger" id="btnDeletePerfil">&#128465; Excluir perfil atual</button>
          </div>
        </div>

        <div class="conf-block">
          <div class="conf-block-title"><span>&#128190;</span> Backup de Dados</div>
          <div class="conf-actions">
            <button class="conf-btn" id="btnBackup">&#8595; Exportar backup JSON</button>
            <button class="conf-btn" id="btnRestore">&#8593; Restaurar backup JSON</button>
          </div>
        </div>

        <div class="conf-block" style="grid-column:1/-1">
          <div class="conf-block-title"><span>&#9888;</span> Zona de Perigo</div>
          <div class="conf-actions" style="flex-direction:row;flex-wrap:wrap">
            <button class="conf-btn danger" id="btnLimparPerfil">&#128465; Limpar lançamentos</button>
            <button class="conf-btn danger" id="resetAll">&#128465; Reset de fábrica</button>
          </div>
          <p style="font-size:10px;color:var(--text2);margin-top:10px;line-height:1.5">&#9888; Ações irreversíveis. Faça um backup antes.</p>
        </div>

      </div>
    </div>
  </section>
</main>
</div></div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Novo Lançamento</h3>
      <button class="modal-close" onclick="fecharModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <form id="form">
        <div class="form-row">
          <div class="form-group"><label>Data</label><input type="date" id="data" required></div>
          <div class="form-group"><label>Tipo</label><select id="tipo"><option>Entrada</option><option>Saída</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Categoria</label><input type="text" id="cat" placeholder="Ex: Salário, Aluguel..." required autocomplete="off"></div>
          <div class="form-group"><label>Valor (R$)</label><input type="text" id="valor" placeholder="Ex: 1.500,00" required></div>
        </div>
        <div class="form-group"><label>Observação</label><textarea id="obs" placeholder="Detalhes..." rows="2"></textarea></div>
        <div class="form-actions">
          <button type="submit" class="btn-save">&#128190; Salvar</button>
          <button type="button" class="btn-cancel-modal" onclick="fecharModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<input type="file" id="restoreInput" accept=".json" style="display:none">

<script>
const KEY = "fluxopro_v12";
let charts = {}, debounceTimer;
let sortState   = { col:"data", dir:"asc" };
let filterState = { busca:"", tipo:"", dataDe:"", dataAte:"", qf:"" };
const PALETTE   = ["#4f46e5","#059669","#d97706","#7c3aed","#0891b2","#db2777","#65a30d","#ea580c","#2563eb","#dc2626"];

/* ── TIPO ── */
const normTipo = t => String(t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();
const ehEntrada = t => normTipo(t)==="entrada";
const ehSaida   = t => normTipo(t)==="saida";

/* ── MOEDA ── */
function parseMoney(raw) {
  let s = String(raw||"").trim().replace(/[R$\s]/g,"");
  if (!s) return null;
  const dots=(s.match(/\./g)||[]).length, commas=(s.match(/,/g)||[]).length;
  if (dots>0&&commas>0) s=s.lastIndexOf(",")>s.lastIndexOf(".")?s.replace(/\./g,"").replace(",","."):s.replace(/,/g,"");
  else if (commas===1) { const p=s.split(","); s=p[1]&&p[1].length<=2?s.replace(",","."):s.replace(",",""); }
  else if (dots===1)  { const p=s.split("."); if(p[1]&&p[1].length===3&&/^\d+$/.test(p[1]))s=s.replace(".",""); }
  const n=parseFloat(s); return isNaN(n)?null:Math.abs(n);
}

/* ── DB ── */
function loadDB() {
  try { const r=localStorage.getItem(KEY); if(r) return JSON.parse(r); } catch(e){}
  return { active:"default", profiles:{default:[]}, profileInfo:{}, theme:"", customColor:"#4f46e5", chartConfig:{pizza:true,evolucao:true,saldo:true,top:true} };
}
const saveDB = db => { try{localStorage.setItem(KEY,JSON.stringify(db));}catch(e){} };
const list   = ()  => { const db=loadDB(); return db.profiles[db.active]||[]; };

/* ── FORMATADORES ── */
const fmtMoney = v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
const fmtDate  = iso => { if(!iso)return"—"; const[y,m,d]=iso.split("-"); return`${d}/${m}/${y}`; };

/* ── DATAS RÁPIDAS ── (uma função unificada) */
function isoRef(ref) {
  const d=new Date();
  if(ref==="today")  return d.toISOString().split("T")[0];
  if(ref==="week")   { d.setDate(d.getDate()-d.getDay()); }
  if(ref==="month")  { d.setDate(1); }
  if(ref==="quarter"){ d.setMonth(Math.floor(d.getMonth()/3)*3,1); }
  if(ref==="year")   { d.setMonth(0,1); }
  return d.toISOString().split("T")[0];
}

/* ── FILTROS / SORT ── */
function applyFilters(dados) {
  return dados.filter(i => {
    const b=filterState.busca.toLowerCase();
    if(b&&!((i.cat||"")+" "+(i.obs||"")).toLowerCase().includes(b)) return false;
    if(filterState.tipo==="Entrada"&&!ehEntrada(i.tipo)) return false;
    if(filterState.tipo==="Saida"  &&!ehSaida(i.tipo))  return false;
    if(filterState.dataDe &&i.data&&i.data<filterState.dataDe)  return false;
    if(filterState.dataAte&&i.data&&i.data>filterState.dataAte) return false;
    return true;
  });
}
function sortData(dados) {
  return [...dados].sort((a,b)=>{
    let va=a[sortState.col]??"", vb=b[sortState.col]??"";
    if(sortState.col==="valor"){va=+va;vb=+vb;}
    const r=va<vb?-1:va>vb?1:0;
    return sortState.dir==="asc"?r:-r;
  });
}

/* ── PERFIS ── */
function renderPerfis() {
  const db=loadDB();
  perfilSelect.innerHTML=Object.keys(db.profiles).map(p=>`<option ${p===db.active?"selected":""}>${p}</option>`).join("");
}
function renderProfileInfo() {
  const db=loadDB(), info=db.profileInfo[db.active]||{};
  perfilNome.value=info.nome||""; perfilDoc.value=info.doc||"";
}
function saveProfileInfo() {
  const db=loadDB();
  if(!db.profileInfo) db.profileInfo={};
  db.profileInfo[db.active]={nome:perfilNome.value.trim(),doc:perfilDoc.value.trim()};
  saveDB(db); atualizarConfPerfil();
}
function atualizarConfPerfil() {
  const db=loadDB(), info=db.profileInfo[db.active]||{}, todos=db.profiles[db.active]||[];
  let e=0,s=0; todos.forEach(l=>ehEntrada(l.tipo)?e+=l.valor:s+=l.valor);
  const $=id=>document.getElementById(id);
  $("confPerfilNome").innerText=db.active; $("confNome").innerText=info.nome||"—";
  $("confDoc").innerText=info.doc||"—"; $("confEntradas").innerText=fmtMoney(e);
  $("confSaidas").innerText=fmtMoney(s);
  $("confQtd").innerText=todos.length+" lançamento"+(todos.length!==1?"s":"");
}

/* ── TABELA ── */
function renderTable() {
  const todos=list(), filtrado=sortData(applyFilters(todos));
  document.getElementById("totalLanc").innerText=todos.length+" total";
  document.querySelectorAll("th.sortable").forEach(th=>{
    th.classList.remove("asc","desc");
    if(th.dataset.col===sortState.col) th.classList.add(sortState.dir);
  });
  if(!filtrado.length) {
    tbody.innerHTML=`<tr><td colspan="6"><div class="empty-state"><div class="es-icon">&#128193;</div><h3>${todos.length?"Nenhum resultado":"Nenhum lançamento cadastrado"}</h3><p>${todos.length?"Ajuste os filtros ou clique em Limpar.":"Use o botão \"Novo lançamento\" para começar."}</p></div></td></tr>`;
    document.getElementById("footerCount").innerText=""; document.getElementById("footerTotal").innerText=""; return;
  }
  let totEnt=0, totSai=0;
  tbody.innerHTML=filtrado.map(i=>{
    const isEnt=ehEntrada(i.tipo); isEnt?totEnt+=i.valor:totSai+=i.valor;
    return`<tr data-id="${i.id}">
      <td class="td-date" contenteditable data-f="data">${i.data||""}</td>
      <td class="td-cat"  contenteditable data-f="cat">${i.cat||""}</td>
      <td><span class="badge ${isEnt?"entrada":"saida"} btnTipo">${i.tipo}</span></td>
      <td class="td-value" contenteditable data-f="valor" style="color:var(${isEnt?"--ok":"--bad"})">${fmtMoney(i.valor)}</td>
      <td style="color:var(--text2);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" contenteditable data-f="obs">${i.obs||""}</td>
      <td><button class="btn-del del" title="Apagar">&#128465;</button></td>
    </tr>`;
  }).join("");
  const net=totEnt-totSai, corNet=net>=0?"var(--ok)":"var(--bad)";
  document.getElementById("footerCount").innerText=`${filtrado.length} lançamento${filtrado.length!==1?"s":""}`;
  document.getElementById("footerTotal").innerHTML=`Resultado filtrado: <span style="color:${corNet}">${fmtMoney(net)}</span>`;
}

/* ── KPIs ── */
function updateResumo() {
  const todos=list(); let e=0,s=0;
  todos.forEach(i=>ehEntrada(i.tipo)?e+=i.valor:s+=i.valor);
  const net=e-s, max=Math.max(e,s,1);
  sumEnt.innerText=fmtMoney(e); sumSai.innerText=fmtMoney(s);
  sumRes.innerText=fmtMoney(net); sumRes.style.color=net>=0?"var(--ok)":"var(--bad)";
  const qtdE=todos.filter(i=>ehEntrada(i.tipo)).length, qtdS=todos.filter(i=>ehSaida(i.tipo)).length;
  document.getElementById("sumEntQtd").innerText=qtdE+" lançamento"+(qtdE!==1?"s":"");
  document.getElementById("sumSaiQtd").innerText=qtdS+" lançamento"+(qtdS!==1?"s":"");
  document.getElementById("sumResPct").innerText=e>0?(net>=0?"+":"")+(net/e*100).toFixed(1)+"% das entradas":"—";
  barEnt.style.width=(e/max*100).toFixed(1)+"%";
  barSai.style.width=(s/max*100).toFixed(1)+"%";
  barRes.style.width=Math.min(100,Math.abs(net)/max*100).toFixed(1)+"%";
  barRes.style.background=net>=0?"var(--primary)":"var(--bad)";
  const datas=todos.map(i=>i.data).filter(Boolean).sort();
  document.getElementById("periodoLabel").innerText=datas.length?fmtDate(datas[0])+" — "+fmtDate(datas[datas.length-1]):"";
}

/* ── DADOS GRÁFICOS ── */
function buildMonthly(dados) {
  const map={};
  dados.forEach(i=>{ if(!i.data)return; const m=i.data.substring(0,7); if(!map[m])map[m]={ent:0,sai:0}; ehEntrada(i.tipo)?map[m].ent+=i.valor:map[m].sai+=i.valor; });
  const keys=Object.keys(map).sort();
  return { labels:keys.map(k=>{const[y,m]=k.split("-");return new Date(y,m-1).toLocaleDateString("pt-BR",{month:"short",year:"2-digit"});}), ent:keys.map(k=>+map[k].ent.toFixed(2)), sai:keys.map(k=>+map[k].sai.toFixed(2)) };
}
function buildSaldo(dados) {
  let acum=0; const labels=[],vals=[];
  [...dados].filter(i=>i.data).sort((a,b)=>a.data.localeCompare(b.data)).forEach(i=>{ acum+=ehEntrada(i.tipo)?i.valor:-i.valor; labels.push(fmtDate(i.data)); vals.push(+acum.toFixed(2)); });
  return {labels,vals};
}

/* ── GRÁFICOS ── */
const cssv = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

function applyChartConfig() {
  const cc=loadDB().chartConfig||{};
  ["pizza","evolucao","saldo","top"].forEach(k=>{
    document.getElementById("card-"+k)?.classList.toggle("chart-hidden",!cc[k]);
    const t=document.getElementById("tog-"+k); if(t) t.checked=!!cc[k];
  });
}

function renderDashboard() {
  const dados=list(), tc=cssv("--text2")||"#6b7280", gc=cssv("--card-border")||"#e2e5ef", cc=loadDB().chartConfig||{};
  const base={legend:{labels:{font:{family:"Inter",size:11},color:tc,boxWidth:10,padding:10}},tooltip:{bodyFont:{family:"Inter",size:12},callbacks:{label:ctx=>" "+fmtMoney(ctx.parsed.y??ctx.parsed??0)}}};

  ["pizza","evolucao","saldo","top"].forEach(k=>{ if(charts[k]){charts[k].destroy();delete charts[k];} });

  if(!dados.length) {
    ["txtPizza","txtEvolucao","txtSaldo","txtTop"].forEach(id=>{ const el=document.getElementById(id); if(el)el.innerText="Adicione lançamentos para ver os gráficos."; });
    return;
  }

  /* DONUT — gastos por categoria */
  if(cc.pizza) {
    const mapa={}; let totS=0;
    dados.forEach(i=>{ if(ehSaida(i.tipo)){const k=i.cat||"Outros"; mapa[k]=+((mapa[k]||0)+i.valor).toFixed(2); totS=+(totS+i.valor).toFixed(2);} });
    const catL=Object.keys(mapa).sort((a,b)=>mapa[b]-mapa[a]), catV=catL.map(k=>mapa[k]);
    charts.pizza=new Chart(chartPizza,{type:"doughnut",data:{labels:catL,datasets:[{data:catV,backgroundColor:PALETTE.slice(0,catL.length),borderWidth:2,borderColor:cssv("--card")||"#fff",hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:true,cutout:"65%",plugins:{...base,legend:{position:"bottom",labels:{...base.legend.labels,padding:8}},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${fmtMoney(ctx.parsed)} (${totS?(ctx.parsed/totS*100).toFixed(1):0}%)`}}}}});
    document.getElementById("txtPizza").innerText=catL[0]?`Maior gasto: ${catL[0]} — ${fmtMoney(mapa[catL[0]])}` :"";
  }

  /* LINHA — evolução mensal */
  if(cc.evolucao) {
    const m=buildMonthly(dados);
    charts.evolucao=new Chart(chartEvolucao,{type:"line",data:{labels:m.labels,datasets:[
      {label:"Entradas",data:m.ent,borderColor:"#059669",backgroundColor:"rgba(5,150,105,.07)",fill:true,tension:.38,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#059669",borderWidth:2},
      {label:"Saídas",  data:m.sai,borderColor:"#dc2626",backgroundColor:"rgba(220,38,38,.06)",fill:true,tension:.38,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#dc2626",borderWidth:2}
    ]},options:{responsive:true,maintainAspectRatio:true,interaction:{mode:"index",intersect:false},scales:{x:{grid:{color:gc},ticks:{color:tc,font:{family:"Inter",size:10}}},y:{grid:{color:gc},ticks:{color:tc,font:{family:"Inter",size:10},callback:v=>"R$"+(Math.abs(v)>=1000?(v/1000).toFixed(1)+"k":v)},beginAtZero:true}},plugins:{...base,legend:{position:"top",labels:{...base.legend.labels}},tooltip:{mode:"index",intersect:false,callbacks:{label:ctx=>` ${ctx.dataset.label}: ${fmtMoney(ctx.parsed.y)}`}}}}});
    document.getElementById("txtEvolucao").innerText=m.labels.length?`${m.labels.length} mês${m.labels.length!==1?"es":""} no período`:"";
  }

  /* LINHA — saldo acumulado */
  if(cc.saldo) {
    const sl=buildSaldo(dados), fv=sl.vals[sl.vals.length-1]??0, cor=fv>=0?"#4f46e5":"#dc2626";
    charts.saldo=new Chart(chartSaldo,{type:"line",data:{labels:sl.labels,datasets:[{label:"Saldo",data:sl.vals,borderColor:cor,backgroundColor:fv>=0?"rgba(79,70,229,.07)":"rgba(220,38,38,.07)",fill:true,tension:.3,pointRadius:0,pointHoverRadius:5,pointBackgroundColor:cor,borderWidth:2.5}]},options:{responsive:true,maintainAspectRatio:true,scales:{x:{grid:{display:false},ticks:{color:tc,font:{family:"Inter",size:9},maxTicksLimit:8}},y:{grid:{color:gc},ticks:{color:tc,font:{family:"Inter",size:9},callback:v=>"R$"+(Math.abs(v)>=1000?(v/1000).toFixed(1)+"k":v)}}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` Saldo: ${fmtMoney(ctx.parsed.y)}`}}}}});
    document.getElementById("txtSaldo").innerText=`Saldo atual: ${fmtMoney(fv)}`;
  }

  /* BARRAS — top gastos */
  if(cc.top) {
    const mapa2={};
    dados.forEach(i=>{ if(ehSaida(i.tipo)){const k=i.cat||"Outros"; mapa2[k]=+((mapa2[k]||0)+i.valor).toFixed(2);} });
    const topE=Object.entries(mapa2).sort((a,b)=>b[1]-a[1]).slice(0,7), topL=topE.map(e=>e[0]), topV=topE.map(e=>e[1]);
    charts.top=new Chart(chartTop,{type:"bar",data:{labels:topL,datasets:[{data:topV,backgroundColor:PALETTE.slice(0,topL.length).map(c=>c+"bb"),borderColor:PALETTE.slice(0,topL.length),borderWidth:2,borderRadius:{topRight:6,bottomRight:6}}]},options:{responsive:true,maintainAspectRatio:true,indexAxis:"y",scales:{x:{grid:{color:gc},ticks:{color:tc,font:{family:"Inter",size:10},callback:v=>"R$"+(v>=1000?(v/1000).toFixed(1)+"k":v)},beginAtZero:true},y:{grid:{display:false},ticks:{color:tc,font:{family:"Inter",size:11,weight:"600"}}}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${fmtMoney(ctx.parsed.x)}`}}}}});
    document.getElementById("txtTop").innerText=topL.length?`${topL.length} categoria${topL.length!==1?"s":""} com saídas`:"";
  }
}

/* ── REFRESH ── */
function refreshAll() { renderTable(); updateResumo(); renderProfileInfo(); renderDashboard(); atualizarConfPerfil(); applyChartConfig(); }

/* ── TOAST ── */
function showToast(msg, t="") {
  const el=document.createElement("div"); el.className="toast"; if(t==="err")el.style.background="var(--bad)";
  el.innerText=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2400);
}

/* ── MODAL / FORM ── */
const fecharModal = () => { modal.style.display="none"; };
modal.onclick = e => { if(e.target===modal) fecharModal(); };
novoLanc.onclick = () => { data.value=isoRef("today"); modal.style.display="flex"; };

form.onsubmit = e => {
  e.preventDefault();
  const v=parseMoney(valor.value);
  if(v===null){showToast("Valor inválido. Use: 1500 ou 1.500,00","err");return;}
  const db=loadDB();
  db.profiles[db.active].push({id:crypto.randomUUID(),data:data.value,cat:cat.value.trim(),tipo:tipo.value,valor:v,obs:obs.value.trim()});
  db.profiles[db.active].sort((a,b)=>(a.data||"").localeCompare(b.data||""));
  sortState={col:"data",dir:"asc"};
  saveDB(db); fecharModal(); form.reset(); refreshAll(); showToast("Lançamento adicionado!");
};

/* ── CLIQUES NA TABELA ── */
tbody.onclick = e => {
  const tr=e.target.closest("tr"); if(!tr||!tr.dataset.id) return;
  const db=loadDB(), item=db.profiles[db.active].find(i=>i.id===tr.dataset.id); if(!item) return;
  if(e.target.closest(".del")){
    if(confirm("Apagar este lançamento?")){db.profiles[db.active]=db.profiles[db.active].filter(i=>i.id!==item.id);saveDB(db);refreshAll();showToast("Lançamento removido");}
    return;
  }
  if(e.target.classList.contains("btnTipo")){item.tipo=ehEntrada(item.tipo)?"Saída":"Entrada";saveDB(db);refreshAll();}
};

tbody.addEventListener("blur", e => {
  const td=e.target; if(!td.dataset.f) return;
  const tr=td.closest("tr"), db=loadDB(), item=db.profiles[db.active].find(i=>i.id===tr.dataset.id); if(!item) return;
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{
    if(td.dataset.f==="valor"){
      const n=parseMoney(td.innerText);
      if(n===null){td.innerText=fmtMoney(item.valor);showToast("Valor inválido","err");return;}
      item.valor=n;
    } else if(td.dataset.f==="data"){
      let r=td.innerText.trim();
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(r)){const[d,m,y]=r.split("/");r=`${y}-${m}-${d}`;}
      item.data=r; db.profiles[db.active].sort((a,b)=>(a.data||"").localeCompare(b.data||""));
    } else { item[td.dataset.f]=td.innerText.trim(); }
    saveDB(db); refreshAll(); showToast("Alteração salva");
  },400);
},true);

/* ── ORDENAÇÃO ── */
document.querySelectorAll("th.sortable").forEach(th=>{
  th.onclick=()=>{
    const col=th.dataset.col;
    sortState.col===col?sortState.dir=sortState.dir==="asc"?"desc":"asc":(sortState={col,dir:col==="valor"?"desc":"asc"});
    renderTable();
  };
});

/* ── FILTROS ── */
fBusca.oninput    = () => { filterState.busca  =fBusca.value.trim(); renderTable(); };
fTipo.onchange    = () => { filterState.tipo   =fTipo.value;         renderTable(); };
fDataDe.onchange  = () => { filterState.dataDe =fDataDe.value;       renderTable(); clearQF(); };
fDataAte.onchange = () => { filterState.dataAte=fDataAte.value;      renderTable(); clearQF(); };
const clearQF = () => { document.querySelectorAll(".qf-btn").forEach(b=>b.classList.remove("active")); filterState.qf=""; };

clearFilter.onclick = () => {
  fBusca.value=fTipo.value=fDataDe.value=fDataAte.value="";
  filterState={busca:"",tipo:"",dataDe:"",dataAte:"",qf:""}; clearQF(); renderTable();
};

document.querySelectorAll(".qf-btn").forEach(btn=>{
  btn.onclick=()=>{
    const qf=btn.dataset.qf;
    if(filterState.qf===qf){filterState.qf=filterState.dataDe=filterState.dataAte="";fDataDe.value=fDataAte.value="";clearQF();}
    else {
      clearQF(); btn.classList.add("active"); filterState.qf=qf;
      const today=isoRef("today");
      const map={hoje:[today,today],semana:[isoRef("week"),today],mes:[isoRef("month"),today],tri:[isoRef("quarter"),today],ano:[isoRef("year"),today],tudo:["",""]};
      [filterState.dataDe,filterState.dataAte]=map[qf]||["",""];
      fDataDe.value=filterState.dataDe; fDataAte.value=filterState.dataAte;
    }
    renderTable();
  };
});

/* ── GRÁFICOS TOGGLES ── */
document.querySelectorAll(".switch input[data-chart]").forEach(tog=>{
  tog.onchange=()=>{
    const db=loadDB(); if(!db.chartConfig)db.chartConfig={};
    db.chartConfig[tog.dataset.chart]=tog.checked; saveDB(db);
    applyChartConfig(); renderDashboard();
    showToast((tog.checked?"Gráfico ativado":"Gráfico oculto")+": "+tog.dataset.chart);
  };
});

/* ── PERFIL ── */
perfilNome.onblur=perfilDoc.onblur=saveProfileInfo;
perfilSelect.onchange=e=>{const db=loadDB();db.active=e.target.value;saveDB(db);refreshAll();showToast("Perfil: "+e.target.value);};

function criarNovoPerfil(){
  const n=prompt("Nome do novo perfil:"); if(!n||!n.trim())return;
  const db=loadDB(); if(db.profiles[n]){showToast("Perfil já existe!","err");return;}
  db.profiles[n]=[]; db.profileInfo[n]={}; db.active=n; saveDB(db); renderPerfis(); refreshAll(); showToast("Perfil criado: "+n);
}
novoPerfil.onclick=document.getElementById("btnNovoPerfil2").onclick=criarNovoPerfil;

document.getElementById("btnRenamePerfil").onclick=()=>{
  const db=loadDB(), novo=prompt(`Novo nome para "${db.active}":`);
  if(!novo||!novo.trim()||novo===db.active)return;
  if(db.profiles[novo]){showToast("Nome já existe!","err");return;}
  db.profiles[novo]=db.profiles[db.active]; db.profileInfo[novo]=db.profileInfo[db.active]||{};
  delete db.profiles[db.active]; delete db.profileInfo[db.active]; db.active=novo;
  saveDB(db); renderPerfis(); refreshAll(); showToast("Renomeado para: "+novo);
};

document.getElementById("btnDeletePerfil").onclick=()=>{
  const db=loadDB();
  if(Object.keys(db.profiles).length<=1){showToast("Precisa ter pelo menos 1 perfil!","err");return;}
  if(!confirm(`Excluir "${db.active}" e todos os seus dados?`))return;
  delete db.profiles[db.active]; delete db.profileInfo[db.active];
  db.active=Object.keys(db.profiles)[0]; saveDB(db); renderPerfis(); refreshAll(); showToast("Perfil excluído");
};

document.getElementById("btnLimparPerfil").onclick=()=>{
  const db=loadDB();
  if(!confirm(`Limpar TODOS os lançamentos de "${db.active}"?`))return;
  if(!confirm("Ação irreversível. Continuar?"))return;
  db.profiles[db.active]=[]; saveDB(db); refreshAll(); showToast("Lançamentos apagados");
};

/* ── TABS ── */
document.querySelectorAll(".tabs button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active")); b.classList.add("active");
    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("tab-"+b.dataset.tab).classList.remove("hidden");
  };
});

/* ── IMPORT / EXPORT ── */
const abrirImport=()=>window.open("import.html?perfil="+encodeURIComponent(loadDB().active),"_blank");
const abrirExport=()=>window.open("export.html","_blank");
importar.onclick=abrirImport; exportarBtn.onclick=abrirExport;
exportAll.onclick=abrirExport; refreshBtn.onclick=()=>{refreshAll();showToast("Dados atualizados!");};

/* ── BACKUP ── */
document.getElementById("btnBackup").onclick=()=>{
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(loadDB(),null,2)],{type:"application/json"}));
  a.download="fluxopro_backup_"+Date.now()+".json"; a.click(); showToast("Backup exportado!");
};
document.getElementById("btnRestore").onclick=()=>restoreInput.click();
restoreInput.onchange=e=>{
  const file=e.target.files[0]; if(!file)return;
  const r=new FileReader(); r.onload=ev=>{
    try{const d=JSON.parse(ev.target.result); if(!d.profiles)throw new Error("Arquivo inválido"); if(!confirm("Substituir todos os dados pelo backup?"))return; localStorage.setItem(KEY,JSON.stringify(d));location.reload();}
    catch(err){showToast("Erro: "+err.message,"err");}
  }; r.readAsText(file); restoreInput.value="";
};

resetAll.onclick=()=>{if(confirm("Apagar TODOS os dados? Irreversível!"))if(confirm("Tem certeza absoluta?")){localStorage.removeItem(KEY);location.reload();}};

/* ── TEMAS ── */
function applyCustomColor(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  const h=c=>Math.round(c+(255-c)*.85).toString(16).padStart(2,"0"), d=c=>Math.round(c*.72).toString(16).padStart(2,"0");
  document.documentElement.style.setProperty("--primary",hex);
  document.documentElement.style.setProperty("--primary-l","#"+[r,g,b].map(h).join(""));
  document.documentElement.style.setProperty("--primary-d","#"+[r,g,b].map(d).join(""));
}
function setThemeLabel(t){
  const el=document.getElementById("themeLabel"), names={"":"Padrão",dark:"Dark",emerald:"Verde",gold:"Dourado",indigo:"Índigo",rose:"Rosa",custom:"Personalizado"};
  if(el) el.innerText="Tema atual: "+(names[t]??t);
}
function activateThemeBtn(t){
  document.querySelectorAll(".theme-btn").forEach(b=>b.classList.remove("active"));
  (t==="custom"?document.querySelector(".theme-custom"):document.querySelector(`.theme-btn[data-theme="${t}"]`))?.classList.add("active");
}
document.querySelectorAll(".theme-btn").forEach(btn=>{
  btn.onclick=()=>{
    const t=btn.dataset.theme; if(t==="custom")return;
    const db=loadDB(); db.theme=t; saveDB(db); activateThemeBtn(t);
    ["--primary","--primary-l","--primary-d"].forEach(v=>document.documentElement.style.removeProperty(v));
    themeCSS.href=t?"themes/"+t+".css":""; setThemeLabel(t); showToast("Tema: "+(t||"Padrão")); setTimeout(renderDashboard,80);
  };
});
colorPicker.oninput=e=>{
  const hex=e.target.value, db=loadDB(); db.customColor=hex; db.theme="custom"; saveDB(db);
  themeCSS.href=""; activateThemeBtn("custom"); applyCustomColor(hex); setThemeLabel("custom"); setTimeout(renderDashboard,80);
};
function loadTheme(){
  const db=loadDB(), t=db.theme||"";
  if(t==="custom"&&db.customColor){colorPicker.value=db.customColor;applyCustomColor(db.customColor);}
  else if(t) themeCSS.href="themes/"+t+".css";
  activateThemeBtn(t); setThemeLabel(t);
}

/* ── INIT ── */
(function(){
  const db=loadDB();
  if(!db.chartConfig){db.chartConfig={pizza:true,evolucao:true,saldo:true,top:true};saveDB(db);}
  loadTheme(); renderPerfis(); refreshAll();
})();
</script>
</body>
</html>
