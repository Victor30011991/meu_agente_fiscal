<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxoPro Brasil | Ultimate Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --danger: #ef4444;
            --bg: #f9fafb; --card: #ffffff; --text: #1f2937; --border: #e5e7eb;
        }
        /* --- TEMAS --- */
        [data-theme="midnight"] { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; --primary: #38bdf8; }
        [data-theme="emerald"] { --primary: #059669; --bg: #f0fdf4; --text: #064e3b; --card: #ffffff; }
        [data-theme="gold"] { --primary: #b45309; --bg: #fffbeb; --text: #78350f; --card: #ffffff; --border: #fde68a; }
        [data-theme="royal"] { --primary: #6d28d9; --bg: #f5f3ff; --text: #4c1d95; --card: #ffffff; }
        [data-theme="rose"] { --primary: #e11d48; --bg: #fff1f2; --text: #881337; --card: #ffffff; }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        .container { max-width: 1300px; margin: 0 auto; padding: 0 20px; }
        
        header { background: var(--card); border-bottom: 2px solid var(--primary); padding: 15px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-flex { display: flex; justify-content: space-between; align-items: center; }
        
        .profile-badge { background: var(--primary); color: white; padding: 8px 16px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .profile-badge select { background: none; border: none; color: white; font-weight: 800; cursor: pointer; outline: none; width: auto; }

        nav button { background: none; border: none; padding: 10px 18px; font-weight: 700; cursor: pointer; color: #6b7280; border-radius: 8px; transition: 0.2s; }
        nav button.active { color: var(--primary); background: rgba(79, 70, 229, 0.1); }

        main { padding: 30px 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease forwards; }

        .card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .grid-master { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }

        .table-wrap { overflow-x: auto; border-radius: 15px; border: 1px solid var(--border); background: var(--card); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: rgba(0,0,0,0.02); padding: 16px; text-align: left; font-size: 11px; color: #6b7280; text-transform: uppercase; }
        td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 14px; outline: none; }
        td[contenteditable="true"]:focus { background: rgba(79, 70, 229, 0.05); border-bottom: 2px solid var(--primary); }

        .btn { padding: 12px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-sec { background: var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; }

        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); box-sizing: border-box; margin-bottom: 15px; font-family: inherit; }
        
        .switch-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="container nav-flex">
        <div class="logo" style="font-weight: 900; font-size: 1.6rem; letter-spacing: -1px;">Fluxo<span style="color:var(--primary)">Pro</span></div>
        <div class="profile-badge">
            <select id="select-perfil"></select>
            <button id="btn-novo-perfil" title="Adicionar Perfil" style="background:rgba(255,255,255,0.2); border:none; color:white; border-radius:50%; width:28px; height:28px; cursor:pointer; font-weight:bold;">+</button>
        </div>
        <nav>
            <button data-tab="list" class="nav-btn active">Lan√ßamentos</button>
            <button data-tab="dash" class="nav-btn">Analytics</button>
            <button data-tab="config" class="nav-btn">Configura√ß√µes</button>
        </nav>
    </div>
</header>

<main class="container">
    <section id="aba-list" class="tab-content active">
        <div style="display: flex; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
            <button class="btn btn-main" id="btn-abrir-modal"><b>+</b> Novo Lan√ßamento</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-sec" id="btn-export-perfil">üì• Exportar Excel</button>
                <button class="btn btn-danger" id="btn-limpar-perfil">üóëÔ∏è Perfil</button>
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="corpo-tabela"></tbody>
            </table>
        </div>
        <p style="font-size: 11px; opacity: 0.6; margin-top: 10px;">* Clique nos campos de texto para editar e pressione Enter ou clique fora para salvar.</p>
    </section>

    <section id="aba-dash" class="tab-content">
        <div id="dash-grid" class="grid-master">
            <div class="card"><h3>üçï Gastos por Categoria</h3><div style="height:320px"><canvas id="chartPizza"></canvas></div></div>
            <div class="card"><h3>üìä Entradas Mensais</h3><div style="height:320px"><canvas id="chartBarras"></canvas></div></div>
        </div>
    </section>

    <section id="aba-config" class="tab-content">
        <div class="grid-master">
            <div class="card">
                <h3>‚öôÔ∏è Prefer√™ncias de Exibi√ß√£o</h3>
                <div class="switch-group">
                    <span>Modo Privacidade (Ocultar Valores)</span>
                    <input type="checkbox" id="cfg-privacidade" style="width: 40px; margin: 0;">
                </div>
                <label style="font-size: 12px; font-weight: bold;">Moeda Padr√£o</label>
                <select id="cfg-moeda">
                    <option value="BRL">Real (R$)</option>
                    <option value="USD">D√≥lar (US$)</option>
                    <option value="EUR">Euro (‚Ç¨)</option>
                </select>
                <label style="font-size: 12px; font-weight: bold;">Tema Visual</label>
                <select id="tema-seletor">
                    <option value="default">Indigo Light</option>
                    <option value="midnight">Midnight Dark</option>
                    <option value="emerald">Emerald Green</option>
                    <option value="gold">Executive Gold</option>
                    <option value="royal">Royal Purple</option>
                    <option value="rose">Rose Premium</option>
                </select>
            </div>

            <div class="card">
                <h3>üìÇ Dados & Seguran√ßa</h3>
                <input type="file" id="input-arquivo" accept=".xlsx, .json" style="margin-top: 10px;">
                <button class="btn btn-main" style="width:100%" id="btn-processar">Importar Arquivo</button>
                <hr style="margin: 20px 0; opacity: 0.1;">
                <button class="btn btn-danger" style="width:100%" id="btn-reset-total">‚ö†Ô∏è Reset de F√°brica (Apagar Tudo)</button>
            </div>
        </div>
    </section>
</main>

<div class="modal" id="modalAdd">
    <div class="modal-content">
        <h3>Lan√ßamento Manual</h3>
        <form id="form-registro">
            <input type="date" id="f-data" required>
            <input type="text" id="f-cat" placeholder="Categoria" required>
            <select id="f-tipo"><option value="Entrada">Entrada (+)</option><option value="Sa√≠da" selected>Sa√≠da (-)</option></select>
            <input type="text" id="f-valor" placeholder="Valor (ex: 1.250,00)" required>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-sec" style="flex:1" id="btn-fechar-modal">Voltar</button>
                <button type="submit" class="btn btn-main" style="flex:1">Gravar</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const FluxoPro = (() => {
    let state = {
        db: JSON.parse(localStorage.getItem('fpro_db_v10')) || [],
        perfis: JSON.parse(localStorage.getItem('fpro_perfs_v10')) || ["Geral"],
        perfilAtivo: localStorage.getItem('fpro_ativo_v10') || "Geral",
        config: JSON.parse(localStorage.getItem('fpro_cfg_v10')) || { 
            tema: 'default', 
            privacidade: false,
            moeda: 'BRL'
        }
    };

    const chartRefs = {};

    const Utils = {
        cleanVal: (v) => {
            if (typeof v === 'number') return v;
            let n = String(v).replace(/[^\d,-]/g, '').replace(',', '.');
            return parseFloat(n) || 0;
        },
        formatCur: (v) => {
            if(state.config.privacidade) return 'R$ ****';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: state.config.moeda }).format(v);
        },
        uuid: () => Math.random().toString(36).substr(2, 9)
    };

    const UI = {
        renderTable() {
            const corpo = document.getElementById('corpo-tabela');
            const filtrados = state.db
                .filter(i => i.perfil === state.perfilAtivo)
                .sort((a, b) => new Date(b.data) - new Date(a.data));

            corpo.innerHTML = filtrados.map(item => `
                <tr data-id="${item.id}">
                    <td contenteditable="true" onblur="FluxoPro.editInline('${item.id}', 'data', this.innerText)">${item.data}</td>
                    <td contenteditable="true" onblur="FluxoPro.editInline('${item.id}', 'cat', this.innerText)">${item.cat}</td>
                    <td style="color:${item.tipo === 'Entrada' ? 'var(--success)' : 'var(--danger)'}; font-weight:800">${item.tipo}</td>
                    <td contenteditable="true" onblur="FluxoPro.editInline('${item.id}', 'valor', this.innerText)" style="font-weight:600">
                        ${Utils.formatCur(item.valor)}
                    </td>
                    <td><button onclick="FluxoPro.deleteEntry('${item.id}')" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button></td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center; padding:40px;">Sem dados.</td></tr>';
        },

        renderCharts() {
            const dados = state.db.filter(i => i.perfil === state.perfilAtivo);
            const gastos = dados.filter(i => i.tipo === 'Sa√≠da');
            const catMap = {};
            gastos.forEach(g => catMap[g.cat] = (catMap[g.cat] || 0) + g.valor);
            this.draw('chartPizza', 'doughnut', Object.keys(catMap), Object.values(catMap));

            const mesesDados = Array(12).fill(0);
            dados.filter(i => i.tipo === 'Entrada').forEach(g => {
                const m = new Date(g.data).getUTCMonth();
                mesesDados[m] += g.valor;
            });
            this.draw('chartBarras', 'bar', ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], mesesDados);
        },

        draw(id, type, labels, data) {
            if (chartRefs[id]) chartRefs[id].destroy();
            const el = document.getElementById(id);
            if (!el) return;
            chartRefs[id] = new Chart(el.getContext('2d'), {
                type: type,
                data: { labels, datasets: [{ data, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    };

    return {
        init() {
            this.applyTheme(state.config.tema);
            document.getElementById('cfg-privacidade').checked = state.config.privacidade;
            document.getElementById('cfg-moeda').value = state.config.moeda;
            document.getElementById('tema-seletor').value = state.config.tema;
            this.refreshProfiles();
            UI.renderTable();
            this.bind();
        },

        bind() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.nav-btn, .tab-content').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`aba-${btn.dataset.tab}`).classList.add('active');
                    if (btn.dataset.tab === 'dash') UI.renderCharts();
                };
            });

            document.getElementById('form-registro').onsubmit = (e) => {
                e.preventDefault();
                state.db.push({
                    id: Utils.uuid(), perfil: state.perfilAtivo,
                    data: document.getElementById('f-data').value,
                    cat: document.getElementById('f-cat').value,
                    tipo: document.getElementById('f-tipo').value,
                    valor: Utils.cleanVal(document.getElementById('f-valor').value)
                });
                this.sync(); this.closeModal(); e.target.reset();
            };

            document.getElementById('tema-seletor').onchange = (e) => this.applyTheme(e.target.value);
            document.getElementById('cfg-privacidade').onchange = (e) => { state.config.privacidade = e.target.checked; this.sync(); };
            document.getElementById('cfg-moeda').onchange = (e) => { state.config.moeda = e.target.value; this.sync(); };
            document.getElementById('btn-reset-total').onclick = () => { if(confirm("APAGAR TUDO?")) { localStorage.clear(); location.reload(); }};
            document.getElementById('btn-export-perfil').onclick = () => this.export();
            document.getElementById('btn-abrir-modal').onclick = () => document.getElementById('modalAdd').style.display='flex';
            document.getElementById('btn-fechar-modal').onclick = this.closeModal;
            document.getElementById('select-perfil').onchange = (e) => { state.perfilAtivo = e.target.value; this.sync(); };
            document.getElementById('btn-novo-perfil').onclick = () => {
                const n = prompt("Novo Perfil:");
                if(n) { state.perfis.push(n); state.perfilAtivo = n; this.refreshProfiles(); this.sync(); }
            };
            document.getElementById('btn-processar').onclick = () => this.import();
            document.getElementById('btn-limpar-perfil').onclick = () => {
                if(confirm("Limpar este perfil?")) { state.db = state.db.filter(i => i.perfil !== state.perfilAtivo); this.sync(); }
            };
        },

        editInline(id, field, val) {
            const idx = state.db.findIndex(i => i.id === id);
            if(idx !== -1) {
                if(field === 'valor') state.db[idx][field] = Utils.cleanVal(val);
                else state.db[idx][field] = val;
                this.sync();
            }
        },

        sync() {
            localStorage.setItem('fpro_db_v10', JSON.stringify(state.db));
            localStorage.setItem('fpro_perfs_v10', JSON.stringify(state.perfis));
            localStorage.setItem('fpro_ativo_v10', state.perfilAtivo);
            localStorage.setItem('fpro_cfg_v10', JSON.stringify(state.config));
            UI.renderTable();
            if(document.getElementById('aba-dash').classList.contains('active')) UI.renderCharts();
        },

        refreshProfiles() {
            document.getElementById('select-perfil').innerHTML = state.perfis.map(p => `<option value="${p}" ${p === state.perfilAtivo ? 'selected' : ''}>${p}</option>`).join('');
        },

        applyTheme(t) { document.body.setAttribute('data-theme', t); state.config.tema = t; this.sync(); },
        closeModal() { document.getElementById('modalAdd').style.display='none'; },
        deleteEntry(id) { state.db = state.db.filter(i => i.id !== id); this.sync(); },
        
        export() {
            const ws = XLSX.utils.json_to_sheet(state.db.filter(i => i.perfil === state.perfilAtivo));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, `FluxoPro_${state.perfilAtivo}.xlsx`);
        },

        import() {
            const file = document.getElementById('input-arquivo').files[0];
            if(!file) return alert("Selecione um arquivo");
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type: 'binary'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                state.db = [...state.db, ...json.map(r => ({
                    id: Utils.uuid(), perfil: state.perfilAtivo,
                    data: r.Data || new Date().toISOString().split('T')[0],
                    cat: r.Categoria || 'Importado',
                    tipo: String(r.Tipo).includes('Entrada') ? 'Entrada' : 'Sa√≠da',
                    valor: Utils.cleanVal(r.Valor || 0)
                }))];
                this.sync(); alert("Sucesso!");
            };
            reader.readAsBinaryString(file);
        }
    };
})();

window.onload = () => FluxoPro.init();
</script>
</body>
</html>
