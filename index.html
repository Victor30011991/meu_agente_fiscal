<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v11</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --primary:#4f46e5;
  --success:#10b981;
  --danger:#ef4444;
  --text:#0f172a;
}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:var(--text);
}

header{
  background:#fff;
  padding:14px 24px;
  display:flex;
  align-items:center;
  gap:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}

header h1{
  font-size:20px;
  margin:0;
  flex:1;
}

nav button{
  border:0;
  padding:8px 14px;
  border-radius:12px;
  background:#eee;
  cursor:pointer;
  font-weight:600;
}

nav button.active{
  background:var(--primary);
  color:#fff;
}

main{
  padding:22px;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  margin-bottom:20px;
}

.flex{
  display:flex;
  gap:18px;
  flex-wrap:wrap;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}

td[contenteditable]{
  background:#fafafa;
  border-radius:6px;
}

.badge{
  padding:5px 10px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
  display:inline-block;
}

.entrada{background:#dcfce7;color:#047857;}
.saida{background:#fee2e2;color:#991b1b;}

button.primary{
  background:var(--primary);
  color:#fff;
  border:0;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
}

button.light{
  background:#eee;
  border:0;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
}

input,select{
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
}

.hidden{display:none}

.summary{
  display:flex;
  gap:18px;
}

.summary .box{
  flex:1;
  background:#f8fafc;
  border-radius:12px;
  padding:14px;
}
</style>
</head>
<body>

<header>
  <h1>FluxoPro Engine v11</h1>

  <select id="perfilSelect"></select>
  <button id="novoPerfil">+</button>

  <nav>
    <button data-tab="lanc" class="active">Lan√ßamentos</button>
    <button data-tab="dash">Dashboard</button>
    <button data-tab="cfg">Configura√ß√µes</button>
  </nav>
</header>

<main>

<!-- ================= LANCAMENTOS ================= -->

<section id="tab-lanc">

<div class="card flex">
  <button class="primary" id="addLinha">Novo lan√ßamento</button>

  <input type="file" id="fileInput">
  <button class="light" id="importar">Alimentar perfil</button>
</div>

<div class="card">

<table>
<thead>
<tr>
<th>Pessoa</th>
<th>Data</th>
<th>Categoria</th>
<th>Tipo</th>
<th>Valor</th>
<th>Observa√ß√£o</th>
<th>Editar</th>
<th>Apagar</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<div class="card summary">
  <div class="box">Entradas: <strong id="sumEnt">R$ 0,00</strong></div>
  <div class="box">Sa√≠das: <strong id="sumSai">R$ 0,00</strong></div>
  <div class="box">Diferen√ßa: <strong id="sumRes">R$ 0,00</strong></div>
</div>

</section>

<!-- ================= DASHBOARD ================= -->

<section id="tab-dash" class="hidden">

<div class="card flex">

<div style="flex:1">
<h4>Distribui√ß√£o por categoria</h4>
<canvas id="chartPizza"></canvas>
<p id="resumoPizza"></p>
</div>

<div style="flex:1">
<h4>Entradas x Sa√≠das (%)</h4>
<canvas id="chartPercentual"></canvas>
<p id="resumoPercentual"></p>
</div>

<div style="flex:1">
<h4>Resumo financeiro</h4>
<canvas id="chartResumo"></canvas>
<p id="resumoResumo"></p>
</div>

</div>

</section>

<!-- ================= CONFIG ================= -->

<section id="tab-cfg" class="hidden">

<div class="card">
<h3>Painel de controle</h3>

<button class="light" id="backup">Backup Excel (todos perfis)</button>
<button class="light" id="reset">Reset de f√°brica</button>

</div>

</section>

</main>

<script>
const DB_KEY="fluxopro_v11";

let charts={};

function loadDB(){
  return JSON.parse(localStorage.getItem(DB_KEY)) || {
    profiles:{},
    active:null
  };
}

function saveDB(db){
  localStorage.setItem(DB_KEY,JSON.stringify(db));
}

function currentProfile(){
  const db=loadDB();
  return db.active;
}

/* ---------------- NORMALIZA√á√ÉO ---------------- */

function normalizeValue(v){
  if(typeof v==="number") return v;

  let s=String(v).replace(/[^\d,.-]/g,"");

  if(s.indexOf(",")>-1 && s.indexOf(".")>-1){
    if(s.lastIndexOf(",")>s.lastIndexOf(".")){
      s=s.replace(/\./g,"").replace(",",".");
    }else{
      s=s.replace(/,/g,"");
    }
  }else{
    s=s.replace(",",".");
  }

  let n=parseFloat(s);
  return isNaN(n)?null:n;
}

/* ---------------- PERFIS ---------------- */

function renderPerfis(){
  const db=loadDB();
  const sel=document.getElementById("perfilSelect");

  sel.innerHTML=Object.keys(db.profiles)
    .map(p=>`<option ${p===db.active?"selected":""}>${p}</option>`).join("");
}

document.getElementById("novoPerfil").onclick=()=>{
  const n=prompt("Nome do perfil (CPF/CNPJ/Pessoa)");
  if(!n) return;

  const db=loadDB();
  db.profiles[n]=[];
  db.active=n;
  saveDB(db);
  renderPerfis();
  renderTable();
  renderDashboard();
};

document.getElementById("perfilSelect").onchange=e=>{
  const db=loadDB();
  db.active=e.target.value;
  saveDB(db);
  renderTable();
  renderDashboard();
};

/* ---------------- TABELA ---------------- */

function renderTable(){
  const db=loadDB();
  const list=db.profiles[db.active]||[];
  const tbody=document.getElementById("tbody");

  let ent=0,sai=0;

  let html="";

  list.forEach(l=>{
    const v=l.valor||0;
    if(l.tipo==="Entrada") ent+=v; else sai+=v;

    html+=`
<tr data-id="${l.id}">
<td contenteditable data-f="pessoa">${l.pessoa||""}</td>
<td contenteditable data-f="data">${l.data||""}</td>
<td contenteditable data-f="categoria">${l.categoria||""}</td>
<td><span class="badge ${l.tipo==="Entrada"?"entrada":"saida"}">${l.tipo}</span></td>
<td contenteditable data-f="valor">${formatMoney(l.valor)}</td>
<td contenteditable data-f="obs">${l.obs||""}</td>
<td><button class="light editTipo">Trocar</button></td>
<td><button class="light del">üóë</button></td>
</tr>`;
  });

  tbody.innerHTML=html;

  document.getElementById("sumEnt").innerText=formatMoney(ent);
  document.getElementById("sumSai").innerText=formatMoney(sai);
  document.getElementById("sumRes").innerText=formatMoney(ent-sai);
}

function formatMoney(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

document.getElementById("tbody").addEventListener("click",e=>{
  const tr=e.target.closest("tr");
  if(!tr) return;

  const id=tr.dataset.id;
  const db=loadDB();
  const list=db.profiles[db.active];

  const item=list.find(i=>i.id===id);

  if(e.target.classList.contains("del")){
    db.profiles[db.active]=list.filter(i=>i.id!==id);
  }

  if(e.target.classList.contains("editTipo")){
    item.tipo=item.tipo==="Entrada"?"Sa√≠da":"Entrada";
  }

  saveDB(db);
  renderTable();
  renderDashboard();
});

document.getElementById("tbody").addEventListener("blur",e=>{
  const td=e.target;
  const tr=td.closest("tr");
  if(!td.dataset.f) return;

  const db=loadDB();
  const item=db.profiles[db.active].find(i=>i.id===tr.dataset.id);

  if(td.dataset.f==="valor"){
    const n=normalizeValue(td.innerText);
    if(n===null){
      renderTable();
      return;
    }
    item.valor=n;
  }else{
    item[td.dataset.f]=td.innerText;
  }

  saveDB(db);
  renderTable();
  renderDashboard();

},true);

/* ---------------- NOVO ---------------- */

document.getElementById("addLinha").onclick=()=>{
  const db=loadDB();
  db.profiles[db.active].push({
    id:crypto.randomUUID(),
    pessoa:"",
    data:"",
    categoria:"",
    tipo:"Entrada",
    valor:0,
    obs:""
  });
  saveDB(db);
  renderTable();
};

/* ---------------- IMPORTA√á√ÉO ---------------- */

document.getElementById("importar").onclick=()=>{
  const file=document.getElementById("fileInput").files[0];
  if(!file) return;

  const db=loadDB();
  const list=db.profiles[db.active];

  if(file.name.endsWith(".json")){
    const fr=new FileReader();
    fr.onload=()=>{
      const arr=JSON.parse(fr.result);
      arr.forEach(l=>{
        list.push({
          id:crypto.randomUUID(),
          pessoa:l.Pessoa||"",
          data:l.Data||"",
          categoria:l.Categoria||"",
          tipo:l.Tipo||"Entrada",
          valor:normalizeValue(l.Valor)||0,
          obs:l.Observacao||""
        });
      });
      saveDB(db);
      renderTable();
      renderDashboard();
    };
    fr.readAsText(file);
  }else{
    const fr=new FileReader();
    fr.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:"binary"});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws);

      rows.forEach(r=>{
        list.push({
          id:crypto.randomUUID(),
          pessoa:r.Pessoa||"",
          data:r.Data||"",
          categoria:r.Categoria||"",
          tipo:r.Tipo||"Entrada",
          valor:normalizeValue(r.Valor)||0,
          obs:r.Observacao||""
        });
      });

      saveDB(db);
      renderTable();
      renderDashboard();
    };
    fr.readAsBinaryString(file);
  }
};

/* ---------------- DASHBOARD ---------------- */

function renderDashboard(){
  const db=loadDB();
  const list=db.profiles[db.active]||[];

  let ent=0,sai=0;
  let cat={};

  list.forEach(l=>{
    const v=l.valor||0;
    if(l.tipo==="Entrada") ent+=v; else sai+=v;

    if(l.tipo==="Sa√≠da"){
      cat[l.categoria||"Sem categoria"]=(cat[l.categoria||"Sem categoria"]||0)+v;
    }
  });

  if(charts.pizza) charts.pizza.destroy();
  if(charts.perc) charts.perc.destroy();
  if(charts.res) charts.res.destroy();

  charts.pizza=new Chart(chartPizza,{
    type:"pie",
    data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat)}]}
  });

  document.getElementById("resumoPizza").innerText=
    "Categorias: "+Object.keys(cat).length;

  charts.perc=new Chart(chartPercentual,{
    type:"doughnut",
    data:{labels:["Entradas","Sa√≠das"],datasets:[{data:[ent,sai]}]}
  });

  const t=ent+sai;
  document.getElementById("resumoPercentual").innerText=
    t?`Entradas ${(ent/t*100).toFixed(1)}% | Sa√≠das ${(sai/t*100).toFixed(1)}%`:"Sem dados";

  charts.res=new Chart(chartResumo,{
    type:"bar",
    data:{labels:["Entradas","Sa√≠das","Resultado"],datasets:[{data:[ent,sai,ent-sai]}]}
  });

  document.getElementById("resumoResumo").innerText=
    ent-sai>=0?"Saldo positivo.":"Saldo negativo.";
}

/* ---------------- CONFIG ---------------- */

document.getElementById("backup").onclick=()=>{
  const db=loadDB();
  let rows=[];

  Object.entries(db.profiles).forEach(([p,arr])=>{
    arr.forEach(l=>{
      rows.push({...l,perfil:p});
    });
  });

  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"DB");
  XLSX.writeFile(wb,"fluxopro_backup.xlsx");
};

document.getElementById("reset").onclick=()=>{
  if(confirm("Apagar todo o banco de dados?")){
    localStorage.removeItem(DB_KEY);
    location.reload();
  }
};

/* ---------------- SPA ---------------- */

document.querySelectorAll("nav button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("nav button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");

    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("tab-"+b.dataset.tab).classList.remove("hidden");

    if(b.dataset.tab==="dash") renderDashboard();
  };
});

/* ---------------- INIT ---------------- */

(function(){
  const db=loadDB();
  if(!db.active){
    const p="Principal";
    db.profiles[p]=[];
    db.active=p;
    saveDB(db);
  }

  renderPerfis();
  renderTable();
  renderDashboard();
})();
</script>

</body>
</html>
