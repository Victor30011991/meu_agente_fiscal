<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v11</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#1f2937;
  --primary:#4f46e5;
  --success:#10b981;
  --danger:#ef4444;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}

[data-theme="dark"]{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f8fafc;
  --border:#334155;
  --primary:#38bdf8;
}

[data-theme="gold"]{--primary:#b45309;}
[data-theme="emerald"]{--primary:#059669;}
[data-theme="indigo"]{--primary:#4f46e5;}
[data-theme="rose"]{--primary:#e11d48;}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  position:sticky;top:0;
  background:var(--card);
  box-shadow:var(--shadow);
  z-index:10;
}

.top{
  max-width:1200px;
  margin:auto;
  padding:12px 20px;
  display:flex;
  gap:15px;
  align-items:center;
  justify-content:space-between;
}

.logo{
  font-weight:800;
  font-size:20px;
}

select,button,input{
  font-family:inherit;
}

main{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
}

.card{
  background:var(--card);
  border-radius:16px;
  padding:18px;
  box-shadow:var(--shadow);
}

h3{margin-top:0}

.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

button{
  border:none;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.primary{background:var(--primary);color:white;}
.sec{background:#e5e7eb;}

table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}

td[contenteditable]{
  outline:none;
}

.badge-in{color:var(--success);font-weight:700}
.badge-out{color:var(--danger);font-weight:700}

.tabs button.active{
  background:var(--primary);
  color:white;
}

.hidden{display:none}

.health{
  font-size:14px;
  line-height:1.4;
}
</style>
</head>
<body data-theme="indigo">

<header>
  <div class="top">
    <div class="logo">FluxoPro Engine v11</div>

    <div>
      <select id="perfilSelect"></select>
      <button id="novoPerfil">+</button>
    </div>

    <div class="tabs">
      <button data-tab="lanc" class="active">Lan√ßamentos</button>
      <button data-tab="dash">Dashboard</button>
      <button data-tab="cfg">Configura√ß√µes</button>
    </div>
  </div>
</header>

<main>

<section id="tab-lanc">

<div class="toolbar">
  <button class="primary" id="btnNovo">Novo lan√ßamento</button>
  <input type="file" id="fileInput">
  <button class="sec" id="btnImport">Alimentar perfil</button>
</div>

<table>
<thead>
<tr>
<th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</section>

<section id="tab-dash" class="hidden">

<div class="grid">
  <div class="card">
    <h3>Resumo</h3>
    <div>Entradas: <b id="rEnt"></b></div>
    <div>Sa√≠das: <b id="rSai"></b></div>
    <div>Saldo: <b id="rSaldo"></b></div>
  </div>

  <div class="card">
    <h3>Sa√∫de financeira</h3>
    <div id="healthText" class="health"></div>
  </div>

  <div class="card">
    <canvas id="pizza"></canvas>
  </div>

  <div class="card">
    <canvas id="barras"></canvas>
  </div>
</div>

</section>

<section id="tab-cfg" class="hidden">

<div class="grid">
  <div class="card">
    <h3>Tema</h3>
    <select id="temaSel">
      <option value="indigo">Indigo</option>
      <option value="dark">Dark</option>
      <option value="gold">Gold</option>
      <option value="emerald">Emerald</option>
      <option value="rose">Rose</option>
    </select>
  </div>

  <div class="card">
    <h3>Banco global</h3>
    <button id="backup" class="primary">Backup Excel</button>
    <button id="reset" class="sec">Reset de f√°brica</button>
  </div>
</div>

</section>

</main>

<script>
const FluxoPro = (()=>{

const KEYS={
  db:'fpro_v11_db',
  perfis:'fpro_v11_perfis',
  ativo:'fpro_v11_ativo',
  cfg:'fpro_v11_cfg'
};

const state={
  db:JSON.parse(localStorage.getItem(KEYS.db))||[],
  perfis:JSON.parse(localStorage.getItem(KEYS.perfis))||[],
  ativo:localStorage.getItem(KEYS.ativo)||'',
  cfg:JSON.parse(localStorage.getItem(KEYS.cfg))||{tema:'indigo'}
};

if(!state.ativo && state.perfis.length)
  state.ativo=state.perfis[0];

let chartPizza, chartBarras;

/* ===================== utils ====================== */

function uuid(){
  return crypto.randomUUID();
}

function normalize(v){
  if(typeof v==='number') return v;

  let s=String(v).trim();

  s=s.replace(/[R$\s]/g,'');
  if(s.includes('.') && s.includes(',')){
    if(s.lastIndexOf(',')>s.lastIndexOf('.')){
      s=s.replace(/\./g,'').replace(',','.');
    }else{
      s=s.replace(/,/g,'');
    }
  }else if(s.includes(',')){
    s=s.replace(',','.');
  }

  const n=parseFloat(s);
  return isNaN(n)?null:n;
}

function money(v){
  return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
}

function save(){
  localStorage.setItem(KEYS.db,JSON.stringify(state.db));
  localStorage.setItem(KEYS.perfis,JSON.stringify(state.perfis));
  localStorage.setItem(KEYS.ativo,state.ativo);
  localStorage.setItem(KEYS.cfg,JSON.stringify(state.cfg));
}

/* ===================== dados ====================== */

function list(){
  return state.db.filter(l=>l.perfil===state.ativo)
    .sort((a,b)=>new Date(b.data)-new Date(a.data));
}

/* ===================== UI ====================== */

const tbody=document.getElementById('tbody');

function renderTable(){
  const dados=list();
  if(!dados.length){
    tbody.innerHTML='<tr><td colspan="5">Sem dados</td></tr>';
    return;
  }

  let html='';
  for(const l of dados){
    html+=`
    <tr data-id="${l.id}">
      <td contenteditable data-f="data">${l.data}</td>
      <td contenteditable data-f="cat">${l.cat}</td>
      <td><button class="tipo ${l.tipo==='Entrada'?'badge-in':'badge-out'}">${l.tipo}</button></td>
      <td contenteditable data-f="valor">${money(l.valor)}</td>
      <td><button class="del">üóëÔ∏è</button></td>
    </tr>`;
  }
  tbody.innerHTML=html;
}

function renderResumo(){
  let ent=0,sai=0;
  list().forEach(l=>{
    if(l.tipo==='Entrada') ent+=l.valor;
    else sai+=l.valor;
  });

  const saldo=ent-sai;

  rEnt.textContent=money(ent);
  rSai.textContent=money(sai);
  rSaldo.textContent=money(saldo);
  rSaldo.style.color=saldo<0?'var(--danger)':'var(--success)';

  renderHealth(ent,sai);
}

function renderHealth(ent,sai){
  let txt='';
  if(ent===0 && sai===0){
    txt='Sem dados suficientes para an√°lise.';
  }else{
    const p=sai/(ent||1)*100;

    if(p<60){
      txt='Situa√ß√£o saud√°vel. Seus gastos est√£o bem controlados.';
    }else if(p<85){
      txt='Aten√ß√£o: seus gastos est√£o se aproximando da sua renda.';
    }else{
      txt='Risco financeiro. Suas sa√≠das est√£o comprometendo sua renda.';
    }

    txt+=`<br><small>Comprometimento: ${p.toFixed(1)}%</small>`;
  }
  healthText.innerHTML=txt;
}

function renderCharts(){
  const dados=list();

  const map={};
  dados.filter(l=>l.tipo==='Sa√≠da')
    .forEach(l=>map[l.cat]=(map[l.cat]||0)+l.valor);

  const labels=Object.keys(map);
  const values=Object.values(map);

  if(chartPizza) chartPizza.destroy();
  chartPizza=new Chart(pizza,{
    type:'doughnut',
    data:{labels,datasets:[{data:values}]},
    options:{responsive:true}
  });

  const meses=Array(12).fill(0);
  dados.filter(l=>l.tipo==='Entrada')
    .forEach(l=>{
      const m=new Date(l.data).getMonth();
      meses[m]+=l.valor;
    });

  if(chartBarras) chartBarras.destroy();
  chartBarras=new Chart(barras,{
    type:'bar',
    data:{
      labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
      datasets:[{data:meses}]
    },
    options:{responsive:true}
  });
}

function renderPerfis(){
  perfilSelect.innerHTML=state.perfis
    .map(p=>`<option ${p===state.ativo?'selected':''}>${p}</option>`).join('');
}

/* ===================== eventos ====================== */

tbody.addEventListener('click',e=>{
  const tr=e.target.closest('tr');
  if(!tr) return;
  const id=tr.dataset.id;

  if(e.target.classList.contains('del')){
    state.db=state.db.filter(l=>l.id!==id);
    save();
    refresh();
  }

  if(e.target.classList.contains('tipo')){
    const l=state.db.find(l=>l.id===id);
    l.tipo=l.tipo==='Entrada'?'Sa√≠da':'Entrada';
    save();
    refresh();
  }
});

tbody.addEventListener('blur',e=>{
  const td=e.target;
  if(!td.dataset.f) return;
  const tr=td.closest('tr');
  const l=state.db.find(l=>l.id===tr.dataset.id);

  if(td.dataset.f==='valor'){
    const n=normalize(td.innerText);
    if(n===null){
      td.innerText=money(l.valor);
      return;
    }
    l.valor=n;
  }else{
    l[td.dataset.f]=td.innerText.trim();
  }

  save();
  refresh(false);

},true);

btnNovo.onclick=()=>{
  if(!state.ativo){
    alert('Crie um perfil primeiro.');
    return;
  }

  state.db.push({
    id:uuid(),
    perfil:state.ativo,
    data:new Date().toISOString().slice(0,10),
    cat:'',
    tipo:'Entrada',
    valor:0
  });

  save();
  refresh();
};

perfilSelect.onchange=e=>{
  state.ativo=e.target.value;
  save();
  refresh();
};

novoPerfil.onclick=()=>{
  const n=prompt('Nome do perfil');
  if(!n) return;
  state.perfis.push(n);
  state.ativo=n;
  save();
  renderPerfis();
  refresh();
};

btnImport.onclick=importFile;

async function importFile(){
  const f=fileInput.files[0];
  if(!f) return;

  if(f.name.endsWith('.json')){
    const arr=JSON.parse(await f.text());
    absorb(arr);
  }else{
    const buf=await f.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws);
    absorb(arr);
  }
}

function absorb(arr){
  const mapCol=o=>({
    data:o.Data||o.data||o.DATA,
    cat:o.Categoria||o.categoria,
    tipo:o.Tipo||o.tipo,
    valor:o.Valor||o.valor
  });

  const batch=[];

  for(const r of arr){
    const m=mapCol(r);
    const v=normalize(m.valor);
    if(!m.data || !m.cat || !m.tipo || v===null) continue;

    batch.push({
      id:uuid(),
      perfil:state.ativo,
      data:String(m.data).slice(0,10),
      cat:String(m.cat),
      tipo:m.tipo==='Sa√≠da'||m.tipo==='Saida'?'Sa√≠da':'Entrada',
      valor:v
    });
  }

  state.db.push(...batch);
  save();
  refresh();
}

temaSel.onchange=e=>{
  document.body.setAttribute('data-theme',e.target.value);
  state.cfg.tema=e.target.value;
  save();
};

backup.onclick=()=>{
  const ws=XLSX.utils.json_to_sheet(state.db);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'BancoGlobal');
  XLSX.writeFile(wb,'FluxoPro_BancoGlobal.xlsx');
};

reset.onclick=()=>{
  if(confirm('Apagar todos os dados?')){
    localStorage.clear();
    location.reload();
  }
};

/* ===================== abas ====================== */

document.querySelectorAll('.tabs button').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');

    document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');

    if(b.dataset.tab==='dash'){
      setTimeout(()=>{
        renderResumo();
        renderCharts();
      },50);
    }
  };
});

/* ===================== init ====================== */

function refresh(charts=true){
  renderTable();
  renderResumo();
  if(charts){
    renderCharts();
  }
}

function init(){
  document.body.setAttribute('data-theme',state.cfg.tema||'indigo');
  temaSel.value=state.cfg.tema||'indigo';
  renderPerfis();
  refresh();
}

return{init};

})();

window.onload=FluxoPro.init;
</script>

</body>
</html>
