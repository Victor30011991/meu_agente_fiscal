<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v12</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link id="themeCSS" rel="stylesheet" href="">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:#f5f7fb;color:#1f2937;transition:background .3s, color .3s}
:root{--p:#4f46e5;--card:#fff;--b:#e5e7eb;--ok:#10b981;--bad:#ef4444}
header{background:#fff;border-bottom:1px solid var(--b);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.tabs button{border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;background:#f3f4f6;transition:all .2s}
.tabs button.active{background:var(--p);color:#fff}

.container{max-width:1300px;margin:auto;padding:20px}

.layout{
  display:grid;
  grid-template-columns:340px 1fr;
  gap:20px;
  align-items:flex-start;
}

.sidebar{
  position:sticky;
  top:20px;
}

@media(max-width:900px){
  .layout{grid-template-columns:1fr}
  .sidebar{position:relative}
}

.card{background:var(--card);border-radius:18px;padding:20px;border:1px solid var(--b);margin-bottom:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);transition:all .3s}

table{width:100%;border-collapse:collapse}
th,td{padding:12px 10px;border-bottom:1px solid var(--b)}
td[contenteditable]{cursor:text;transition:all .2s}
td[contenteditable]:focus{outline:2px solid var(--p);background:#eef2ff}

.badge{padding:6px 12px;border-radius:999px;font-weight:700;cursor:pointer;display:inline-block;transition:all .2s}
.entrada{background:#ecfdf5;color:var(--ok)}
.saida{background:#fef2f2;color:var(--bad)}

button{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.main{background:var(--p);color:#fff}

.actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
select,input,textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--b);font-family:inherit}

.resume{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:10px}
.resume div{background:#f9fafb;border-radius:12px;padding:12px;font-weight:700;text-align:center}

.gridDash{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
.modal .card{max-width:380px;width:90%;margin:0}
.hidden{display:none}

/* ‚úÖ TEMA SELECTOR */
.theme-selector{display:flex;gap:8px;align-items:center}
.theme-btn{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .2s}
.theme-btn:hover{transform:scale(1.1)}
.theme-btn.active{border-color:#000;box-shadow:0 0 0 2px #fff}
.theme-default{background:linear-gradient(135deg,#f5f7fb,#4f46e5)}
.theme-dark{background:#0f172a}
.theme-emerald{background:#10b981}
.theme-gold{background:#f59e0b}
.theme-indigo{background:#6366f1}
.theme-rose{background:#fb7185}

/* ‚úÖ LOADING */
.loading{display:inline-block;width:16px;height:16px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚úÖ TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:#1f2937;color:#fff;padding:12px 20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:10000;animation:slideIn .3s}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}}
</style>
</head>
<body>

<header>
<strong>FluxoPro Engine v12</strong>

<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<select id="perfilSelect"></select>
<button id="novoPerfil" title="Novo perfil">+</button>

<div class="theme-selector">
<button class="theme-btn theme-default active" data-theme="" title="Padr√£o"></button>
<button class="theme-btn theme-dark" data-theme="dark" title="Dark"></button>
<button class="theme-btn theme-emerald" data-theme="emerald" title="Emerald"></button>
<button class="theme-btn theme-gold" data-theme="gold" title="Gold"></button>
<button class="theme-btn theme-indigo" data-theme="indigo" title="Indigo"></button>
<button class="theme-btn theme-rose" data-theme="rose" title="Rose"></button>
</div>

<div class="tabs">
<button data-tab="lanc" class="active">Lan√ßamentos</button>
<button data-tab="conf">Configura√ß√µes</button>
</div>
</div>
</header>

<div class="container">
<div class="layout">

<aside class="sidebar">
<div class="card">
<h3>Resumo geral</h3>

<div class="resume">
<div>Entradas<br><span id="sumEnt">R$ 0,00</span></div>
<div>Sa√≠das<br><span id="sumSai">R$ 0,00</span></div>
<div>Resultado<br><span id="sumRes">R$ 0,00</span></div>
</div>

<div class="actions">
<button onclick="abrirExport()">üìä Exportar</button>
<button onclick="abrirImport()">üì• Importar</button>
</div>
</div>

<div class="gridDash">
<div class="card">
<h4>Distribui√ß√£o por categoria</h4>
<canvas id="chartPizza"></canvas>
<p id="txtPizza"></p>
</div>
<div class="card">
<h4>Percentual Entradas x Sa√≠das</h4>
<canvas id="chartPerc"></canvas>
<p id="txtPerc"></p>
</div>
<div class="card">
<h4>Resumo Financeiro</h4>
<canvas id="chartResumo"></canvas>
<p id="txtResumo"></p>
</div>
</div>
</aside>

<main>
<section id="tab-lanc">
<div class="actions">
<button class="main" id="novoLanc">‚ûï Novo lan√ßamento</button>
<button id="importar">üì• Alimentar perfil</button>
<button id="refreshBtn" title="Atualizar dados">üîÑ Refresh</button>
</div>

<div class="card">
<h3>Dados do perfil</h3>
<input id="perfilNome" placeholder="Nome / Raz√£o social" style="width:100%;margin-bottom:8px">
<input id="perfilDoc" placeholder="CPF ou CNPJ" style="width:100%">
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Data</th>
<th>Categoria</th>
<th>Tipo</th>
<th>Valor</th>
<th>Observa√ß√£o</th>
<th>Apagar</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</section>

<section id="tab-conf" class="hidden">
<div class="card">
<h3>Painel de controle</h3>
<button id="exportAll">üìä Relat√≥rio (Excel / PDF)</button>
<button id="resetAll" style="background:#ef4444;color:#fff">üóëÔ∏è Reset de f√°brica</button>
</div>
</section>
</main>
</div>
</div>

<div class="modal" id="modal">
<div class="card">
<h3>Novo lan√ßamento</h3>
<form id="form">
<input type="date" id="data" required><br><br>
<input type="text" id="cat" placeholder="Categoria" required><br><br>
<select id="tipo">
<option>Entrada</option>
<option>Sa√≠da</option>
</select><br><br>
<input type="text" id="valor" placeholder="Valor (ex: 1.500,00)" required><br><br>
<textarea id="obs" placeholder="Observa√ß√£o (opcional)"></textarea><br><br>
<div style="display:flex;gap:10px">
<button type="submit" class="main">üíæ Salvar</button>
<button type="button" onclick="fecharModal()">‚ùå Cancelar</button>
</div>
</form>
</div>
</div>

<script>
const KEY="fluxopro_v12";
let charts={},debounceTimer;

function loadDB(){return JSON.parse(localStorage.getItem(KEY)) || {active:"default",profiles:{default:[]},profileInfo:{},theme:""};}
function saveDB(db){localStorage.setItem(KEY,JSON.stringify(db));}
function normalizeValue(v){let s=String(v||"").replace(/[^\d.,-]/g,"").replace(",",".");let n=parseFloat(s);return isNaN(n)?null:n;}
function formatMoney(v){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);}
function list(){const db=loadDB();return db.profiles[db.active]||[];}
function renderPerfis(){const db=loadDB();perfilSelect.innerHTML=Object.keys(db.profiles).map(p=>`<option ${p===db.active?"selected":""}>${p}</option>`).join("");}
function renderProfileInfo(){const db=loadDB();const info=db.profileInfo[db.active]||{};perfilNome.value=info.nome||"";perfilDoc.value=info.doc||"";}
function saveProfileInfo(){const db=loadDB();db.profileInfo[db.active]={nome:perfilNome.value.trim(),doc:perfilDoc.value.trim()};saveDB(db);}
function renderTable(){const dados=list();tbody.innerHTML=dados.length?dados.map(i=>`<tr data-id="${i.id}"><td contenteditable data-f="data">${i.data||""}</td><td contenteditable data-f="cat">${i.cat||""}</td><td><span class="badge ${i.tipo==="Entrada"?"entrada":"saida"} btnTipo">${i.tipo}</span></td><td contenteditable data-f="valor">${formatMoney(i.valor)}</td><td contenteditable data-f="obs">${i.obs||""}</td><td><button class="del" title="Apagar">üóëÔ∏è</button></td></tr>`).join(""):`<tr><td colspan="6" style="text-align:center;color:#999">Nenhum lan√ßamento cadastrado</td></tr>`;}
function updateResumo(){let e=0,s=0;list().forEach(i=>i.tipo==="Entrada"?e+=i.valor:s+=i.valor);sumEnt.innerText=formatMoney(e);sumSai.innerText=formatMoney(s);sumRes.innerText=formatMoney(e-s);sumRes.style.color=(e-s)>=0?"var(--ok)":"var(--bad)";}
function renderDashboard(){const dados=list();if(!dados.length){if(charts.pizza) charts.pizza.destroy(); if(charts.perc) charts.perc.destroy(); if(charts.res) charts.res.destroy(); txtPizza.innerText="Adicione lan√ßamentos para visualizar gr√°ficos."; txtPerc.innerText=""; txtResumo.innerText=""; return;} let ent=0,sai=0,mapa={};dados.forEach(i=>{i.tipo==="Entrada"?ent+=i.valor:sai+=i.valor; if(i.tipo==="Sa√≠da") mapa[i.cat||"Outros"]=(mapa[i.cat||"Outros"]||0)+i.valor;}); if(charts.pizza){charts.pizza.data.labels=Object.keys(mapa); charts.pizza.data.datasets[0].data=Object.values(mapa); charts.pizza.update();}else{charts.pizza=new Chart(chartPizza,{type:"doughnut",data:{labels:Object.keys(mapa),datasets:[{data:Object.values(mapa)}]}});} if(charts.perc){charts.perc.data.datasets[0].data=[ent,sai]; charts.perc.update();}else{charts.perc=new Chart(chartPerc,{type:"pie",data:{labels:["Entradas","Sa√≠das"],datasets:[{data:[ent,sai]}]}});} if(charts.res){charts.res.data.datasets[0].data=[ent,sai,ent-sai]; charts.res.update();}else{charts.res=new Chart(chartResumo,{type:"bar",data:{labels:["Entradas","Sa√≠das","Resultado"],datasets:[{data:[ent,sai,ent-sai]}]}});} txtPizza.innerText="Categorias com maiores sa√≠das."; txtPerc.innerText=(ent+sai)?`Entradas representam ${(ent/(ent+sai)*100).toFixed(1)}%`:""; txtResumo.innerText=ent>=sai?"‚úÖ Sa√∫de financeira positiva.":"‚ö†Ô∏è Aten√ß√£o: gastos maiores que entradas.";}
function refreshAll(){renderTable();updateResumo();renderProfileInfo();renderDashboard();}
function showToast(msg){const toast=document.createElement("div");toast.className="toast";toast.innerText=msg;document.body.appendChild(toast);setTimeout(()=>toast.remove(),2000);}

form.onsubmit=e=>{e.preventDefault();const v=normalizeValue(valor.value);if(v===null)return alert("‚ö†Ô∏è Valor inv√°lido. Use formato: 1500 ou 1.500,00");const db=loadDB();db.profiles[db.active].push({id:crypto.randomUUID(),data:data.value,cat:cat.value.trim(),tipo:tipo.value,valor:v,obs:obs.value.trim()});saveDB(db);fecharModal();form.reset();refreshAll();showToast("‚úÖ Lan√ßamento adicionado!");};
function fecharModal(){modal.style.display="none";}

tbody.onclick=e=>{
  const tr=e.target.closest("tr");
  if(!tr||!tr.dataset.id)return;
  const db=loadDB();
  const item=db.profiles[db.active].find(i=>i.id===tr.dataset.id);
  if(!item)return;

  if(e.target.classList.contains("del")){
    if(confirm("üóëÔ∏è Apagar este lan√ßamento?")){
      db.profiles[db.active]=db.profiles[db.active].filter(i=>i.id!==item.id);
      saveDB(db);
      refreshAll();
      showToast("üóëÔ∏è Lan√ßamento removido");
    }
    return;
  }

  if(e.target.classList.contains("btnTipo")){
    item.tipo=item.tipo==="Entrada"?"Sa√≠da":"Entrada";
    saveDB(db);
    refreshAll();
  }
};

tbody.addEventListener("blur",e=>{
  const td=e.target;
  if(!td.dataset.f)return;
  const tr=td.closest("tr");
  const db=loadDB();
  const item=db.profiles[db.active].find(i=>i.id===tr.dataset.id);
  if(!item)return;

  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{
    if(td.dataset.f==="valor"){
      const n=normalizeValue(td.innerText);
      if(n===null){td.innerText=formatMoney(item.valor);alert("‚ö†Ô∏è Valor inv√°lido");return;}
      item.valor=n;
    }else{
      item[td.dataset.f]=td.innerText.trim();
    }
    saveDB(db);
    refreshAll();
    showToast("üíæ Altera√ß√£o salva");
  },300);
},true);

perfilNome.onblur=saveProfileInfo;
perfilDoc.onblur=saveProfileInfo;

novoLanc.onclick=()=>modal.style.display="flex";
refreshBtn.onclick=()=>{refreshAll();showToast("üîÑ Dados atualizados!");};

perfilSelect.onchange=e=>{const db=loadDB();db.active=e.target.value;saveDB(db);refreshAll();showToast(`üìÅ Perfil: ${e.target.value}`);};

novoPerfil.onclick=()=>{
  const n=prompt("üìÅ Nome do novo perfil:");
  if(!n||!n.trim())return;
  const db=loadDB();
  if(db.profiles[n]){alert("‚ö†Ô∏è Perfil j√° existe!");return;}
  db.profiles[n]=[];db.profileInfo[n]={};db.active=n;
  saveDB(db);renderPerfis();refreshAll();showToast(`‚úÖ Perfil "${n}" criado!`);
};

document.querySelectorAll(".tabs button").forEach(b=>{b.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("tab-"+b.dataset.tab).classList.remove("hidden");
}});

function abrirImport(){const db=loadDB();window.open(`import.html?perfil=${encodeURIComponent(db.active)}`,"_blank");}
function abrirExport(){window.open("export.html","_blank");}

importar.onclick=abrirImport;
exportAll.onclick=abrirExport;

resetAll.onclick=()=>{
  if(confirm("‚ö†Ô∏è Apagar TODOS os dados do sistema?\n\nEsta a√ß√£o n√£o pode ser desfeita!")){
    if(confirm("üö® Tem certeza absoluta? Todos os perfis ser√£o perdidos!")){
      localStorage.removeItem(KEY);location.reload();
    }
  }
};

document.querySelectorAll(".theme-btn").forEach(btn=>{
  btn.onclick=()=>{
