<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Relatório</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#f0f2f8;color:#1a1f36;font-size:14px}
.page{max-width:980px;margin:0 auto;padding:22px 18px}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:14px 18px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:18px;gap:12px;flex-wrap:wrap}
.top-bar h1{font-size:16px;font-weight:800;color:#1a1f36}
.top-bar span{font-size:11px;color:#6b7280}
.btn-group{display:flex;gap:8px}
button{display:flex;align-items:center;gap:6px;padding:9px 16px;border:0;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s;font-family:Inter,sans-serif}
button:hover{opacity:.85;transform:translateY(-1px)}
.btn-excel{background:#059669;color:#fff}
.btn-pdf{background:#4f46e5;color:#fff}
.card{background:#fff;border-radius:14px;border:1px solid #e2e5ef;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:14px;overflow:hidden}
.card-head{padding:12px 18px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f3f9}
.card-head h2{font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.6px}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 18px}
.kpi{border-radius:10px;padding:13px;border:1px solid transparent;position:relative;overflow:hidden}
.kpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:2px 2px 0 0}
.kpi-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px}
.kpi-val{font-size:17px;font-weight:800;letter-spacing:-1px}
.kpi-sub{font-size:10px;color:#9ca3af;margin-top:3px}
.kpi-ent{background:#f0fdf4;border-color:#a7f3d0} .kpi-ent::after{background:#059669} .kpi-ent .kpi-label{color:#047857} .kpi-ent .kpi-val{color:#059669}
.kpi-sai{background:#fef2f2;border-color:#fecaca} .kpi-sai::after{background:#dc2626} .kpi-sai .kpi-label{color:#b91c1c} .kpi-sai .kpi-val{color:#dc2626}
.kpi-net{background:#eef2ff;border-color:#c7d2fe} .kpi-net::after{background:#4f46e5} .kpi-net .kpi-label{color:#3730a3}
.perfil-info{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:13px 18px}
.pi-item label{display:block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#9ca3af;margin-bottom:3px}
.pi-item span{font-size:13px;font-weight:600;color:#1a1f36}
table{width:100%;border-collapse:collapse}
th{padding:8px 11px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#6b7280;background:#f8fafc;border-bottom:2px solid #e2e5ef;white-space:nowrap}
td{padding:8px 11px;font-size:12px;color:#1a1f36;border-bottom:1px solid #f1f3f9}
tbody tr:last-child td{border-bottom:none}
tbody tr:nth-child(even){background:#fafbff}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;text-transform:uppercase}
.badge::before{content:'';width:4px;height:4px;border-radius:50%;background:currentColor}
.ent{background:#f0fdf4;color:#059669}
.sai{background:#fef2f2;color:#dc2626}
/* gráficos — 3 colunas exatas, mesma altura */
.chart-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 18px 16px;align-items:start}
.chart-box{border:1px solid #f1f3f9;border-radius:10px;padding:11px;display:flex;flex-direction:column;gap:6px}
.chart-box h3{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#6b7280;text-align:center}
.analise-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 18px 16px}
.analise-box{border-radius:10px;padding:13px;border:1px solid transparent}
.analise-box.ent{background:#f0fdf4;border-color:#a7f3d0}
.analise-box.sai{background:#fef2f2;border-color:#fecaca}
.analise-box.net{background:#eef2ff;border-color:#c7d2fe}
.analise-box h3{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px}
.analise-box.ent h3{color:#047857}
.analise-box.sai h3{color:#b91c1c}
.analise-box.net h3{color:#3730a3}
.analise-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.05);font-size:11px}
.analise-item:last-child{border-bottom:none}
.analise-item .lbl{color:#6b7280;font-weight:500}
.analise-item .val{font-weight:700}
.analise-total{margin-top:8px;padding-top:7px;border-top:2px solid rgba(0,0,0,.08);display:flex;justify-content:space-between;font-weight:800;font-size:12px}
.narrativa{padding:14px 18px 16px}
.narrativa p{font-size:12px;line-height:1.75;color:#374151;margin-bottom:7px}
.narrativa p:last-child{margin-bottom:0}
.loading{display:none;position:fixed;inset:0;background:rgba(10,15,30,.55);backdrop-filter:blur(4px);z-index:999;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.loading.show{display:flex}
.spinner{width:44px;height:44px;border:4px solid rgba(255,255,255,.2);border-top:4px solid #fff;border-radius:50%;animation:spin .9s linear infinite}
.loading-text{color:#fff;font-weight:600;font-size:13px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:#9ca3af}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Gerando documento...</div>
</div>

<!-- canvases ocultos para PNG no PDF — MESMAS dimensões -->
<div style="position:absolute;left:-9999px;width:500px;opacity:.01;pointer-events:none">
  <canvas id="cvPizza"    width="500" height="400"></canvas>
  <canvas id="cvEvolucao" width="500" height="400"></canvas>
  <canvas id="cvBar"      width="500" height="400"></canvas>
</div>

<div class="page">

  <div class="top-bar">
    <div>
      <h1>&#128202; Relatório Financeiro — FluxoPro</h1>
      <span id="headerSub">Carregando...</span>
    </div>
    <div class="btn-group">
      <button class="btn-excel" onclick="exportExcel()">&#128190; Excel</button>
      <button class="btn-pdf"   onclick="exportPDF()">  &#128196; PDF</button>
    </div>
  </div>

  <!-- Perfil -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#4f46e5"></span><h2>Identificação do Perfil</h2></div>
    <div class="perfil-info">
      <div class="pi-item"><label>Perfil</label><span id="piPerfil">—</span></div>
      <div class="pi-item"><label>Nome / Razão social</label><span id="piNome">—</span></div>
      <div class="pi-item"><label>CPF / CNPJ</label><span id="piDoc">—</span></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#059669"></span><h2>Painel de Saldos</h2></div>
    <div class="kpi-grid">
      <div class="kpi kpi-ent">
        <div class="kpi-label">Entradas — ganhos</div>
        <div class="kpi-val" id="kEnt">R$ 0</div>
        <div class="kpi-sub" id="kEntQtd">0 lançamentos</div>
      </div>
      <div class="kpi kpi-sai">
        <div class="kpi-label">Saídas — gastos</div>
        <div class="kpi-val" id="kSai">R$ 0</div>
        <div class="kpi-sub" id="kSaiQtd">0 lançamentos</div>
      </div>
      <div class="kpi kpi-net">
        <div class="kpi-label">Resultado líquido</div>
        <div class="kpi-val" id="kNet" style="color:#4f46e5">R$ 0</div>
        <div class="kpi-sub" id="kNetPct">—</div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#7c3aed"></span><h2>Resumo Visual</h2></div>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Gastos por Categoria</h3>
        <canvas id="cPizza"    height="210"></canvas>
      </div>
      <div class="chart-box">
        <h3>Evolução Mensal</h3>
        <canvas id="cEvolucao" height="210"></canvas>
      </div>
      <div class="chart-box">
        <h3>Entradas x Saídas</h3>
        <canvas id="cBar"      height="210"></canvas>
      </div>
    </div>
  </div>

  <!-- Extrato -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#d97706"></span><h2>Extrato Completo de Lançamentos</h2></div>
    <div id="tabelaWrap">
      <table>
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th style="width:90px">Data</th>
            <th>Categoria</th>
            <th style="width:80px">Tipo</th>
            <th style="width:110px;text-align:right">Valor</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <!-- Análise -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#059669"></span><h2>Relatório Detalhado</h2></div>
    <div class="analise-grid" id="analiseGrid"></div>
  </div>

  <!-- Narrativa -->
  <div class="card">
    <div class="card-head"><span class="dot" style="background:#1a1f36"></span><h2>Análise Interpretativa</h2></div>
    <div class="narrativa" id="narrativa"></div>
  </div>

</div>

<script>
/* ============================================================
   HELPERS
   ============================================================ */
function normTipo(t) {
  return String(t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();
}
function ehEntrada(t) { return normTipo(t)==="entrada"; }
function ehSaida(t)   { return normTipo(t)==="saida"; }

function fmtMoney(v) {
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}
function fmtDate(iso) {
  if (!iso) return "—";
  const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`;
}
function pct(a,b) { return b ? (a/b*100).toFixed(1)+"%" : "—"; }

/* ============================================================
   DADOS
   ============================================================ */
const KEY = "fluxopro_v12";
let db, perfil, dados, info;

try {
  db     = JSON.parse(localStorage.getItem(KEY));
  if (!db||!db.profiles) throw new Error("Base não encontrada. Abra o FluxoPro primeiro.");
  perfil = db.active;
  dados  = db.profiles[perfil] || [];
  info   = db.profileInfo?.[perfil] || {};
} catch(err) {
  document.querySelector(".page").innerHTML =
    "<div class='card'><div style='padding:40px;text-align:center;color:#6b7280'><h2 style='color:#1a1f36;margin-bottom:8px'>Erro ao carregar</h2><p>"+err.message+"</p></div></div>";
  throw err;
}

const PALETTE = ["#4f46e5","#059669","#d97706","#7c3aed","#0891b2","#db2777","#65a30d","#ea580c","#2563eb","#dc2626"];

/* ============================================================
   CÁLCULOS — ponto flutuante seguro com toFixed(2)
   ============================================================ */
let totalEnt=0, totalSai=0;
const mapacat={}, catEntradas={};
dados.forEach(l => {
  const v = Number(l.valor||0);
  if (ehEntrada(l.tipo)) {
    totalEnt = +(totalEnt + v).toFixed(2);
    catEntradas[l.cat||"Outros"] = +((catEntradas[l.cat||"Outros"]||0)+v).toFixed(2);
  } else {
    totalSai = +(totalSai + v).toFixed(2);
    mapacat[l.cat||"Outros"] = +((mapacat[l.cat||"Outros"]||0)+v).toFixed(2);
  }
});
const resultado = +(totalEnt - totalSai).toFixed(2);
const qtdEnt    = dados.filter(l=>ehEntrada(l.tipo)).length;
const qtdSai    = dados.filter(l=>ehSaida(l.tipo)).length;

/* ============================================================
   PREENCHER PÁGINA
   ============================================================ */
const datas   = dados.map(l=>l.data).filter(Boolean).sort();
const periodo = datas.length ? fmtDate(datas[0])+" a "+fmtDate(datas[datas.length-1]) : "—";

document.getElementById("headerSub").innerText =
  "Perfil: "+perfil+" | "+dados.length+" lançamentos | "+periodo;
document.getElementById("piPerfil").innerText = perfil;
document.getElementById("piNome").innerText   = info.nome || "Não informado";
document.getElementById("piDoc").innerText    = info.doc  || "Não informado";
document.getElementById("kEnt").innerText     = fmtMoney(totalEnt);
document.getElementById("kSai").innerText     = fmtMoney(totalSai);
document.getElementById("kNet").innerText     = fmtMoney(resultado);
document.getElementById("kNet").style.color   = resultado>=0?"#4f46e5":"#dc2626";
document.getElementById("kEntQtd").innerText  = qtdEnt+" lançamento"+(qtdEnt!==1?"s":"");
document.getElementById("kSaiQtd").innerText  = qtdSai+" lançamento"+(qtdSai!==1?"s":"");
document.getElementById("kNetPct").innerText  = (resultado>=0?"+":"")+pct(Math.abs(resultado),totalEnt)+" das entradas";

/* tabela */
if (!dados.length) {
  document.getElementById("tabelaWrap").innerHTML="<div class='empty'>Nenhum lançamento</div>";
} else {
  document.getElementById("tb").innerHTML = dados.map((l,i)=>`
  <tr>
    <td style="color:#9ca3af;font-size:10px;font-weight:600">${i+1}</td>
    <td style="font-weight:600;font-size:11px;color:#6b7280;white-space:nowrap">${fmtDate(l.data)}</td>
    <td style="font-weight:600">${l.cat||"—"}</td>
    <td><span class="badge ${ehEntrada(l.tipo)?"ent":"sai"}">${l.tipo}</span></td>
    <td style="font-weight:700;text-align:right;white-space:nowrap;color:${ehEntrada(l.tipo)?"#059669":"#dc2626"}">${fmtMoney(l.valor)}</td>
    <td style="color:#9ca3af;font-size:11px">${l.obs||"—"}</td>
  </tr>`).join("");
}

/* análise */
const topEnt = Object.entries(catEntradas).sort((a,b)=>b[1]-a[1]).slice(0,6);
const topSai = Object.entries(mapacat).sort((a,b)=>b[1]-a[1]).slice(0,6);

document.getElementById("analiseGrid").innerHTML=`
  <div class="analise-box ent">
    <h3>Entradas (ganhos)</h3>
    ${topEnt.map(([k,v])=>`<div class="analise-item"><span class="lbl">${k}</span><span class="val" style="color:#059669">${fmtMoney(v)}</span></div>`).join("")}
    <div class="analise-total" style="color:#059669"><span>Total</span><span>${fmtMoney(totalEnt)}</span></div>
  </div>
  <div class="analise-box sai">
    <h3>Saídas (gastos)</h3>
    ${topSai.map(([k,v])=>`<div class="analise-item"><span class="lbl">${k}</span><span class="val" style="color:#dc2626">${fmtMoney(v)}</span></div>`).join("")}
    <div class="analise-total" style="color:#dc2626"><span>Total</span><span>${fmtMoney(totalSai)}</span></div>
  </div>
  <div class="analise-box net">
    <h3>Resultado Líquido</h3>
    <div class="analise-item"><span class="lbl">Total entradas</span><span class="val" style="color:#059669">${fmtMoney(totalEnt)}</span></div>
    <div class="analise-item"><span class="lbl">(–) Total saídas</span><span class="val" style="color:#dc2626">${fmtMoney(totalSai)}</span></div>
    <div class="analise-item"><span class="lbl">Margem líquida</span><span class="val">${pct(resultado,totalEnt)}</span></div>
    <div class="analise-item"><span class="lbl">Lançamentos</span><span class="val">${dados.length}</span></div>
    <div class="analise-total" style="color:${resultado>=0?"#4f46e5":"#dc2626"}"><span>Resultado</span><span>${fmtMoney(resultado)}</span></div>
  </div>`;

/* narrativa */
const maiorG = topSai[0]?topSai[0][0]:"—";
const maiorE = topEnt[0]?topEnt[0][0]:"—";
const corS   = resultado>0?"#059669":resultado<0?"#dc2626":"#d97706";
document.getElementById("narrativa").innerHTML=`
  <p>O período analisado compreende <strong>${dados.length} lançamentos</strong> (${qtdEnt} entradas e ${qtdSai} saídas), de <strong>${fmtDate(datas[0])}</strong> a <strong>${fmtDate(datas[datas.length-1])}</strong>.</p>
  <p>As entradas totalizaram <strong style="color:#059669">${fmtMoney(totalEnt)}</strong>, sendo a principal categoria de receita <strong>${maiorE}</strong>.
     As saídas totalizaram <strong style="color:#dc2626">${fmtMoney(totalSai)}</strong>,
     com maior concentração em <strong>${maiorG}</strong> (${fmtMoney(mapacat[maiorG]||0)} — ${pct(mapacat[maiorG]||0,totalSai)} das saídas).</p>
  <p>O resultado líquido é de <strong style="color:${corS}">${fmtMoney(resultado)}</strong>, representando <strong>${pct(resultado,totalEnt)}</strong> sobre as entradas.
     A saúde financeira é considerada <strong style="color:${corS}">${resultado>0?"POSITIVA":resultado<0?"NEGATIVA":"NEUTRA"}</strong>${resultado<0?" — recomenda-se revisão dos gastos.":"."}
  </p>`;

/* ============================================================
   HELPER MONTHLY
   ============================================================ */
function buildMonthly(d) {
  const map={};
  d.forEach(l=>{
    if (!l.data) return;
    const mes=l.data.substring(0,7);
    if (!map[mes]) map[mes]={ent:0,sai:0};
    ehEntrada(l.tipo) ? map[mes].ent=+(map[mes].ent+Number(l.valor||0)).toFixed(2)
                      : map[mes].sai=+(map[mes].sai+Number(l.valor||0)).toFixed(2);
  });
  const keys=Object.keys(map).sort();
  return {
    labels: keys.map(k=>{const[y,m]=k.split("-");return new Date(y,m-1).toLocaleDateString("pt-BR",{month:"short",year:"2-digit"});}),
    ent: keys.map(k=>map[k].ent),
    sai: keys.map(k=>map[k].sai)
  };
}

/* ============================================================
   GRÁFICOS PREVIEW (página)
   ============================================================ */
const gc={color:"#6b7280",grid:"#f1f3f9"};
const catL=Object.keys(mapacat).sort((a,b)=>mapacat[b]-mapacat[a]);
const catV=catL.map(k=>mapacat[k]);
const monthly=buildMonthly(dados);

new Chart(cPizza,{type:"doughnut",
  data:{labels:catL,datasets:[{data:catV,backgroundColor:PALETTE.slice(0,catL.length),borderWidth:2,borderColor:"#fff",hoverOffset:6}]},
  options:{responsive:true,cutout:"63%",plugins:{legend:{position:"bottom",labels:{font:{family:"Inter",size:10},color:gc.color,boxWidth:10,padding:7}},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${fmtMoney(ctx.parsed)}`}}}}
});
new Chart(cEvolucao,{type:"line",
  data:{labels:monthly.labels,datasets:[
    {label:"Entradas",data:monthly.ent,borderColor:"#059669",backgroundColor:"rgba(5,150,105,.07)",fill:true,tension:.38,pointRadius:3,borderWidth:2},
    {label:"Saídas",  data:monthly.sai,borderColor:"#dc2626",backgroundColor:"rgba(220,38,38,.06)",fill:true,tension:.38,pointRadius:3,borderWidth:2}
  ]},
  options:{responsive:true,interaction:{mode:"index",intersect:false},scales:{x:{grid:{color:gc.grid},ticks:{color:gc.color,font:{size:9}}},y:{grid:{color:gc.grid},ticks:{color:gc.color,font:{size:9},callback:v=>"R$"+(v>=1000?(v/1000).toFixed(0)+"k":v)},beginAtZero:true}},plugins:{legend:{position:"top",labels:{font:{size:10},color:gc.color,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${fmtMoney(ctx.parsed.y)}`}}}}
});
new Chart(cBar,{type:"bar",
  data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai],backgroundColor:["rgba(5,150,105,.8)","rgba(220,38,38,.8)"],borderColor:["#059669","#dc2626"],borderWidth:2,borderRadius:7}]},
  options:{responsive:true,scales:{x:{grid:{display:false},ticks:{color:gc.color,font:{size:10}}},y:{grid:{color:gc.grid},ticks:{color:gc.color,font:{size:9},callback:v=>"R$"+(v>=1000?(v/1000).toFixed(0)+"k":v)},beginAtZero:true}},plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${fmtMoney(ctx.parsed.y)}`}}}}
});

/* canvases offline — 500x400 cada */
new Chart(cvPizza,{type:"doughnut",
  data:{labels:catL,datasets:[{data:catV,backgroundColor:PALETTE.slice(0,catL.length),borderWidth:2,borderColor:"#fff",hoverOffset:10}]},
  options:{responsive:false,animation:false,cutout:"60%",plugins:{legend:{position:"bottom",labels:{font:{size:14},padding:16}},tooltip:{enabled:false}}}
});
new Chart(cvEvolucao,{type:"line",
  data:{labels:monthly.labels,datasets:[
    {label:"Entradas",data:monthly.ent,borderColor:"#059669",backgroundColor:"rgba(5,150,105,.10)",fill:true,tension:.38,pointRadius:4,borderWidth:2.5},
    {label:"Saídas",  data:monthly.sai,borderColor:"#dc2626",backgroundColor:"rgba(220,38,38,.08)",fill:true,tension:.38,pointRadius:4,borderWidth:2.5}
  ]},
  options:{responsive:false,animation:false,interaction:{mode:"index",intersect:false},scales:{x:{grid:{color:"#f1f3f9"},ticks:{font:{size:12},color:"#6b7280"}},y:{grid:{color:"#f1f3f9"},ticks:{font:{size:12},color:"#6b7280",callback:v=>"R$"+(v>=1000?(v/1000).toFixed(0)+"k":v)},beginAtZero:true}},plugins:{legend:{labels:{font:{size:13},padding:14}},tooltip:{enabled:false}}}
});
new Chart(cvBar,{type:"bar",
  data:{labels:["Entradas","Saídas"],datasets:[{data:[totalEnt,totalSai],backgroundColor:["rgba(5,150,105,.8)","rgba(220,38,38,.8)"],borderColor:["#059669","#dc2626"],borderWidth:2,borderRadius:10}]},
  options:{responsive:false,animation:false,scales:{x:{grid:{display:false},ticks:{font:{size:13},color:"#6b7280"}},y:{grid:{color:"#f1f3f9"},ticks:{font:{size:13},color:"#6b7280",callback:v=>"R$"+(v>=1000?(v/1000).toFixed(0)+"k":v)},beginAtZero:true}},plugins:{legend:{display:false},tooltip:{enabled:false}}}
});

/* ============================================================
   EXCEL — alinhamento e estilos via SheetJS
   ============================================================ */
function exportExcel() {
  if (!dados.length){alert("Sem dados para exportar.");return;}

  /* Planilha principal: extrato */
  const rows = dados.map((l,i)=>({
    "#":           i+1,
    "Data":        l.data||"",
    "Categoria":   l.cat||"",
    "Tipo":        l.tipo||"",
    "Valor (R$)":  Number((l.valor||0).toFixed(2)),
    "Observação":  l.obs||""
  }));

  /* Linha de totais */
  rows.push({});
  rows.push({"#":"","Data":"","Categoria":"TOTAL ENTRADAS","Tipo":"","Valor (R$)": +totalEnt.toFixed(2),"Observação":""});
  rows.push({"#":"","Data":"","Categoria":"TOTAL SAÍDAS",  "Tipo":"","Valor (R$)": +totalSai.toFixed(2),"Observação":""});
  rows.push({"#":"","Data":"","Categoria":"RESULTADO",     "Tipo":"","Valor (R$)": +resultado.toFixed(2),"Observação":""});

  const ws = XLSX.utils.json_to_sheet(rows);

  /* Larguras das colunas */
  ws["!cols"] = [
    {wch:5},  /* # */
    {wch:12}, /* Data */
    {wch:22}, /* Categoria */
    {wch:10}, /* Tipo */
    {wch:14}, /* Valor */
    {wch:30}  /* Observação */
  ];

  /* Formato numérico BR para coluna Valor (coluna E = índice 4) */
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for (let row = 1; row <= range.e.r; row++) {
    const addr = XLSX.utils.encode_cell({r:row, c:4});
    if (ws[addr] && typeof ws[addr].v === "number") {
      ws[addr].z = "#,##0.00";
    }
  }

  /* Planilha de resumo */
  const wsRes = XLSX.utils.aoa_to_sheet([
    ["FluxoPro — Resumo Financeiro"],
    [],
    ["Perfil",      perfil],
    ["Nome",        info.nome||"—"],
    ["Documento",   info.doc||"—"],
    ["Período",     periodo],
    [],
    ["",            "Valor",         "Qtd. lançamentos"],
    ["Entradas",    +totalEnt.toFixed(2),  qtdEnt],
    ["Saídas",      +totalSai.toFixed(2),  qtdSai],
    ["Resultado",   +resultado.toFixed(2), dados.length],
  ]);
  wsRes["!cols"] = [{wch:18},{wch:16},{wch:18}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws,    "Extrato");
  XLSX.utils.book_append_sheet(wb, wsRes, "Resumo");
  XLSX.writeFile(wb, "fluxopro_"+perfil+"_"+Date.now()+".xlsx");
}

/* ============================================================
   PDF — estrutura alinhada e nome em destaque
   ============================================================ */
function exportPDF() {
  if (!dados.length){alert("Sem dados para exportar.");return;}
  loading.classList.add("show");

  setTimeout(()=>{
    try {
      const {jsPDF} = window.jspdf;
      const doc = new jsPDF("p","mm","a4");
      const W=210, H=297, M=14, cW=W-M*2;
      let y=0;

      /* Cores */
      const C = {
        pri:  [79,70,229], priL:[238,242,255], priB:[199,210,254], priD:[55,48,163],
        ok:   [5,150,105], okL: [240,253,244], okB: [167,243,208],
        bad:  [220,38,38], badL:[254,242,242], badB:[254,202,202],
        dark: [26,31,54],  gray:[107,114,128], lg:  [241,243,249],
        cardBg:[248,250,252], white:[255,255,255]
      };

      function novaPag(h) {
        if (y+h > H-18) { doc.addPage(); y=18; }
      }

      /* --------- BANNER CAPA --------- */
      /* Gradiente simulado */
      doc.setFillColor(...C.pri); doc.rect(0,0,W,46,"F");
      doc.setFillColor(...C.priD); doc.rect(0,33,W,13,"F");

      /* Ícone */
      doc.setFillColor(255,255,255,0.12);
      doc.roundedRect(M,8,30,28,5,5,"F");
      doc.setFontSize(18); doc.setFont(undefined,"bold"); doc.setTextColor(255,255,255);
      doc.text("FP", M+6, 27);

      /* Nome da pessoa — destaque */
      const nomePessoa = (info.nome || perfil).substring(0,38);
      doc.setFontSize(17); doc.setFont(undefined,"bold"); doc.setTextColor(255,255,255);
      doc.text(nomePessoa, M+36, 19);

      /* Documento */
      if (info.doc) {
        doc.setFontSize(9); doc.setFont(undefined,"normal"); doc.setTextColor(200,210,255);
        doc.text(info.doc, M+36, 26);
      }

      /* Subtítulo */
      doc.setFontSize(8); doc.setTextColor(180,195,255);
      doc.text("Relatório Financeiro — FluxoPro Engine v12", M+36, 36);
      doc.text("Período: "+periodo+"  |  "+dados.length+" lançamentos", M+36, 42);

      y = 56;

      /* --------- PERFIL --------- */
      doc.setFillColor(...C.cardBg);
      doc.roundedRect(M,y,cW,19,3,3,"F");
      doc.setDrawColor(...C.lg); doc.setLineWidth(.3);
      doc.roundedRect(M,y,cW,19,3,3,"S");
      doc.setFillColor(...C.pri); doc.roundedRect(M,y,4,19,2,0,"F");

      const cW3 = cW/3;
      doc.setFontSize(6.5); doc.setFont(undefined,"bold"); doc.setTextColor(...C.gray);
      doc.text("PERFIL",             M+7,       y+6.5);
      doc.text("NOME / RAZÃO SOCIAL",M+7+cW3,   y+6.5);
      doc.text("CPF / CNPJ",         M+7+cW3*2, y+6.5);
      doc.setFontSize(8.5); doc.setFont(undefined,"bold"); doc.setTextColor(...C.dark);
      doc.text(perfil.substring(0,20),                    M+7,       y+14);
      doc.text((info.nome||"Não informado").substring(0,26), M+7+cW3,   y+14);
      doc.text((info.doc||"Não informado").substring(0,20),  M+7+cW3*2, y+14);
      y += 25;

      /* --------- KPIs --------- */
      const kW = (cW-8)/3;
      function kpiBox(xp,yp,titulo,valor,sub,bg,border,corV) {
        doc.setFillColor(...bg); doc.roundedRect(xp,yp,kW,26,3,3,"F");
        doc.setDrawColor(...border); doc.roundedRect(xp,yp,kW,26,3,3,"S");
        doc.setFillColor(...corV); doc.roundedRect(xp,yp,kW,2,1,0,"F");
        doc.setFontSize(6); doc.setFont(undefined,"bold"); doc.setTextColor(...C.gray);
        doc.text(titulo, xp+5, yp+9);
        doc.setFontSize(11); doc.setFont(undefined,"bold"); doc.setTextColor(...corV);
        doc.text(fmtMoney(valor), xp+5, yp+18);
        doc.setFontSize(6.5); doc.setFont(undefined,"normal"); doc.setTextColor(...C.gray);
        doc.text(sub, xp+5, yp+23.5);
      }
      kpiBox(M,           y,"ENTRADAS — GANHOS",  totalEnt, qtdEnt+" lançamento"+(qtdEnt!==1?"s":""), C.okL, C.okB,  C.ok);
      kpiBox(M+kW+4,      y,"SAÍDAS — GASTOS",    totalSai, qtdSai+" lançamento"+(qtdSai!==1?"s":""), C.badL,C.badB, C.bad);
      kpiBox(M+(kW+4)*2,  y,"RESULTADO LÍQUIDO",  resultado,
        (resultado>=0?"+":"")+pct(Math.abs(resultado),totalEnt)+" das entradas",
        C.priL, C.priB, resultado>=0?C.pri:C.bad);
      y += 32;

      /* --------- GRÁFICOS --------- */
      novaPag(72);
      doc.setFillColor(...C.pri); doc.rect(M,y,3,13,"F");
      doc.setFontSize(9); doc.setFont(undefined,"bold"); doc.setTextColor(...C.dark);
      doc.text("Resumo Visual", M+7, y+8.5);
      y += 16;

      doc.setFontSize(6.5); doc.setFont(undefined,"bold"); doc.setTextColor(...C.gray);
      doc.text("GASTOS POR CATEGORIA", M,           y);
      doc.text("EVOLUÇÃO MENSAL",       M+kW+4,     y);
      doc.text("ENTRADAS x SAÍDAS",     M+(kW+4)*2, y);
      y += 3;

      const gH = 56;
      doc.addImage(cvPizza.toDataURL("image/png",1),    "PNG", M,           y, kW, gH,undefined,"FAST");
      doc.addImage(cvEvolucao.toDataURL("image/png",1), "PNG", M+kW+4,     y, kW, gH,undefined,"FAST");
      doc.addImage(cvBar.toDataURL("image/png",1),      "PNG", M+(kW+4)*2, y, kW, gH,undefined,"FAST");
      y += gH+10;

      /* --------- TABELA --------- */
      doc.addPage(); y=18;
      doc.setFillColor(...C.pri); doc.rect(M,y,3,13,"F");
      doc.setFontSize(9); doc.setFont(undefined,"bold"); doc.setTextColor(...C.dark);
      doc.text("Extrato Completo", M+7, y+8.5);
      y += 16;

      /* cabeçalho */
      doc.setFillColor(...C.pri); doc.rect(M,y,cW,8,"F");
      doc.setFontSize(6.5); doc.setFont(undefined,"bold"); doc.setTextColor(255,255,255);
      const TCols=[{x:M+2,t:"#",w:8},{x:M+10,t:"DATA",w:22},{x:M+32,t:"CATEGORIA",w:40},{x:M+72,t:"TIPO",w:18},{x:M+90,t:"VALOR",w:26},{x:M+116,t:"OBS"}];
      TCols.forEach(c=>doc.text(c.t, c.x, y+5.5));
      y+=10;

      dados.forEach((l,idx)=>{
        novaPag(7);
        if (idx%2===0){doc.setFillColor(...C.cardBg); doc.rect(M,y-3,cW,6.5,"F");}
        const isE=ehEntrada(l.tipo);
        doc.setFontSize(7); doc.setFont(undefined,"normal"); doc.setTextColor(...C.dark);
        doc.text(String(idx+1),                     TCols[0].x, y);
        doc.text(fmtDate(l.data||""),               TCols[1].x, y);
        doc.text((l.cat||"—").substring(0,18),      TCols[2].x, y);
        doc.setFont(undefined,"bold"); doc.setTextColor(...(isE?C.ok:C.bad));
        doc.text(l.tipo||"—",                       TCols[3].x, y);
        doc.text(fmtMoney(l.valor),                 TCols[4].x, y);
        doc.setFont(undefined,"normal"); doc.setTextColor(...C.gray);
        doc.text((l.obs||"—").substring(0,22),      TCols[5].x, y);
        y+=6.5;
      });
      y+=5;

      /* --------- RELATÓRIO DETALHADO --------- */
      novaPag(90);
      doc.setFillColor(...C.pri); doc.rect(M,y,3,13,"F");
      doc.setFontSize(9); doc.setFont(undefined,"bold"); doc.setTextColor(...C.dark);
      doc.text("Relatório Detalhado", M+7, y+8.5);
      y+=16;

      function relBox(xp,yp,titulo,corT,bg,border,items,total) {
        const boxH = 13+items.length*7.5+12;
        doc.setFillColor(...bg); doc.roundedRect(xp,yp,kW,boxH,3,3,"F");
        doc.setDrawColor(...border); doc.setLineWidth(.3);
        doc.roundedRect(xp,yp,kW,boxH,3,3,"S");
        doc.setFillColor(...corT); doc.roundedRect(xp,yp,kW,9,3,0,"F");
        doc.setFontSize(7); doc.setFont(undefined,"bold"); doc.setTextColor(255,255,255);
        doc.text(titulo, xp+5, yp+6.5);
        let ry=yp+14;
        items.forEach(([k,v])=>{
          doc.setFontSize(6.5); doc.setFont(undefined,"normal"); doc.setTextColor(...C.dark);
          doc.text(k.substring(0,20), xp+4, ry);
          doc.setFont(undefined,"bold"); doc.setTextColor(...corT);
          const vTxt=fmtMoney(Math.abs(v));
          doc.text(vTxt, xp+kW-3-doc.getTextWidth(vTxt), ry);
          ry+=7;
        });
        doc.setDrawColor(...border); doc.setLineWidth(.4);
        doc.line(xp+4,ry,xp+kW-4,ry); ry+=4;
        doc.setFontSize(8); doc.setFont(undefined,"bold"); doc.setTextColor(...corT);
        const tTxt=fmtMoney(Math.abs(total));
        doc.text("Total", xp+4, ry);
        doc.text(tTxt, xp+kW-3-doc.getTextWidth(tTxt), ry);
        return boxH;
      }

      const maxH1 = relBox(M,           y,"ENTRADAS (GANHOS)", C.ok, C.okL, C.okB,  topEnt, totalEnt);
      const maxH2 = relBox(M+kW+4,      y,"SAÍDAS (GASTOS)",   C.bad,C.badL,C.badB, topSai, totalSai);
      relBox(M+(kW+4)*2,  y,"RESULTADO LÍQUIDO",
        resultado>=0?C.pri:C.bad, C.priL, C.priB,
        [["Total entradas",totalEnt],["(–) Saídas",-totalSai],["Margem",resultado]],
        resultado);
      y += Math.max(maxH1, maxH2, 60)+10;

      /* --------- NARRATIVA --------- */
      novaPag(55);
      doc.setFillColor(...C.pri); doc.rect(M,y,3,13,"F");
      doc.setFontSize(9); doc.setFont(undefined,"bold"); doc.setTextColor(...C.dark);
      doc.text("Análise Interpretativa", M+7, y+8.5);
      y+=16;

      const nTxts=[
        `Período: ${dados.length} lançamentos (${qtdEnt} entradas / ${qtdSai} saídas). De ${fmtDate(datas[0])} a ${fmtDate(datas[datas.length-1])}.`,
        `Entradas: ${fmtMoney(totalEnt)} — principal: ${maiorE}. Saídas: ${fmtMoney(totalSai)} — maior gasto: ${maiorG} (${fmtMoney(mapacat[maiorG]||0)} / ${pct(mapacat[maiorG]||0,totalSai)}).`,
        `Resultado líquido: ${fmtMoney(resultado)} — margem ${pct(resultado,totalEnt)} sobre entradas. Saúde financeira: ${resultado>0?"POSITIVA":resultado<0?"NEGATIVA":"NEUTRA"}.${resultado<0?" Recomenda-se revisão dos gastos.":""}`
      ];
      doc.setFontSize(8.5); doc.setFont(undefined,"normal"); doc.setTextColor(...C.dark);
      nTxts.forEach(t=>{
        const lines=doc.splitTextToSize(t,cW-5);
        novaPag(lines.length*5+5);
        doc.text(lines, M+4, y);
        y+=lines.length*5+5;
      });

      /* --------- RODAPÉ --------- */
      const nPag=doc.internal.getNumberOfPages();
      for (let p=1;p<=nPag;p++){
        doc.setPage(p);
        doc.setFillColor(...C.cardBg); doc.rect(0,H-13,W,13,"F");
        doc.setFillColor(...C.pri); doc.rect(0,H-13,W,1.5,"F");
        doc.setFontSize(7); doc.setFont(undefined,"normal"); doc.setTextColor(...C.gray);
        doc.text("FluxoPro Engine v12  |  "+new Date().toLocaleDateString("pt-BR"), M, H-4.5);
        doc.text((info.nome||perfil).substring(0,30)+"  |  Página "+p+" de "+nPag, W-M, H-4.5,{align:"right"});
      }

      doc.save("fluxopro_"+perfil+"_"+Date.now()+".pdf");
      loading.classList.remove("show");

    } catch(e){
      console.error(e);
      loading.classList.remove("show");
      alert("Erro ao gerar PDF: "+e.message);
    }
  }, 500);
}
</script>
</body>
</html>
