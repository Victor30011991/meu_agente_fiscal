<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxoPro Brasil - Gest√£o Financeira</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #16a34a;
            --danger: #dc2626; --warning: #ca8a04; --bg: #f8fafc; --text: #1e293b;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        header { background: white; border-bottom: 1px solid #e2e8f0; padding: 1rem 2rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: auto; }
        nav { display: flex; gap: 10px; }
        .nav-btn { background: #f1f5f9; border: none; padding: 10px 18px; cursor: pointer; font-weight: 600; border-radius: 8px; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; }
        main { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .income p { color: var(--success); }
        .expense p { color: var(--danger); }
        .table-container { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .filters-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>FluxoPro <span style="color:var(--primary)">Brasil</span></h1>
        <nav>
            <button onclick="switchTab('dash')" id="btn-dash" class="nav-btn active">Dashboard</button>
            <button onclick="switchTab('list')" id="btn-list" class="nav-btn">Lan√ßamentos</button>
            <button onclick="switchTab('config')" id="btn-config" class="nav-btn">Fiscal/Config</button>
        </nav>
    </div>
</header>

<main>
    <section id="tab-dash" class="tab-content active">
        <div class="filters-row">
            <select id="dash-filter-type" onchange="updateDashboard()" style="width: auto;">
                <option value="todos">Todos os Tipos</option>
                <option value="Entrada">Apenas Entradas</option>
                <option value="Sa√≠da">Apenas Sa√≠das</option>
            </select>
        </div>

        <div class="kpi-grid">
            <div class="card"><h3>Saldo Geral</h3><p id="total-saldo">R$ 0,00</p></div>
            <div class="card income"><h3>Entradas</h3><p id="total-entradas">R$ 0,00</p></div>
            <div class="card expense"><h3>Sa√≠das</h3><p id="total-saidas">R$ 0,00</p></div>
            <div class="card warning" id="mei-card" style="display:none; border-left: 5px solid var(--warning);">
                <h3>Limite MEI (Brasil)</h3>
                <div style="background:#eee; height:10px; border-radius:5px; margin:10px 0;"><div id="mei-bar" style="background:var(--primary); height:100%; width:0%; border-radius:5px;"></div></div>
                <small id="mei-desc"></small>
            </div>
        </div>
        <div class="card">
            <h3>Gr√°fico por Categoria</h3>
            <canvas id="ctxCategorias" height="100"></canvas>
        </div>
    </section>

    <section id="tab-list" class="tab-content">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <button onclick="openModal()" class="btn btn-primary">+ Novo Lan√ßamento</button>
            <div style="display: flex; gap: 10px;">
                <button onclick="exportExcel()" class="btn" style="background:var(--success); color:white;">Excel</button>
                <button onclick="exportPDF()" class="btn" style="background:var(--danger); color:white;">PDF</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Observa√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-corpo"></tbody>
            </table>
        </div>
    </section>

    <section id="tab-config" class="tab-content">
        <div class="card" style="max-width: 500px; margin: auto;">
            <h2>Configura√ß√µes Fiscais</h2>
            <div class="form-group">
                <label>Perfil</label>
                <select id="conf-tipo" onchange="toggleMEI()">
                    <option value="PF">Pessoa F√≠sica (CPF)</option>
                    <option value="MEI">MEI (Brasil)</option>
                    <option value="PJ">Pessoa Jur√≠dica (CNPJ)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nome / Raz√£o Social</label>
                <input type="text" id="conf-nome">
            </div>
            <div class="form-group">
                <label>Digite o CPF / CNPJ / MEI</label>
                <input type="text" id="conf-doc" placeholder="000.000.000-00">
            </div>
            <button onclick="saveConfig()" class="btn btn-primary" style="width: 100%;">Salvar Perfil</button>
        </div>
    </section>
</main>

<div id="modal-entry" class="modal">
    <div class="modal-content">
        <h2>Lan√ßamento</h2>
        <form id="form-transacao">
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Data</label><input type="date" id="f-data" required></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label>Tipo</label><select id="f-tipo"><option value="Entrada">Entrada</option><option value="Sa√≠da">Sa√≠da</option></select></div>
                <div class="form-group"><label>Destina√ß√£o</label><select id="f-dest"><option value="Pessoal">Pessoal</option><option value="Empresarial">Empresarial</option></select></div>
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="f-cat">
                    <option>Alimenta√ß√£o</option><option>Moradia</option><option>Transporte</option>
                    <option>DAS (MEI)</option><option>Impostos</option><option>Marketing</option>
                    <option>Equipamentos</option><option>Sa√∫de</option><option>Outros</option>
                </select>
            </div>
            <div class="form-group"><label>Valor (R$)</label><input type="number" id="f-valor" step="0.01" required></div>
            <div class="form-group"><label>Observa√ß√µes</label><textarea id="f-obs" rows="2"></textarea></div>
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="closeModal()" class="btn" style="flex:1; background:#ccc;">Cancelar</button>
                <button type="submit" class="btn btn-primary" style="flex:2;">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const LIMITE_MEI = 81000;
    let db = JSON.parse(localStorage.getItem('fluxopro_db')) || { profile: {tipo:'PF', doc:'', nome:''}, entries: [] };
    let chartInstance = null;

    function save() { localStorage.setItem('fluxopro_db', JSON.stringify(db)); renderTable(); updateDashboard(); }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('btn-' + tab).classList.add('active');
    }

    function openModal(id = null) {
        document.getElementById('modal-entry').style.display = 'flex';
        const form = document.getElementById('form-transacao');
        form.reset();
        document.getElementById('edit-id').value = "";
        if(id) {
            const e = db.entries.find(x => x.id === id);
            document.getElementById('edit-id').value = e.id;
            document.getElementById('f-data').value = e.data;
            document.getElementById('f-tipo').value = e.tipo;
            document.getElementById('f-dest').value = e.dest;
            document.getElementById('f-cat').value = e.categoria;
            document.getElementById('f-valor').value = e.valor;
            document.getElementById('f-obs').value = e.obs || "";
        }
    }

    function closeModal() { document.getElementById('modal-entry').style.display = 'none'; }

    document.getElementById('form-transacao').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const entry = {
            id: id || Date.now(),
            data: document.getElementById('f-data').value,
            tipo: document.getElementById('f-tipo').value,
            dest: document.getElementById('f-dest').value,
            categoria: document.getElementById('f-cat').value,
            valor: parseFloat(document.getElementById('f-valor').value),
            obs: document.getElementById('f-obs').value
        };
        if(id) {
            const idx = db.entries.findIndex(x => x.id == id);
            db.entries[idx] = entry;
        } else {
            db.entries.push(entry);
        }
        save(); closeModal();
    };

    function renderTable() {
        const corpo = document.getElementById('lista-corpo');
        corpo.innerHTML = db.entries.sort((a,b) => b.id - a.id).map(e => `
            <tr>
                <td>${e.data}</td>
                <td style="color:${e.tipo === 'Entrada' ? 'green' : 'red'}"><b>${e.tipo}</b></td>
                <td>${e.categoria}</td>
                <td>R$ ${e.valor.toFixed(2)}</td>
                <td style="font-size:0.8rem; color:#666">${e.obs || '-'}</td>
                <td>
                    <button onclick="openModal(${e.id})" style="border:none; background:none; cursor:pointer">‚úèÔ∏è</button>
                    <button onclick="deleteEntry(${e.id})" style="border:none; background:none; cursor:pointer">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }

    function deleteEntry(id) { if(confirm("Excluir?")) { db.entries = db.entries.filter(e => e.id !== id); save(); } }

    function updateDashboard() {
        const filterType = document.getElementById('dash-filter-type').value;
        let filtered = db.entries;
        if(filterType !== 'todos') filtered = db.entries.filter(e => e.tipo === filterType);

        const entradas = filtered.filter(e => e.tipo === 'Entrada').reduce((a, b) => a + b.valor, 0);
        const saidas = filtered.filter(e => e.tipo === 'Sa√≠da').reduce((a, b) => a + b.valor, 0);

        document.getElementById('total-entradas').innerText = `R$ ${entradas.toFixed(2)}`;
        document.getElementById('total-saidas').innerText = `R$ ${saidas.toFixed(2)}`;
        document.getElementById('total-saldo').innerText = `R$ ${(entradas - saidas).toFixed(2)}`;

        if(db.profile.tipo === 'MEI') {
            document.getElementById('mei-card').style.display = 'block';
            const fatMEI = db.entries.filter(e => e.dest === 'Empresarial' && e.tipo === 'Entrada').reduce((a, b) => a + b.valor, 0);
            const perc = (fatMEI / LIMITE_MEI) * 100;
            document.getElementById('mei-bar').style.width = Math.min(perc, 100) + '%';
            document.getElementById('mei-desc').innerText = `Faturado R$ ${fatMEI.toFixed(2)} de R$ 81.000,00`;
        } else {
            document.getElementById('mei-card').style.display = 'none';
        }
        updateChart(filtered);
    }

    function updateChart(data) {
        const ctx = document.getElementById('ctxCategorias').getContext('2d');
        const labels = [...new Set(data.map(e => e.categoria))];
        const vals = labels.map(l => data.filter(e => e.categoria === l).reduce((a, b) => a + b.valor, 0));
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Total R$', data: vals, backgroundColor: '#2563eb' }] }
        });
    }

    function saveConfig() {
        db.profile = {
            tipo: document.getElementById('conf-tipo').value,
            nome: document.getElementById('conf-nome').value,
            doc: document.getElementById('conf-doc').value
        };
        save(); alert("Perfil Fiscal Atualizado!");
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db.entries);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados");
        XLSX.writeFile(wb, "FluxoPro_Dados.xlsx");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text("FluxoPro Brasil - Relat√≥rio Financeiro", 14, 20);
        doc.setFontSize(10);
        doc.text(`Usu√°rio: ${db.profile.nome} | Documento: ${db.profile.doc}`, 14, 28);
        
        const rows = db.entries.map(e => [e.data, e.tipo, e.categoria, e.valor.toFixed(2), e.obs || ""]);
        doc.autoTable({ head: [['Data', 'Tipo', 'Categoria', 'Valor', 'Obs']], body: rows, startY: 35 });
        doc.save("Relatorio_Financeiro.pdf");
    }

    // Carregar dados nos inputs de config ao iniciar
    window.onload = () => {
        document.getElementById('conf-tipo').value = db.profile.tipo || 'PF';
        document.getElementById('conf-nome').value = db.profile.nome || '';
        document.getElementById('conf-doc').value = db.profile.doc || '';
        renderTable(); updateDashboard();
    };
</script>
</body>
</html>
