<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v11</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
--bg:#f4f6fb;
--card:#ffffff;
--primary:#4f46e5;
--danger:#ef4444;
--success:#22c55e;
--text:#0f172a;
--muted:#64748b;
--radius:14px;
}

body{
margin:0;
font-family:Inter,system-ui;
background:var(--bg);
color:var(--text);
}

header{
background:#fff;
padding:14px 24px;
display:flex;
align-items:center;
justify-content:space-between;
box-shadow:0 6px 18px rgba(0,0,0,.05);
position:sticky;
top:0;
z-index:10;
}

nav button{
border:none;
background:#eee;
padding:10px 18px;
border-radius:12px;
cursor:pointer;
font-weight:600;
}

nav button.active{
background:var(--primary);
color:#fff;
}

.container{
padding:24px;
max-width:1400px;
margin:auto;
}

.card{
background:var(--card);
border-radius:var(--radius);
padding:18px;
box-shadow:0 12px 30px rgba(15,23,42,.05);
margin-bottom:20px;
}

.controls{
display:flex;
gap:10px;
flex-wrap:wrap;
}

button.primary{
background:var(--primary);
color:#fff;
border:none;
padding:10px 16px;
border-radius:10px;
cursor:pointer;
}

button.soft{
background:#eee;
border:none;
padding:10px 16px;
border-radius:10px;
cursor:pointer;
}

table{
width:100%;
border-collapse:collapse;
font-size:14px;
}

th,td{
padding:10px;
border-bottom:1px solid #e5e7eb;
}

th{
background:#f8fafc;
text-align:left;
}

td[contenteditable]{
background:#f8fafc;
border-radius:6px;
}

.badge{
padding:6px 12px;
border-radius:999px;
font-weight:600;
font-size:12px;
display:inline-block;
}

.entrada{background:#dcfce7;color:#166534;}
.saida{background:#fee2e2;color:#991b1b;}

.flex{
display:flex;
gap:16px;
flex-wrap:wrap;
}

.card-mini{
flex:1;
min-width:220px;
padding:16px;
border-radius:14px;
background:#fff;
box-shadow:0 8px 20px rgba(0,0,0,.05);
}

select,input{
padding:8px 10px;
border-radius:8px;
border:1px solid #e5e7eb;
}

.theme-dark{--bg:#020617;--card:#020617;color:#fff;}
.theme-gold{--primary:#d4af37;}
.theme-emerald{--primary:#059669;}
.theme-indigo{--primary:#4f46e5;}
.theme-rose{--primary:#e11d48;}
</style>
</head>
<body>

<header>
<strong>FluxoPro Engine v11</strong>

<div class="controls">
<select id="profileSelect"></select>
<button class="soft" onclick="addProfile()">+</button>
</div>

<nav>
<button onclick="showTab('lancamentos')" class="active">Lan√ßamentos</button>
<button onclick="showTab('dashboard')">Dashboard</button>
<button onclick="showTab('config')">Configura√ß√µes</button>
</nav>
</header>

<div class="container">

<!-- ================= LANCAMENTOS ================= -->

<div id="tab-lancamentos">

<div class="card controls">
<button class="primary" onclick="novoLancamento()">Novo lan√ßamento</button>
<input type="file" id="fileInput">
<button class="soft" onclick="importarArquivo()">Alimentar perfil</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Pessoa (CPF/CNPJ)</th>
<th>Data</th>
<th>Categoria</th>
<th>Tipo</th>
<th>Valor</th>
<th>Observa√ß√£o</th>
<th>Editar</th>
<th>Apagar</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="card flex">
<div class="card-mini">
<strong>Total Entradas</strong>
<h3 id="totalEntradas">R$ 0,00</h3>
</div>
<div class="card-mini">
<strong>Total Sa√≠das</strong>
<h3 id="totalSaidas">R$ 0,00</h3>
</div>
<div class="card-mini">
<strong>Resultado</strong>
<h3 id="resultado">R$ 0,00</h3>
</div>
</div>

</div>

<!-- ================= DASHBOARD ================= -->

<div id="tab-dashboard" style="display:none">

<div class="card flex">
<div class="card-mini">
<strong>Sa√∫de Financeira</strong>
<p id="saude"></p>
</div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

</div>

<!-- ================= CONFIG ================= -->

<div id="tab-config" style="display:none">

<div class="card">

<h3>Painel de Controle</h3>

<div class="controls">
<select onchange="setTheme(this.value)">
<option value="">Tema padr√£o</option>
<option value="theme-dark">Dark</option>
<option value="theme-gold">Gold</option>
<option value="theme-emerald">Emerald</option>
<option value="theme-indigo">Indigo</option>
<option value="theme-rose">Rose</option>
</select>

<button class="soft" onclick="exportarTudo()">Backup global</button>
<button class="soft" onclick="resetar()">Reset de f√°brica</button>
</div>

</div>

</div>

</div>

<script>
const DB_KEY="fluxopro_v11";
let chart;

function loadDB(){
return JSON.parse(localStorage.getItem(DB_KEY) || '{"profiles":{},"theme":""}');
}
function saveDB(db){
localStorage.setItem(DB_KEY,JSON.stringify(db));
}

function currentProfile(){
return document.getElementById("profileSelect").value;
}

function normalizeValue(v){
if(v===undefined||v===null)return 0;
let s=String(v).replace(/[R$\s]/g,'');
if(s.includes(",") && s.includes(".")){
if(s.lastIndexOf(",")>s.lastIndexOf(".")){
s=s.replace(/\./g,"").replace(",",".");
}else{
s=s.replace(/,/g,"");
}
}else{
s=s.replace(",",".");
}
let n=parseFloat(s);
return isNaN(n)?null:n;
}

function renderProfiles(){
let db=loadDB();
let sel=document.getElementById("profileSelect");
sel.innerHTML="";
Object.keys(db.profiles).forEach(p=>{
let o=document.createElement("option");
o.value=p;
o.textContent=p;
sel.appendChild(o);
});
if(sel.options.length) sel.value=sel.options[0].value;
renderTable();
}

function addProfile(){
let nome=prompt("CPF / CNPJ / Identificador:");
if(!nome) return;
let db=loadDB();
db.profiles[nome]=[];
saveDB(db);
renderProfiles();
}

document.getElementById("profileSelect").addEventListener("change",renderTable);

function novoLancamento(){
let db=loadDB();
db.profiles[currentProfile()].push({
pessoa:"",
data:"",
categoria:"",
tipo:"Entrada",
valor:0,
obs:""
});
saveDB(db);
renderTable();
}

function renderTable(){
let db=loadDB();
let list=db.profiles[currentProfile()]||[];
let tbody=document.getElementById("tbody");
tbody.innerHTML="";
let frag=document.createDocumentFragment();

list.forEach((r,i)=>{
let tr=document.createElement("tr");

tr.innerHTML=`
<td contenteditable data-f="pessoa">${r.pessoa||""}</td>
<td contenteditable data-f="data">${r.data||""}</td>
<td contenteditable data-f="categoria">${r.categoria||""}</td>
<td data-f="tipo">
<span class="badge ${r.tipo==="Entrada"?"entrada":"saida"}">${r.tipo}</span>
</td>
<td contenteditable data-f="valor">R$ ${Number(r.valor).toFixed(2).replace(".",",")}</td>
<td contenteditable data-f="obs">${r.obs||""}</td>
<td><button class="soft" onclick="toggleTipo(${i})">Editar</button></td>
<td><button class="soft" onclick="remover(${i})">üóë</button></td>
`;

tr.querySelectorAll("[contenteditable]").forEach(td=>{
td.onblur=()=>updateCell(i,td.dataset.f,td.innerText);
});

frag.appendChild(tr);
});

tbody.appendChild(frag);
calcularTotais();
renderChart();
}

function updateCell(i,field,value){
let db=loadDB();
let row=db.profiles[currentProfile()][i];

if(field==="valor"){
let n=normalizeValue(value);
if(n===null){
alert("Valor inv√°lido");
renderTable();
return;
}
row.valor=n;
}else{
row[field]=value.trim();
}
saveDB(db);
renderTable();
}

function toggleTipo(i){
let db=loadDB();
let r=db.profiles[currentProfile()][i];
r.tipo = r.tipo==="Entrada"?"Sa√≠da":"Entrada";
saveDB(db);
renderTable();
}

function remover(i){
let db=loadDB();
db.profiles[currentProfile()].splice(i,1);
saveDB(db);
renderTable();
}

function calcularTotais(){
let db=loadDB();
let list=db.profiles[currentProfile()]||[];
let ent=0, sai=0;

list.forEach(r=>{
if(r.tipo==="Entrada") ent+=Number(r.valor)||0;
else sai+=Number(r.valor)||0;
});

document.getElementById("totalEntradas").textContent=ent.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
document.getElementById("totalSaidas").textContent=sai.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
document.getElementById("resultado").textContent=(ent-sai).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let saude=document.getElementById("saude");
if(ent===0 && sai===0) saude.textContent="Perfil sem dados.";
else if(ent>sai) saude.textContent="Boa sa√∫de financeira. Continue controlando os custos.";
else saude.textContent="Aten√ß√£o: suas sa√≠das superam as entradas.";
}

function renderChart(){
let db=loadDB();
let list=db.profiles[currentProfile()]||[];

let cat={};
list.forEach(r=>{
let k=r.categoria||"Sem categoria";
let v=Number(r.valor)||0;
if(r.tipo==="Sa√≠da") v*=-1;
cat[k]=(cat[k]||0)+v;
});

let labels=Object.keys(cat);
let data=Object.values(cat);

if(chart) chart.destroy();

chart=new Chart(document.getElementById("chart"),{
type:"bar",
data:{
labels,
datasets:[{label:"Resultado por categoria",data}]
}
});
}

function importarArquivo(){
let f=document.getElementById("fileInput").files[0];
if(!f) return;

let reader=new FileReader();
reader.onload=e=>{
let data=new Uint8Array(e.target.result);
let wb=XLSX.read(data,{type:"array"});
let ws=wb.Sheets[wb.SheetNames[0]];
let json=XLSX.utils.sheet_to_json(ws);

let db=loadDB();

json.forEach(l=>{
let valor=normalizeValue(l.Valor||l.valor);
if(valor===null) return;

db.profiles[currentProfile()].push({
pessoa:l.Pessoa||l.CPF||l.CNPJ||"",
data:l.Data||"",
categoria:l.Categoria||"",
tipo:(String(l.Tipo).toLowerCase().includes("sa")?"Sa√≠da":"Entrada"),
valor,
obs:l.Observacao||l.Observa√ß√£o||""
});
});

saveDB(db);
renderTable();
};
reader.readAsArrayBuffer(f);
}

function exportarTudo(){
let db=loadDB();
let rows=[];
Object.entries(db.profiles).forEach(([p,arr])=>{
arr.forEach(r=>rows.push({...r,Perfil:p}));
});
let ws=XLSX.utils.json_to_sheet(rows);
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Banco");
XLSX.writeFile(wb,"fluxopro_backup.xlsx");
}

function resetar(){
if(confirm("Apagar todos os dados?")){
localStorage.removeItem(DB_KEY);
location.reload();
}
}

function setTheme(t){
document.body.className=t;
let db=loadDB();
db.theme=t;
saveDB(db);
}

function showTab(t){
document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
event.target.classList.add("active");

["lancamentos","dashboard","config"].forEach(id=>{
document.getElementById("tab-"+id).style.display=id===t?"block":"none";
});
renderChart();
}

(function init(){
let db=loadDB();
if(!Object.keys(db.profiles).length){
db.profiles["Perfil 1"]=[];
saveDB(db);
}
if(db.theme) document.body.className=db.theme;
renderProfiles();
})();
</script>

</body>
</html>
