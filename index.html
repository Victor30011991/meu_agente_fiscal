<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Meu Agente Fiscal ‚Ä¢ Controle Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libs obrigat√≥rias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --primary:#6366f1;
  --success:#22c55e;
  --danger:#ef4444;
  --radius:12px;
}

body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial;
  background:linear-gradient(160deg,#020617,#0f172a);
  color:var(--text);
}

header{
  padding:16px 24px;
  font-size:22px;
  font-weight:700;
}

.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

.flex{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

input,select,button{
  background:#020617;
  border:1px solid #1f2933;
  color:var(--text);
  padding:8px 10px;
  border-radius:8px;
}

button{
  cursor:pointer;
}

button.primary{
  background:var(--primary);
  border:none;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  border-bottom:1px solid #1f2933;
}

tr:hover{
  background:#020617;
}

.badge{
  font-size:13px;
  color:var(--muted);
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}

.resumo h2{
  margin:0;
  font-size:18px;
}

.resumo span{
  font-size:20px;
  font-weight:700;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.modal .box{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  width:320px;
}

footer{
  text-align:center;
  color:var(--muted);
  padding:20px;
}
</style>
</head>

<body>

<header>Meu Agente Fiscal</header>

<div class="container">

<div class="card flex">

  <div class="flex">
    <span class="badge">Perfil</span>
    <select id="select-perfil"></select>
    <button id="btn-novo-perfil">Novo perfil</button>
  </div>

  <div class="flex">
    <span class="badge">Tema</span>
    <select id="tema-seletor">
      <option value="default">Padr√£o</option>
    </select>

    <label class="badge">
      <input type="checkbox" id="cfg-privacidade"> Privacidade
    </label>
  </div>

  <div style="margin-left:auto">
    <button class="primary" onclick="document.getElementById('modalAdd').style.display='flex'">
      Novo lan√ßamento
    </button>
  </div>

</div>


<div class="cards">

  <div class="card resumo">
    <h2>Entradas</h2>
    <span id="resumo-entradas">R$ 0,00</span>
  </div>

  <div class="card resumo">
    <h2>Sa√≠das</h2>
    <span id="resumo-saidas">R$ 0,00</span>
  </div>

  <div class="card resumo">
    <h2>Saldo</h2>
    <span id="resumo-saldo">R$ 0,00</span>
  </div>

</div>


<div class="card flex">

  <div>
    <span class="badge">In√≠cio</span><br>
    <input type="date" id="filtro-inicio">
  </div>

  <div>
    <span class="badge">Fim</span><br>
    <input type="date" id="filtro-fim">
  </div>

  <button id="btn-filtrar">Filtrar</button>
  <button id="btn-limpar-filtro">Limpar</button>

</div>


<div class="card">

<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Categoria</th>
      <th>Tipo</th>
      <th>Valor</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="corpo-tabela"></tbody>
</table>

</div>


<div class="card flex">

  <label>
    <input type="checkbox" id="exp-charts" checked>
    Incluir gr√°ficos
  </label>

  <label>
    <input type="checkbox" id="exp-lancamentos" checked>
    Incluir lan√ßamentos
  </label>

  <button id="btn-gerar-pdf">Gerar PDF</button>
  <button id="btn-gerar-excel">Gerar Excel</button>

</div>

</div>


<!-- MODAL -->
<div class="modal" id="modalAdd">

  <div class="box">

    <form id="form-registro">

      <h3>Novo lan√ßamento</h3>

      <div class="badge">Data</div>
      <input id="f-data" type="date" required>

      <div class="badge">Categoria</div>
      <input id="f-cat" required>

      <div class="badge">Tipo</div>
      <select id="f-tipo">
        <option>Entrada</option>
        <option>Sa√≠da</option>
      </select>

      <div class="badge">Valor</div>
      <input id="f-valor" required>

      <div class="flex" style="margin-top:10px">
        <button type="submit" class="primary">Salvar</button>
        <button type="button" onclick="document.getElementById('modalAdd').style.display='none'">
          Cancelar
        </button>
      </div>

    </form>

  </div>

</div>

<footer>Meu Agente Fiscal ‚Ä¢ vers√£o inicial</footer>


<script>
/* ==== SEU JS (ajustado apenas para n√£o quebrar gr√°ficos quando n√£o existirem) ==== */

const FluxoPro = (() => {

  const STORAGE = {
    db: 'fpro_v12_db',
    perfis: 'fpro_v12_perfs',
    ativo: 'fpro_v12_ativo',
    cfg: 'fpro_v12_cfg'
  };

  const state = {
    db: JSON.parse(localStorage.getItem(STORAGE.db)) || [],
    perfis: JSON.parse(localStorage.getItem(STORAGE.perfis)) || ["Geral"],
    perfilAtivo: localStorage.getItem(STORAGE.ativo) || "Geral",
    config: JSON.parse(localStorage.getItem(STORAGE.cfg)) || { tema:'default', privacidade:false },
    filtro:{ ini:null, fim:null }
  };

  let charts = {};

  const Utils = {
    uuid(){ return Math.random().toString(36).substring(2,10); },
    clean(v){
      if(typeof v === 'number') return v;
      return parseFloat(String(v).replace(/[^\d,-]/g,'').replace(',','.')) || 0;
    },
    money(v){
      if(state.config.privacidade) return 'R$ ****';
      return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    }
  };

  const Store = {
    save(){
      localStorage.setItem(STORAGE.db,JSON.stringify(state.db));
      localStorage.setItem(STORAGE.perfis,JSON.stringify(state.perfis));
      localStorage.setItem(STORAGE.ativo,state.perfilAtivo);
      localStorage.setItem(STORAGE.cfg,JSON.stringify(state.config));
    }
  };

  const FinanceService = {

    list(){
      let dados = state.db.filter(l=>l.perfil===state.perfilAtivo);

      if(state.filtro.ini)
        dados = dados.filter(d=>d.data >= state.filtro.ini);
      if(state.filtro.fim)
        dados = dados.filter(d=>d.data <= state.filtro.fim);

      return dados.sort((a,b)=>new Date(b.data)-new Date(a.data));
    },

    add(data){
      state.db.push(data);
      Store.save();
    },

    update(id,field,value){
      const l = state.db.find(i=>i.id===id);
      if(!l) return;
      l[field] = field==='valor' ? Utils.clean(value) : value;
      Store.save();
    },

    remove(id){
      state.db = state.db.filter(i=>i.id!==id);
      Store.save();
    },

    toggleTipo(id){
      const l = state.db.find(i=>i.id===id);
      if(!l) return;
      l.tipo = l.tipo==='Entrada'?'Sa√≠da':'Entrada';
      Store.save();
    },

    resumo(){
      const dados = this.list();
      let ent=0, sai=0;
      dados.forEach(i=>{
        if(i.tipo==='Entrada') ent+=i.valor;
        else sai+=i.valor;
      });
      return { ent, sai, saldo: ent - sai };
    }

  };

  const ProfileService = {

    list(){ return state.perfis; },

    add(nome){
      state.perfis.push(nome);
      state.perfilAtivo = nome;
      Store.save();
    },

    setAtivo(nome){
      state.perfilAtivo = nome;
      Store.save();
    }

  };

  const UI = {

    renderTabela(){
      const dados = FinanceService.list();
      const corpo = document.getElementById('corpo-tabela');

      if(!dados.length){
        corpo.innerHTML = '<tr><td colspan="5">Sem dados.</td></tr>';
        return;
      }

      corpo.innerHTML = dados.map(i=>`
        <tr data-id="${i.id}">
          <td contenteditable data-f="data">${i.data}</td>
          <td contenteditable data-f="cat">${i.cat}</td>
          <td>
            <button class="btn-tipo" style="border:none;background:none;font-weight:700;color:${i.tipo==='Entrada'?'var(--success)':'var(--danger)'}">
              ${i.tipo}
            </button>
          </td>
          <td contenteditable data-f="valor">${Utils.money(i.valor)}</td>
          <td><button class="btn-del" style="border:none;background:none">üóëÔ∏è</button></td>
        </tr>
      `).join('');
    },

    renderResumo(){
      const r = FinanceService.resumo();
      document.getElementById('resumo-entradas').innerText = Utils.money(r.ent);
      document.getElementById('resumo-saidas').innerText   = Utils.money(r.sai);
      const saldoEl = document.getElementById('resumo-saldo');
      saldoEl.innerText = Utils.money(r.saldo);
      saldoEl.style.color = r.saldo < 0 ? 'var(--danger)' : 'var(--success)';
    },

    renderPerfis(){
      const sel = document.getElementById('select-perfil');
      sel.innerHTML = ProfileService.list()
        .map(p=>`<option ${p===state.perfilAtivo?'selected':''}>${p}</option>`).join('');
    }

  };

  const ExportService = {

    async pdf(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y=20;

      doc.setFontSize(18);
      doc.text('Meu Agente Fiscal - Relat√≥rio',15,y);
      y+=10;
      doc.text(`Perfil: ${state.perfilAtivo}`,15,y);
      y+=10;

      if(document.getElementById('exp-lancamentos').checked){
        const dados = FinanceService.list();
        dados.forEach(l=>{
          if(y>280){doc.addPage();y=20;}
          doc.text(`${l.data} | ${l.cat} | ${l.tipo} | ${Utils.money(l.valor)}`,15,y);
          y+=7;
        });
      }

      doc.save(`Relatorio_${state.perfilAtivo}.pdf`);
    },

    excel(){
      const dados = FinanceService.list();
      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Financeiro');
      XLSX.writeFile(wb,`Financeiro_${state.perfilAtivo}.xlsx`);
    }

  };

  function bind(){

    document.getElementById('form-registro').onsubmit = e=>{
      e.preventDefault();

      FinanceService.add({
        id: Utils.uuid(),
        perfil: state.perfilAtivo,
        data: document.getElementById('f-data').value,
        cat: document.getElementById('f-cat').value,
        tipo: document.getElementById('f-tipo').value,
        valor: Utils.clean(document.getElementById('f-valor').value)
      });

      document.getElementById('modalAdd').style.display='none';
      e.target.reset();
      refresh();
    };

    document.getElementById('corpo-tabela').addEventListener('click',e=>{
      const tr = e.target.closest('tr');
      if(!tr) return;
      const id = tr.dataset.id;

      if(e.target.classList.contains('btn-del')){
        FinanceService.remove(id);
        refresh();
      }

      if(e.target.classList.contains('btn-tipo')){
        FinanceService.toggleTipo(id);
        refresh();
      }
    });

    document.getElementById('corpo-tabela').addEventListener('blur',e=>{
      const td = e.target;
      const tr = td.closest('tr');
      if(!tr || !td.dataset.f) return;
      FinanceService.update(tr.dataset.id,td.dataset.f,td.innerText);
      refresh();
    },true);

    document.getElementById('select-perfil').onchange = e=>{
      ProfileService.setAtivo(e.target.value);
      refresh();
    };

    document.getElementById('btn-novo-perfil').onclick=()=>{
      const n = prompt('Novo perfil');
      if(n){ProfileService.add(n);refresh();}
    };

    document.getElementById('tema-seletor').onchange=e=>{
      state.config.tema=e.target.value;
      Store.save();
    };

    document.getElementById('cfg-privacidade').onchange=e=>{
      state.config.privacidade=e.target.checked;
      Store.save();
      refresh();
    };

    document.getElementById('btn-filtrar').onclick=()=>{
      state.filtro.ini = document.getElementById('filtro-inicio').value||null;
      state.filtro.fim = document.getElementById('filtro-fim').value||null;
      refresh();
    };

    document.getElementById('btn-limpar-filtro').onclick=()=>{
      state.filtro={ini:null,fim:null};
      document.getElementById('filtro-inicio').value='';
      document.getElementById('filtro-fim').value='';
      refresh();
    };

    document.getElementById('btn-gerar-pdf').onclick=()=>ExportService.pdf();
    document.getElementById('btn-gerar-excel').onclick=()=>ExportService.excel();

  }

  function refresh(){
    UI.renderTabela();
    UI.renderResumo();
  }

  function init(){
    UI.renderPerfis();
    bind();
    refresh();
  }

  return { init };

})();

window.onload = ()=>FluxoPro.init();
</script>

</body>
</html>
