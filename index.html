<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro Engine v12</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tema principal -->
<link id="themeCSS" rel="stylesheet" href="">
<!-- Paleta de cores din√¢mica -->
<link rel="stylesheet" href="./themes/palette.css">

<style>
/* (Seu CSS original, mantido e indentado) */
... <!-- omitido para brevidade ‚Äî igual ao que voc√™ j√° usa -->
</style>
</head>

<body>

<header>
  <strong>FluxoPro Engine v12</strong>

  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <select id="perfilSelect"></select>
    <button id="novoPerfil">+</button>

    <!-- Seletor de temas -->
    <div class="theme-selector">
      <button class="theme-btn theme-default active" data-theme=""></button>
      <button class="theme-btn theme-dark" data-theme="dark"></button>
      <button class="theme-btn theme-emerald" data-theme="emerald"></button>
      <button class="theme-btn theme-gold" data-theme="gold"></button>
      <button class="theme-btn theme-indigo" data-theme="indigo"></button>
      <button class="theme-btn theme-rose" data-theme="rose"></button>
    </div>

    <!-- COLOR PICKER (paleta livre) -->
    <input type="color" id="colorPicker" title="Cor principal" style="width:32px;height:32px;border:none;padding:0;">

    <div class="tabs">
      <button data-tab="lanc" class="active">Lan√ßamentos</button>
      <button data-tab="conf">Configura√ß√µes</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="layout">
  
  <!-- LATERAL COM RESUMOS -->
  <aside class="sidebar">
    <div class="card">
      <h3>Resumo geral</h3>
      <div class="resume">
        <div>Entradas<br><span id="sumEnt">R$ 0,00</span></div>
        <div>Sa√≠das<br><span id="sumSai">R$ 0,00</span></div>
        <div>Resultado<br><span id="sumRes">R$ 0,00</span></div>
      </div>

      <div class="actions">
        <button onclick="abrirExport()">üìä Exportar</button>
        <button onclick="abrirImport()">üì• Importar</button>
      </div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="gridDash">
      <div class="card"><h4>Distribui√ß√£o por categoria</h4><canvas id="chartPizza"></canvas></div>
      <div class="card"><h4>Entradas x Sa√≠das</h4><canvas id="chartPerc"></canvas></div>
      <div class="card"><h4>Resumo</h4><canvas id="chartResumo"></canvas></div>
    </div>
  </aside>

  <!-- CONTE√öDO PRINCIPAL -->
  <main>
    <section id="tab-lanc">
      <div class="actions">
        <button class="main" id="novoLanc">‚ûï Novo lan√ßamento</button>
        <button id="refreshBtn">üîÑ Refresh</button>
      </div>

      <div class="card">
        <h3>Dados do perfil</h3>
        <input id="perfilNome" placeholder="Nome / Raz√£o social">
        <input id="perfilDoc" placeholder="CPF ou CNPJ">
      </div>

      <div class="card">
        <table>
          <thead><tr>
            <th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Observ.</th><th>Apagar</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-conf" class="hidden">
      <div class="card">
        <h3>Configura√ß√µes</h3>
        <button id="exportAll">Relat√≥rio (Excel / PDF)</button>
        <button id="resetAll" style="background:#ef4444;color:#fff">Reset de f√°brica</button>
      </div>
    </section>
  </main>

  </div>
</div>

<!-- MODAL DE LANCAMENTO -->
<div class="modal" id="modal">
  <div class="card">
    <h3>Novo lan√ßamento</h3>
    <form id="form">
      <input type="date" id="data" required><br><br>
      <input type="text" id="cat" placeholder="Categoria" required><br><br>
      <select id="tipo"><option>Entrada</option><option>Sa√≠da</option></select><br><br>
      <input type="text" id="valor" placeholder="Valor" required><br><br>
      <textarea id="obs" placeholder="Observa√ß√£o (opcional)"></textarea><br><br>
      <button type="submit" class="main">Salvar</button>
      <button type="button" onclick="fecharModal()">Cancelar</button>
    </form>
  </div>
</div>

<script>
/* ‚Äî‚Äî‚Äî VARI√ÅVEIS GLOBAIS ‚Äî‚Äî‚Äî */
const KEY="fluxopro_v12";
let charts = {};
let debounceTimer;

/* ‚Äî‚Äî‚Äî FUN√á√ïES DE BANCO ‚Äî‚Äî‚Äî */
function loadDB(){
  try {
    const raw = localStorage.getItem(KEY);
    if(!raw) return {active:"default",profiles:{default:[]},profileInfo:{},theme:""};
    return JSON.parse(raw);
  } catch {
    return {active:"default",profiles:{default:[]},profileInfo:{},theme:""};
  }
}

function saveDB(db){
  localStorage.setItem(KEY,JSON.stringify(db));
}

/* ‚Äî‚Äî‚Äî UTILIT√ÅRIOS ‚Äî‚Äî‚Äî */
function normalizeValue(v){
  let s=String(v||"").replace(/[^\d.,-]/g,"").replace(",",".");
  let n=parseFloat(s);
  return isNaN(n)?null:n;
}

function formatMoney(v){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v||0);
}

function list(){
  const db=loadDB();
  return db.profiles[db.active]||[];
}

/* ‚Äî‚Äî‚Äî FUN√á√ïES DE RENDER ‚Äî‚Äî‚Äî */
function renderTable(){
  const dados=list();
  tbody.innerHTML = dados.map(i=>`
    <tr data-id="${i.id}">
      <td contenteditable data-f="data">${i.data||""}</td>
      <td contenteditable data-f="cat">${i.cat||""}</td>
      <td><span class="badge ${i.tipo==="Entrada"?"entrada":"saida"} btnTipo">${i.tipo}</span></td>
      <td contenteditable data-f="valor">${formatMoney(i.valor)}</td>
      <td contenteditable data-f="obs">${i.obs||""}</td>
      <td><button class="del">üóëÔ∏è</button></td>
    </tr>
  `).join("");
}

function updateResumo(){
  let e=0,s=0;
  list().forEach(i=> i.tipo==="Entrada"?e+=i.valor:s+=i.valor );
  sumEnt.innerText=formatMoney(e);
  sumSai.innerText=formatMoney(s);
  sumRes.innerText=formatMoney(e-s);
}

/* ‚Äî‚Äî‚Äî FUN√á√ïES DE TEMAS ‚Äî‚Äî‚Äî */
document.querySelectorAll(".theme-btn").forEach(btn=>{
  btn.onclick = ()=>{
    const theme=btn.dataset.theme;
    const db=loadDB();
    db.theme=theme;
    saveDB(db);
    document.querySelectorAll(".theme-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    themeCSS.href = theme ? `./themes/${theme}.css` : "";
  };
});

function loadTheme(){
  const db=loadDB();
  if(db.theme){
    themeCSS.href = `./themes/${db.theme}.css`;
    document.querySelector(`.theme-btn[data-theme="${db.theme}"]`)?.classList.add("active");
  }
}

/* ‚Äî‚Äî‚Äî PALETA DE CORES ‚Äî‚Äî‚Äî */
function applyPrimaryColor(color){
  document.documentElement.style.setProperty("--p",color);
}

document.getElementById("colorPicker").oninput = e=>{
  const color=e.target.value;
  const db=loadDB();
  db.primaryColor=color;
  saveDB(db);
  applyPrimaryColor(color);
};

function loadPrimaryColor(){
  const db=loadDB();
  if(db.primaryColor){
    applyPrimaryColor(db.primaryColor);
    colorPicker.value=db.primaryColor;
  }
}

/* ‚Äî‚Äî‚Äî A√á√ïES DE BOT√ïES ‚Äî‚Äî‚Äî */
function abrirImport(){
  const db=loadDB();
  window.open(`./import.html?perfil=${encodeURIComponent(db.active)}`,"_blank");
}

function abrirExport(){
  window.open("./export.html","_blank");
}

/* ‚Äî‚Äî‚Äî INICIALIZA√á√ÉO ‚Äî‚Äî‚Äî */
(function init(){
  const db=loadDB();
  saveDB(db);
  loadTheme(); loadPrimaryColor();
  renderTable(); updateResumo();
})();
</script>

</body>
</html>
