<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Importação</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{
  margin:0;
  font-family:Inter;
  background:#f5f7fb;
  color:#1f2937;
}
.container{
  max-width:700px;
  margin:auto;
  padding:40px 20px;
}
.card{
  background:#fff;
  padding:25px;
  border-radius:16px;
  box-shadow:0 10px 20px rgba(0,0,0,.05);
}
h1{margin-top:0}
input[type=file]{
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  width:100%;
}
button{
  margin-top:15px;
  padding:12px 16px;
  border-radius:10px;
  border:0;
  background:#4f46e5;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
small{color:#666}
.status{margin-top:15px;font-weight:600}
</style>
</head>
<body>

<div class="container">
  <div class="card">

    <h1>Importação de dados</h1>

    <p>
      Você pode importar:
      <br>• Excel (.xlsx)
      <br>• PDF gerado pelo próprio FluxoPro
    </p>

    <input type="file" id="file" accept=".xlsx,.xls,.pdf">

    <button onclick="importar()">Importar para o perfil ativo</button>

    <div class="status" id="status"></div>

    <small>
      Atenção: o PDF precisa ter sido gerado pelo módulo de relatórios do próprio sistema.
    </small>

  </div>
</div>

<script>
const KEY = "fluxopro_v12";

let db, perfil;

try{
  db = JSON.parse(localStorage.getItem(KEY));
  if(!db || !db.profiles) throw new Error();
  perfil = db.active;
}catch(e){
  alert("Base do sistema não encontrada.");
  throw e;
}

async function importar(){

  const input = document.getElementById("file");
  const file = input.files[0];

  if(!file){
    alert("Selecione um arquivo.");
    return;
  }

  const ext = file.name.split(".").pop().toLowerCase();

  status.innerText = "Lendo arquivo...";

  try{

    let registros = [];

    if(ext === "xlsx" || ext === "xls"){
      registros = await importarExcel(file);
    }
    else if(ext === "pdf"){
      registros = await importarPDF(file);
    }
    else{
      alert("Formato não suportado.");
      return;
    }

    if(!registros.length){
      alert("Nenhum lançamento encontrado no arquivo.");
      return;
    }

    if(!db.profiles[perfil]){
      db.profiles[perfil] = [];
    }

    db.profiles[perfil].push(...registros);

    localStorage.setItem(KEY, JSON.stringify(db));

    status.innerText = `Importação concluída. ${registros.length} registros inseridos.`;

  }catch(err){
    console.error(err);
    alert("Erro ao importar arquivo.");
    status.innerText = "";
  }

}

/* ---------------- EXCEL ---------------- */

function importarExcel(file){

  return new Promise((resolve,reject)=>{

    const reader = new FileReader();

    reader.onload = e =>{

      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data,{type:"array"});
      const ws = wb.Sheets[wb.SheetNames[0]];

      const json = XLSX.utils.sheet_to_json(ws,{defval:""});

      const lista = json.map(l => normalizarRegistro(l))
                         .filter(l => l && l.data && l.tipo && l.valor !== "");

      resolve(lista);

    };

    reader.onerror = reject;
    reader.readAsArrayBuffer(file);

  });

}

/* ---------------- PDF ---------------- */

async function importarPDF(file){

  const buffer = await file.arrayBuffer();

  const pdf = await pdfjsLib.getDocument({data:buffer}).promise;

  let textoCompleto = "";

  for(let p=1;p<=pdf.numPages;p++){

    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    const pageText = content.items.map(i=>i.str).join(" ");
    textoCompleto += "\n" + pageText;

  }

  return extrairLancamentosDoTexto(textoCompleto);

}

/*
  O PDF exportado pelo seu sistema imprime cada lançamento assim:

  data | categoria | tipo | valor | obs

  Aqui a leitura é baseada no padrão que o export.html gera.
*/

function extrairLancamentosDoTexto(texto){

  const linhas = texto.split(/\n/).map(l=>l.trim()).filter(l=>l);

  const registros = [];

  for(const linha of linhas){

    // procura data no padrão 0000-00-00
    const m = linha.match(/(\d{4}-\d{2}-\d{2})/);

    if(!m) continue;

    const data = m[1];

    const resto = linha.substring(linha.indexOf(data)+10).trim();

    const tipoMatch = resto.match(/\bEntrada\b|\bSaída\b|\bSaida\b/);

    if(!tipoMatch) continue;

    const tipo = tipoMatch[0] === "Entrada" ? "Entrada" : "Saída";

    const antesTipo = resto.substring(0, resto.indexOf(tipoMatch[0])).trim();
    const depoisTipo = resto.substring(resto.indexOf(tipoMatch[0]) + tipoMatch[0].length).trim();

    const valorMatch = depoisTipo.match(/R\$\s?[\d\.,]+/);

    if(!valorMatch) continue;

    const categoria = antesTipo.split(" ").slice(0,5).join(" ").trim();

    const valorStr = valorMatch[0]
      .replace("R$","")
      .replace(/\./g,"")
      .replace(",",".")
      .trim();

    const valor = Number(valorStr);

    const obs = depoisTipo
      .replace(valorMatch[0],"")
      .trim();

    registros.push({
      data,
      cat: categoria || "",
      tipo,
      valor,
      obs
    });

  }

  return registros;

}

/* ---------------- NORMALIZAÇÃO ---------------- */

function normalizarRegistro(l){

  const data = l.data || l.Data || l.DATA || "";
  const cat  = l.cat  || l.categoria || l.Categoria || "";
  const tipo = l.tipo || l.Tipo || "";
  const valor = l.valor || l.Valor || "";
  const obs = l.obs || l.observacao || l.Observacao || "";

  if(!data || !tipo) return null;

  return {
    data: String(data).substring(0,10),
    cat: String(cat),
    tipo: tipo === "Entrada" ? "Entrada" : "Saída",
    valor: Number(String(valor).replace(/\./g,"").replace(",",".")),
    obs: String(obs)
  };

}
</script>
</body>
</html>
