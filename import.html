<script>
const KEY = "fluxopro_v12";

const params = new URLSearchParams(window.location.search);
let perfil = params.get("perfil");

let buffer = [];
let ignored = [];
let db;

try{

  const raw = localStorage.getItem(KEY);
  if(!raw) throw new Error("Base de dados não encontrada. Abra o FluxoPro primeiro.");

  db = JSON.parse(raw);

  if(!db || !db.profiles){
    throw new Error("Base de dados inválida.");
  }

  if(!perfil){
    perfil = db.active;
  }

  if(!perfil || !db.profiles[perfil]){
    throw new Error(`Perfil "${perfil}" não encontrado.`);
  }

  document.getElementById("perfilNome").innerText = perfil;

}catch(err){

  document.querySelector('.container').innerHTML = `
    <div class="card">
      <h2>⚠️ Erro</h2>
      <div class="status error">${err.message}</div>
      <button onclick="window.close()">Fechar janela</button>
    </div>
  `;
  throw err;
}
</script>
