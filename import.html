<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Importar lançamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<h2>Importar lançamentos</h2>

<p id="perfilInfo"></p>

<input type="file" id="fileInput" accept=".json">
<br><br>
<button id="btnImportar">Importar</button>

<script>
const KEY="fluxopro_v12";

const params=new URLSearchParams(location.search);
let perfil=params.get("perfil");

function loadDB(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) return {active:"default",profiles:{default:[]},profileInfo:{},theme:""};
    return JSON.parse(raw);
  }catch{
    return {active:"default",profiles:{default:[]},profileInfo:{},theme:""};
  }
}

function saveDB(db){
  localStorage.setItem(KEY,JSON.stringify(db));
}

let db=loadDB();

if(!perfil) perfil=db.active||"default";
if(!db.profiles[perfil]) db.profiles[perfil]=[];

perfilInfo.innerText="Perfil de destino: "+perfil;

function lancamentoValido(l){
  if(!l) return false;
  if(typeof l!=="object") return false;
  if(!("data" in l)) return false;
  if(!("cat" in l)) return false;
  if(!("tipo" in l)) return false;
  if(!("valor" in l)) return false;
  if(l.tipo!=="Entrada" && l.tipo!=="Saída") return false;
  if(isNaN(Number(l.valor))) return false;
  return true;
}

btnImportar.onclick=()=>{

  const file=fileInput.files[0];
  if(!file){alert("Selecione um arquivo");return;}

  const reader=new FileReader();

  reader.onload=e=>{

    try{

      const json=JSON.parse(e.target.result);

      if(!Array.isArray(json)){
        alert("Formato inválido");
        return;
      }

      let inseridos=0;
      let ignorados=0;

      json.forEach(l=>{

        if(!lancamentoValido(l)){
          ignorados++;
          return;
        }

        const jaExiste=db.profiles[perfil].some(e=>
          e.data===l.data &&
          e.cat===l.cat &&
          e.tipo===l.tipo &&
          Number(e.valor)===Number(l.valor) &&
          (e.obs||"")===(l.obs||"")
        );

        if(jaExiste){
          ignorados++;
          return;
        }

        db.profiles[perfil].push({
          id:l.id||Date.now()+Math.random(),
          data:l.data,
          cat:l.cat,
          tipo:l.tipo,
          valor:Number(l.valor),
          obs:l.obs||""
        });

        inseridos++;

      });

      saveDB(db);

      alert("Inseridos: "+inseridos+"\nIgnorados: "+ignorados);

    }catch{
      alert("Arquivo inválido");
    }

  };

  reader.readAsText(file);

};
</script>

</body>
</html>
