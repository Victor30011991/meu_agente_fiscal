<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro - Importar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>

<style>
body{font-family:Inter;background:#f5f7fb;color:#1f2937;margin:0;padding:20px}
.container{max-width:600px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.05)}
h1{margin-top:0}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px}
button{padding:10px 14px;border:none;border-radius:10px;background:#4f46e5;color:#fff;font-weight:700;cursor:pointer;transition:.2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.toast{position:fixed;bottom:20px;right:20px;background:#1f2937;color:#fff;padding:12px 20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:10000;animation:slideIn .3s}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}}
</style>
</head>
<body>

<div class="container">
<h1>Importar lan√ßamentos</h1>
<p>Selecione um arquivo (Excel, CSV, TXT ou PDF) para alimentar o perfil ativo.</p>
<input type="file" id="file" accept=".xlsx,.xls,.csv,.txt,.pdf">
<button id="importBtn">üì• Importar</button>
</div>

<script>
const KEY = "fluxopro_v12";

// ‚úÖ Ler perfil ativo da URL
const urlParams = new URLSearchParams(window.location.search);
const perfil = urlParams.get("perfil") || "default";

// ‚úÖ Fun√ß√£o toast
function showToast(msg){
  const toast=document.createElement("div");
  toast.className="toast";
  toast.innerText=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),2000);
}

// ‚úÖ Carregar DB
function loadDB(){
  return JSON.parse(localStorage.getItem(KEY)) || {active:"default", profiles:{default:[]}, profileInfo:{}};
}

// ‚úÖ Salvar DB
function saveDB(db){ localStorage.setItem(KEY,JSON.stringify(db)); }

// ‚úÖ Normalizar valor
function normalizeValue(v){
  let s=String(v||"").replace(/[^\d.,-]/g,"").replace(",",".");
  let n=parseFloat(s);
  return isNaN(n)?0:n;
}

// ‚úÖ Processar Excel/CSV/TXT
function processText(content){
  const linhas = content.split(/\r?\n/);
  const dados=[];
  linhas.forEach((l,i)=>{
    if(i===0) return; // pular cabe√ßalho
    const cols = l.split(/[,;\t]/);
    if(cols.length<5) return;
    dados.push({
      id:crypto.randomUUID(),
      data:cols[0].trim(),
      cat:cols[1].trim(),
      tipo:cols[2].trim(),
      valor:normalizeValue(cols[3]),
      obs:cols[4].trim()
    });
  });
  return dados;
}

// ‚úÖ Processar PDF usando pdf.js
async function processPDF(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  let textContent="";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const txt = await page.getTextContent();
    textContent += txt.items.map(item=>item.str).join(" ") + "\n";
  }
  
  // O PDF do export.html possui linhas com Data, Categoria, Tipo, Valor, Obs
  // Precisamos extrair essas linhas de forma robusta
  const linhas = textContent.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const dados=[];
  
  linhas.forEach(l=>{
    // Regex simples: Data dd/mm/yyyy Categoria Tipo Valor Obs
    const match = l.match(/(\d{2}\/\d{2}\/\d{4})\s+(\S+)\s+(Entrada|Sa√≠da)\s+([R$.\d,]+)\s+(.*)/);
    if(match){
      dados.push({
        id:crypto.randomUUID(),
        data: match[1],
        cat: match[2],
        tipo: match[3],
        valor: normalizeValue(match[4]),
        obs: match[5]
      });
    }
  });
  return dados;
}

document.getElementById("importBtn").onclick=async ()=>{
  const file = document.getElementById("file").files[0];
  if(!file){ showToast("‚ùå Selecione um arquivo"); return; }

  let novos=[];
  try{
    const db = loadDB();
    const perfilDados = db.profiles[perfil] || [];

    if(file.name.endsWith(".xlsx") || file.name.endsWith(".xls")){
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data,{type:"array"});
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(sheet,{header:["data","cat","tipo","valor","obs"],defval:""});
      novos = json.map(i=>({
        id:crypto.randomUUID(),
        data:i.data,
        cat:i.cat,
        tipo:i.tipo,
        valor:normalizeValue(i.valor),
        obs:i.obs
      }));
    } else if(file.name.endsWith(".csv") || file.name.endsWith(".txt")){
      const text = await file.text();
      novos = processText(text);
    } else if(file.name.endsWith(".pdf")){
      novos = await processPDF(file);
    } else{
      showToast("‚ùå Formato n√£o suportado");
      return;
    }

    if(novos.length===0){ showToast("‚ö†Ô∏è Nenhum lan√ßamento encontrado"); return; }

    perfilDados.push(...novos);
    db.profiles[perfil] = perfilDados;
    saveDB(db);

    showToast(`‚úÖ ${novos.length} lan√ßamentos importados`);
    setTimeout(()=>window.close(),1000);
  }catch(e){
    console.error(e);
    showToast("‚ùå Erro ao processar arquivo");
  }
};
</script>

</body>
</html>
