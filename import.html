<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro – Importação</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Inter,system-ui;background:#f1f5f9;padding:20px}
.card{
  background:#fff;
  max-width:900px;
  margin:auto;
  padding:20px;
  border-radius:12px;
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb}
th{background:#2563eb;color:#fff}
button{padding:10px;border:0;border-radius:8px;background:#2563eb;color:#fff}
</style>
</head>
<body>

<div class="card">
<h2>Importar dados</h2>

<input type="file" id="file" accept=".xlsx,.json">

<div style="margin:15px 0">
<button onclick="confirmar()">Confirmar importação</button>
</div>

<table>
<thead>
<tr>
<th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Obs</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
const params = new URLSearchParams(location.search);
const perfil = params.get("perfil");

let buffer = [];

document.getElementById("file").addEventListener("change",load);

function load(e){

  const file = e.target.files[0];
  if(!file) return;

  if(file.name.endsWith(".json")){
    const r = new FileReader();
    r.onload = ev=>{
      const data = JSON.parse(ev.target.result);
      preparar(data);
    };
    r.readAsText(file);
  }else{
    const r = new FileReader();
    r.onload = ev=>{
      const wb = XLSX.read(ev.target.result,{type:"binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws,{defval:""});
      preparar(data);
    };
    r.readAsBinaryString(file);
  }
}

function preparar(rows){

  buffer = rows.map(r=>{

    return {
      data: r.Data || r.data || "",
      cat: r.Categoria || r.categoria || "",
      tipo: normalizarTipo(r.Tipo || r.tipo || ""),
      valor: normalizarValor(r.Valor || r.valor || 0),
      obs: r.Observação || r.obs || r.observacao || ""
    };

  });

  render();
}

function render(){

  const tb=document.getElementById("tbody");
  tb.innerHTML="";

  buffer.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${l.data}</td>
      <td>${l.cat}</td>
      <td>${l.tipo}</td>
      <td>${l.valor}</td>
      <td>${l.obs}</td>
    `;
    tb.appendChild(tr);
  });

}

function confirmar(){

  const db = JSON.parse(localStorage.getItem("fluxopro_db")||"{}");

  if(!db.profiles) db.profiles={};
  if(!db.profiles[perfil]){
    alert("Perfil não encontrado.");
    return;
  }

  db.profiles[perfil].lancamentos.push(...buffer);

  localStorage.setItem("fluxopro_db",JSON.stringify(db));

  alert("Importação concluída.");
  window.close();
}

/* -------- utilidades -------- */

function normalizarValor(v){

  if(typeof v==="number") return v;

  let s = String(v)
    .replace(/\s/g,"")
    .replace("R$","")
    .replace(/\./g,"")
    .replace(",",".");
  const n = parseFloat(s);
  return isNaN(n)?0:n;
}

function normalizarTipo(t){
  t=String(t||"").toLowerCase();
  if(t.includes("ent")) return "Entrada";
  if(t.includes("sai")) return "Saída";
  return "";
}
</script>
</body>
</html>
