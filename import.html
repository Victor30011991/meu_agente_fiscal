<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>FluxoPro â€“ ImportaÃ§Ã£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body{font-family:Inter;background:#f5f7fb;margin:0;color:#1f2937;}
    .container{max-width:1100px;margin:auto;padding:30px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;}
    th, td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;text-align:left;}
    th{background:#f9fafb;font-weight:700;}
    button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s;}
    button:hover{opacity:.8;transform:translateY(-1px);}
    .btn-main{background:#4f46e5;color:#fff;}
    .btn-cancel{background:#ef4444;color:#fff;}
    input[type="file"]{padding:10px;border:2px dashed #4f46e5;border-radius:10px;cursor:pointer;width:100%;}
    .status{padding:10px;border-radius:10px;margin:10px 0;font-weight:700;}
    .status.success{background:#ecfdf5;color:#10b981;}
    .status.error{background:#fef2f2;color:#ef4444;}
    .status.warning{background:#fef9c3;color:#ca8a04;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;}
    .badge-entrada{background:#ecfdf5;color:#10b981;}
    .badge-saida{background:#fef2f2;color:#ef4444;}
    @media(max-width:600px){
      .actions{flex-direction:column;}
      input[type="file"]{width:100%;}
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- UPLOAD -->
    <div class="card">
      <h2>ðŸ“¥ ImportaÃ§Ã£o Assistida</h2>
      <input type="file" id="file" accept=".xlsx,.xls,.pdf">
      <div id="statusBox"></div>
    </div>

    <!-- PREVIEW -->
    <div class="card" id="previewCard" style="display:none">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Obs</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button class="btn-main" onclick="confirmar()">Confirmar</button>
        <button class="btn-cancel" onclick="window.close()">Cancelar</button>
      </div>
    </div>

  </div>

<script>
const KEY="fluxopro_v12";
const params=new URLSearchParams(location.search);
let perfil=params.get("perfil");

let buffer=[], ignored=[], db;

db = JSON.parse(localStorage.getItem(KEY));
if(!perfil) perfil = db.active;

/* Normalizar e validar dados */
function normalizeValue(v){
  let s = String(v||"").replace(/[^\d,.-]/g,"").replace(",",".");
  let n = parseFloat(s);
  return isNaN(n)?null:n;
}

function validateDate(d){
  if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){
    const [a,b,c] = d.split("/");
    return `${c}-${b}-${a}`;
  }
  return null;
}

function validateTipo(t){
  t = String(t||"").toLowerCase();
  if(t==="entrada") return "Entrada";
  if(t==="saÃ­da"||t==="saida") return "SaÃ­da";
  return null;
}

/* UPLOAD DE ARQUIVOS */
file.onchange = async () => {
  buffer = [];
  ignored = [];
  const f = file.files[0];
  if(!f) return;

  const ext = f.name.split(".").pop().toLowerCase();
  if(ext === "pdf") await importarPDF(f);
  else importarExcel(f);
};

/* Excel */
function importarExcel(f){
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });
    const sh = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sh, { defval:"" });
    processar(data);
  };
  r.readAsBinaryString(f);
}

/* PDF */
async function importarPDF(f){
  const ab = await f.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: ab}).promise;
  let linhas = [];

  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const c = await page.getTextContent();

    let l="", ly=null;
    c.items.forEach(i => {
      if(ly!==null && Math.abs(i.transform[5]-ly) > 5){
        linhas.push(l.trim()); l="";
      }
      l += i.str + " ";
      ly = i.transform[5];
    });
    if(l.trim()) linhas.push(l.trim());
  }

  const data=[];
  linhas.forEach(t=>{
    const m=t.match(/^(\d{4}-\d{2}-\d{2})\s+(.+?)\s+(Entrada|SaÃ­da)\s+R\$\s*([\d.,-]+)\s*(.*)$/);
    if(!m) return;
    data.push({Data:m[1],Categoria:m[2],Tipo:m[3],Valor:m[4],Observacao:m[5]});
  });

  processar(data);
}

/* PROCESSAR DADOS */
function processar(data){
  data.forEach((l,i)=>{
    const d=validateDate(l.Data);
    const t=validateTipo(l.Tipo);
    const v=normalizeValue(l.Valor);

    if(!d||!t||v===null){ ignored.push(l); return; }

    buffer.push({
      data: d,
      cat: l.Categoria||"Sem categoria",
      tipo: t,
      valor: v,
      obs: l.Observacao||""
    });
  });

  render();
}

/* RENDER PREVIEW */
function render(){
  if(!buffer.length){
    statusBox.innerHTML = "<div class='status error'>Nenhum dado vÃ¡lido</div>";
    return;
  }

  previewCard.style.display = "block";

  tb.innerHTML = buffer.map((l,i) => `
    <tr>
      <td>${i+1}</td>
      <td>${l.data}</td>
      <td>${l.cat}</td>
      <td><span class="badge badge-${l.tipo.toLowerCase()}">${l.tipo}</span></td>
      <td>${l.valor.toFixed(2)}</td>
      <td>${l.obs}</td>
      <td>OK</td>
    </tr>
  `).join("");
}

/* CONFIRMAR IMPORTAÃ‡ÃƒO */
function confirmar(){
  buffer.forEach(l=>{
    db.profiles[perfil].push({id:crypto.randomUUID(), ...l});
  });
  localStorage.setItem(KEY, JSON.stringify(db));
  alert("Importado com sucesso");

  // Atualiza perfil do index automaticamente
  if(window.opener && !window.opener.closed){
    window.opener.refreshAll?.();
  }
  window.close();
}
</script>
</body>
</html>
