<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro ‚Äì Importa√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:Inter;background:#f5f7fb;color:#1f2937}
.container{max-width:1100px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;text-align:left}
th{background:#f9fafb;font-weight:700}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-main{background:#4f46e5;color:#fff}
.btn-cancel{background:#ef4444;color:#fff}
input[type="file"]{padding:10px;border:2px dashed #4f46e5;border-radius:10px;cursor:pointer;width:100%;font-family:inherit}
.status{padding:10px;border-radius:10px;margin:10px 0;font-weight:700}
.status.success{background:#ecfdf5;color:#10b981}
.status.error{background:#fef2f2;color:#ef4444}
.status.warning{background:#fef9c3;color:#ca8a04}
.info{background:#eff6ff;padding:15px;border-radius:10px;border-left:4px solid #4f46e5;margin-bottom:20px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.badge-entrada{background:#ecfdf5;color:#10b981}
.badge-saida{background:#fef2f2;color:#ef4444}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="container">

  <div class="card">
    <h2>üì• Importa√ß√£o Assistida</h2>
    <div class="info">
      <strong>üìÅ Perfil de destino:</strong> <span id="perfilNome"></span><br>
      <small>Os dados ser√£o adicionados sem remover existentes</small>
    </div>
    <div class="info" style="background:#fef9c3;border-left-color:#ca8a04">
      <strong>‚ö†Ô∏è Formato do Excel esperado:</strong><br>
      ‚Ä¢ Colunas: Data | Categoria | Tipo | Valor | Observa√ß√£o<br>
      ‚Ä¢ Tipo: "Entrada" ou "Sa√≠da"<br>
      ‚Ä¢ Valor num√©rico<br>
      ‚Ä¢ Data: AAAA-MM-DD ou DD/MM/AAAA
    </div>
    <input type="file" id="file" accept=".xlsx,.xls">
    <div id="statusBox"></div>
  </div>

  <div class="card" id="previewCard" style="display:none">
    <h3>üìã Pr√©via dos dados (50 linhas)</h3>
    <p><strong>Total v√°lidos:</strong> <span id="countValid">0</span></p>
    <p><strong>Ignorados:</strong> <span id="countIgnored">0</span></p>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Observa√ß√£o</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
    <div class="actions" style="margin-top:20px">
      <button class="btn-main" onclick="confirmar()">‚úÖ Confirmar importa√ß√£o</button>
      <button class="btn-cancel" onclick="cancelar()">‚ùå Cancelar</button>
    </div>
  </div>

</div>

<script>
const KEY="fluxopro_v12";
let db = JSON.parse(localStorage.getItem(KEY)) || {profiles:{default:[]},active:'default'};
let perfil=db.active;
let buffer=[],ignored=[];

document.getElementById("perfilNome").innerText=perfil;

function normalizeValue(v){
  if(!v) return null;
  let n=parseFloat(String(v).replace(/[^\d,.-]/g,"").replace(",","."));
  return isNaN(n)||n===0?null:n;
}
function validateDate(d){
  if(!d) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){const[a,b,c]=d.split("/");return `${c}-${b}-${a}`;}
  return null;
}
function validateTipo(t){
  const tipo=String(t||"").trim();
  if(tipo.toLowerCase()==="entrada") return "Entrada";
  if(tipo.toLowerCase()==="sa√≠da"||tipo.toLowerCase()==="saida") return "Sa√≠da";
  return null;
}

file.onchange=()=>{buffer=[];ignored=[];const reader=new FileReader();
reader.onload=e=>{
  try{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const data=XLSX.utils.sheet_to_json(sheet,{defval:""});
    if(!data.length)return showStatus("‚ö†Ô∏è Arquivo vazio","warning");

    data.forEach((linha,index)=>{
      const data=validateDate(linha.Data);
      const tipo=validateTipo(linha.Tipo);
      const valor=normalizeValue(linha.Valor);
      const cat=linha.Categoria||"Sem categoria";
      const obs=linha.Observacao||linha.Observa√ß√£o||"";
      if(!tipo){ignored.push({linha:index+2,motivo:"Tipo inv√°lido",original:linha});return;}
      if(valor===null){ignored.push({linha:index+2,motivo:"Valor inv√°lido",original:linha});return;}
      if(!data){ignored.push({linha:index+2,motivo:"Data inv√°lida",original:linha});return;}
      buffer.push({data,cat,tipo,valor,obs});
    });
    renderPreview();
  }catch(err){showStatus("‚ùå Erro: "+err.message,"error");}
};reader.readAsBinaryString(file.files[0]);}

function renderPreview(){
  document.getElementById("countValid").innerText=buffer.length;
  document.getElementById("countIgnored").innerText=ignored.length;
  if(!buffer.length){showStatus("‚ö†Ô∏è Nenhum lan√ßamento v√°lido","error");previewCard.style.display="none";return;}
  showStatus(`‚úÖ ${buffer.length} lan√ßamentos v√°lidos encontrados!`,"success");
  previewCard.style.display="block";
  const preview=buffer.slice(0,50);
  tb.innerHTML=preview.map((l,i)=>`
    <tr>
      <td>${i+1}</td><td>${l.data}</td><td>${l.cat}</td><td><span class="badge badge-${l.tipo.toLowerCase()}">${l.tipo}</span></td>
      <td>R$ ${l.valor.toFixed(2)}</td><td>${l.obs||"-"}</td><td style="color:#10b981">‚úÖ OK</td>
    </tr>`).join("")+
    ignored.slice(0,20).map(ign=>`<tr style="background:#fef2f2"><td>-</td><td colspan="5" style="color:#ef4444">${ign.motivo}</td><td style="color:#ef4444">‚ùå Ignorado</td></tr>`).join("");
}

function showStatus(msg,type){statusBox.innerHTML=`<div class="status ${type}">${msg}</div>`;}

function confirmar(){
  if(!buffer.length)return alert("‚ùå Nenhum lan√ßamento v√°lido");
  if(!confirm(`Importar ${buffer.length} lan√ßamentos para ${perfil}?`))return;
  buffer.forEach(l=>{db.profiles[perfil].push({id:crypto.randomUUID(),...l});});
  localStorage.setItem(KEY,JSON.stringify(db));
  alert(`‚úÖ Importa√ß√£o conclu√≠da!`);
  window.close();
}
function cancelar(){if(confirm("‚ùå Cancelar importa√ß√£o?"))window.close();}
</script>
</body>
</html>
