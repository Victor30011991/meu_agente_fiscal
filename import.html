<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro ‚Äì Importa√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<!-- Bibliotecas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.16.105/pdf.min.js"></script>

<style>
body{font-family:Inter;background:#f5f7fb;margin:0;color:#1f2937}
.container{max-width:1100px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;text-align:left}
th{background:#f9fafb;font-weight:700}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-main{background:#4f46e5;color:#fff}
.btn-cancel{background:#ef4444;color:#fff}
input[type="file"]{padding:10px;border:2px dashed #4f46e5;border-radius:10px;cursor:pointer;width:100%;font-family:inherit}
.status{padding:10px;border-radius:10px;margin:10px 0;font-weight:700}
.status.success{background:#ecfdf5;color:#10b981}
.status.error{background:#fef2f2;color:#ef4444}
.status.warning{background:#fef9c3;color:#ca8a04}
.info{background:#eff6ff;padding:15px;border-radius:10px;border-left:4px solid #4f46e5;margin-bottom:20px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.badge-entrada{background:#ecfdf5;color:#10b981}
.badge-saida{background:#fef2f2;color:#ef4444}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="container">

  <div class="card">
    <h2>üì• Importa√ß√£o Assistida</h2>
    
    <div class="info">
      <strong>üìÅ Perfil de destino:</strong> <span id="perfilNome"></span><br>
      <small>Os dados ser√£o adicionados a este perfil sem remover lan√ßamentos existentes</small>
    </div>

    <div class="info" style="background:#fef9c3;border-left-color:#ca8a04">
      <strong>‚ö†Ô∏è Formato esperado:</strong><br>
      ‚Ä¢ Excel: Colunas: Data | Categoria | Tipo | Valor | Observa√ß√£o<br>
      ‚Ä¢ PDF: Texto com linhas no mesmo formato (pipe "|" recomendado)<br>
      ‚Ä¢ Tipo deve ser "Entrada" ou "Sa√≠da"<br>
      ‚Ä¢ Valor deve ser num√©rico (ex: 1500 ou 1500.50)<br>
      ‚Ä¢ Data no formato: AAAA-MM-DD ou DD/MM/AAAA
    </div>

    <input type="file" id="file" accept=".xlsx,.xls,.pdf">
    
    <div id="statusBox"></div>
  </div>

  <div class="card" id="previewCard" style="display:none">
    <h3>üìã Pr√©via dos dados (primeiras 50 linhas)</h3>
    <p><strong>Total de lan√ßamentos v√°lidos:</strong> <span id="countValid">0</span></p>
    <p><strong>Linhas ignoradas:</strong> <span id="countIgnored">0</span></p>
    
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Categoria</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Observa√ß√£o</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>

    <div class="actions" style="margin-top:20px">
      <button class="btn-main" onclick="confirmar()">‚úÖ Confirmar importa√ß√£o</button>
      <button class="btn-cancel" onclick="cancelar()">‚ùå Cancelar</button>
    </div>
  </div>

</div>

<script>
const KEY = "fluxopro_v12";

// ‚úÖ RECEBER PERFIL DA URL
const params = new URLSearchParams(window.location.search);
let perfil = params.get("perfil");

let buffer = [];
let ignored = [];
let db;

// ‚úÖ VALIDA√á√ïES ROBUSTAS
try {
  db = JSON.parse(localStorage.getItem(KEY));
  
  if(!db || !db.profiles){
    throw new Error("Base de dados n√£o encontrada. Abra o FluxoPro primeiro.");
  }
  
  if(!perfil){
    perfil = db.active;
  }
  
  if(!perfil || !db.profiles[perfil]){
    throw new Error(`Perfil "${perfil}" n√£o encontrado.`);
  }
  
  document.getElementById("perfilNome").innerText = perfil;
  
} catch(err) {
  document.querySelector('.container').innerHTML = `
    <div class="card">
      <h2>‚ö†Ô∏è Erro</h2>
      <div class="status error">${err.message}</div>
      <button onclick="window.close()">Fechar janela</button>
    </div>
  `;
  throw err;
}

// ‚úÖ NORMALIZAR VALOR
function normalizeValue(v){
  if(v === null || v === undefined || v === "") return null;
  if(typeof v === "number") return v;
  
  let s = String(v)
    .replace(/[^\d,.-]/g,"")
    .replace(",", ".");

  let n = parseFloat(s);
  return isNaN(n) || n === 0 ? null : n;
}

// ‚úÖ VALIDAR DATA
function validateDate(d){
  if(!d) return null;
  
  let date;
  
  if(/^\d{4}-\d{2}-\d{2}$/.test(d)){
    date = d;
  } else if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){
    const [dia, mes, ano] = d.split("/");
    date = `${ano}-${mes}-${dia}`;
  } else {
    return null;
  }
  
  const [y, m, day] = date.split("-").map(Number);
  const testDate = new Date(y, m-1, day);
  if(testDate.getFullYear() === y && testDate.getMonth() === m-1 && testDate.getDate() === day){
    return date;
  }
  
  return null;
}

// ‚úÖ VALIDAR TIPO
function validateTipo(t){
  const tipo = String(t||"").trim();
  if(tipo === "Entrada" || tipo === "entrada") return "Entrada";
  if(tipo === "Sa√≠da" || tipo === "Saida" || tipo === "sa√≠da" || tipo === "saida") return "Sa√≠da";
  return null;
}

// ‚úÖ PROCESSAR ARQUIVO (EXCEL OU PDF)
file.onchange = async () => {
  buffer = [];
  ignored = [];
  const arquivo = file.files[0];
  const ext = arquivo.name.split('.').pop().toLowerCase();

  if(ext === "xlsx" || ext === "xls") {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, {type:"binary"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, {defval:""});
        processarLinhas(data);
      } catch(err) {
        showStatus("‚ùå Erro ao ler Excel: " + err.message, "error");
      }
    };
    reader.readAsBinaryString(arquivo);
  } 
  else if(ext === "pdf") {
    try {
      const arrayBuffer = await arquivo.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      let textoCompleto = "";

      for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(" ");
        textoCompleto += pageText + "\n";
      }

      const linhas = textoCompleto.split("\n").map(l => {
        const partes = l.split(/\s*\|\s*/); // separar por pipe |
        return {
          Data: partes[0],
          Categoria: partes[1],
          Tipo: partes[2],
          Valor: partes[3],
          Observacao: partes[4] || ""
        };
      });

      processarLinhas(linhas);

    } catch(err) {
      showStatus("‚ùå Erro ao ler PDF: " + err.message, "error");
    }
  } 
  else {
    showStatus("‚ö†Ô∏è Formato de arquivo n√£o suportado", "warning");
  }
};

// ‚úÖ PROCESSAR LINHAS
function processarLinhas(data){
  if(!data.length){
    showStatus("‚ö†Ô∏è Arquivo vazio ou sem dados v√°lidos", "warning");
    return;
  }

  data.forEach((linha, index) => {
    const dataValida = validateDate(linha.Data);
    const tipo = validateTipo(linha.Tipo);
    const valor = normalizeValue(linha.Valor);
    const cat = String(linha.Categoria||"").trim();
    const obs = String(linha.Observacao || linha.Observa√ß√£o || "").trim();

    if(!tipo){
      ignored.push({linha: index+2, motivo: "Tipo inv√°lido (use 'Entrada' ou 'Sa√≠da')", original: linha});
      return;
    }
    if(valor === null){
      ignored.push({linha: index+2, motivo: "Valor inv√°lido ou zero", original: linha});
      return;
    }
    if(!dataValida){
      ignored.push({linha: index+2, motivo: "Data inv√°lida (use AAAA-MM-DD ou DD/MM/AAAA)", original: linha});
      return;
    }

    buffer.push({
      data: dataValida,
      cat: cat || "Sem categoria",
      tipo,
      valor,
      obs
    });
  });

  renderPreview();
}

// ‚úÖ RENDERIZAR PR√âVIA
function renderPreview(){
  document.getElementById("countValid").innerText = buffer.length;
  document.getElementById("countIgnored").innerText = ignored.length;
  
  if(!buffer.length){
    showStatus("‚ö†Ô∏è Nenhum lan√ßamento v√°lido encontrado no arquivo", "error");
    previewCard.style.display = "none";
    return;
  }
  
  showStatus(`‚úÖ ${buffer.length} lan√ßamentos v√°lidos encontrados! Revise abaixo e confirme.`, "success");
  previewCard.style.display = "block";
  
  const preview = buffer.slice(0, 50);
  
  tb.innerHTML = preview.map((l, i)=>`
  <tr>
    <td>${i+1}</td>
    <td>${l.data}</td>
    <td>${l.cat}</td>
    <td><span class="badge badge-${l.tipo.toLowerCase()}">${l.tipo}</span></td>
    <td><b>R$ ${l.valor.toFixed(2)}</b></td>
    <td>${l.obs || "-"}</td>
    <td style="color:#10b981">‚úÖ OK</td>
  </tr>
  `).join("") + 
  ignored.slice(0, 20).map(ign=>`
  <tr style="background:#fef2f2">
    <td>-</td>
    <td colspan="5" style="color:#ef4444">${ign.motivo}</td>
    <td style="color:#ef4444">‚ùå Ignorado</td>
  </tr>
  `).join("");
  
  if(buffer.length > 50){
    tb.innerHTML += `<tr><td colspan="7" style="text-align:center;color:#999">... e mais ${buffer.length - 50} lan√ßamentos</td></tr>`;
  }
}

// ‚úÖ STATUS
function showStatus(msg, type){
  statusBox.innerHTML = `<div class="status ${type}">${msg}</div>`;
}

// ‚úÖ CONFIRMAR IMPORTA√á√ÉO
function confirmar(){
  if(!buffer.length){
    alert("‚ùå Nenhum lan√ßamento v√°lido para importar");
    return;
  }
  
  if(!confirm(`‚úÖ Importar ${buffer.length} lan√ßamentos para o perfil "${perfil}"?`)){
    return;
  }
  
  try {
    buffer.forEach(l=>{
      db.profiles[perfil].push({
        id: crypto.randomUUID(),
        ...l
      });
    });
    
    localStorage.setItem(KEY, JSON.stringify(db));
    
    alert(`‚úÖ Importa√ß√£o conclu√≠da com sucesso!\n\n${buffer.length} lan√ßamentos adicionados ao perfil "${perfil}"`);
    window.close();
    
  } catch(err) {
    alert("‚ùå Erro ao salvar: " + err.message);
  }
}

// ‚úÖ CANCELAR
function cancelar(){
  if(confirm("‚ùå Cancelar importa√ß√£o?")){
    window.close();
  }
}
</script>

</body>
</html>
