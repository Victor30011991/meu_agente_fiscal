<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>FluxoPro ‚Äì Importa√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{font-family:Inter;background:#f5f7fb;margin:0;color:#1f2937}
.container{max-width:1100px;margin:auto;padding:30px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.04);margin-bottom:20px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:14px;text-align:left}
th{background:#f9fafb;font-weight:700}
button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;transition:all .2s}
button:hover{opacity:.8;transform:translateY(-1px)}
.btn-main{background:#4f46e5;color:#fff}
.btn-cancel{background:#ef4444;color:#fff}
input[type="file"]{padding:10px;border:2px dashed #4f46e5;border-radius:10px;cursor:pointer;width:100%;font-family:inherit}
.status{padding:10px;border-radius:10px;margin:10px 0;font-weight:700}
.status.success{background:#ecfdf5;color:#10b981}
.status.error{background:#fef2f2;color:#ef4444}
.status.warning{background:#fef9c3;color:#ca8a04}
.info{background:#eff6ff;padding:15px;border-radius:10px;border-left:4px solid #4f46e5;margin-bottom:20px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.empty{text-align:center;padding:40px;color:#999}
</style>
</head>
<body>

<div class="container">

  <div class="card">
    <h2>üì• Importa√ß√£o Assistida</h2>
    <div class="info">
      <strong>üìÅ Perfil de destino:</strong> <span id="perfilNome"></span><br>
      <small>Os dados ser√£o adicionados a este perfil sem remover lan√ßamentos existentes</small>
    </div>
    <div class="info" style="background:#fef9c3;border-left-color:#ca8a04">
      <strong>‚ö†Ô∏è Formato esperado:</strong><br>
      ‚Ä¢ Colunas: Data | Categoria | Tipo | Valor | Observacao<br>
      ‚Ä¢ Tipo deve ser "Entrada" ou "Sa√≠da"<br>
      ‚Ä¢ Valor deve ser num√©rico<br>
      ‚Ä¢ Data: AAAA-MM-DD ou DD/MM/AAAA
    </div>

    <!-- ‚úÖ Aceita Excel, CSV, TXT -->
    <input type="file" id="file" accept=".xlsx,.xls,.csv,.txt">

    <div id="statusBox"></div>
  </div>

  <div class="card" id="previewCard" style="display:none">
    <h3>üìã Pr√©via dos dados</h3>
    <p><strong>Total v√°lidos:</strong> <span id="countValid">0</span></p>
    <p><strong>Linhas ignoradas:</strong> <span id="countIgnored">0</span></p>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr><th>#</th><th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Observacao</th><th>Status</th></tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
    <div class="actions" style="margin-top:20px">
      <button class="btn-main" onclick="confirmar()">‚úÖ Confirmar importa√ß√£o</button>
      <button class="btn-cancel" onclick="cancelar()">‚ùå Cancelar</button>
    </div>
  </div>

</div>

<script>
const KEY="fluxopro_v12";
let db = JSON.parse(localStorage.getItem(KEY));
let perfil = db?.active || Object.keys(db.profiles)[0];
document.getElementById("perfilNome").innerText = perfil;

let buffer=[], ignored=[];

function normalizeValue(v){
  if(v===null||v===undefined||v==="") return null;
  if(typeof v==="number") return v;
  let s = String(v).replace(/[^\d,.-]/g,"").replace(",",".");
  let n = parseFloat(s);
  return isNaN(n)?null:n;
}

function validateDate(d){
  if(!d) return null;
  let date=null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(d)) date=d;
  else if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){
    const [dia,mes,ano]=d.split("/");
    date=`${ano}-${mes}-${dia}`;
  }else return null;
  const [y,m,day]=date.split("-").map(Number);
  const test=new Date(y,m-1,day);
  return test.getFullYear()===y&&test.getMonth()===m-1&&test.getDate()===day?date:null;
}

function validateTipo(t){
  const tipo = String(t||"").trim();
  if(["Entrada","entrada"].includes(tipo)) return "Entrada";
  if(["Sa√≠da","Saida","sa√≠da","saida"].includes(tipo)) return "Sa√≠da";
  return null;
}

function showStatus(msg,type){document.getElementById("statusBox").innerHTML=`<div class="status ${type}">${msg}</div>`;}
function renderPreview(){
  document.getElementById("countValid").innerText=buffer.length;
  document.getElementById("countIgnored").innerText=ignored.length;
  if(!buffer.length){showStatus("‚ö†Ô∏è Nenhum lan√ßamento v√°lido", "error"); previewCard.style.display="none"; return;}
  showStatus(`‚úÖ ${buffer.length} lan√ßamentos v√°lidos encontrados`, "success");
  previewCard.style.display="block";
  const preview = buffer.slice(0,50);
  tb.innerHTML = preview.map((l,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${l.data}</td>
      <td>${l.cat}</td>
      <td>${l.tipo}</td>
      <td>${l.valor.toFixed(2)}</td>
      <td>${l.obs||"-"}</td>
      <td style="color:#10b981">‚úÖ OK</td>
    </tr>`).join("") +
    ignored.slice(0,20).map(ign=>`
    <tr style="background:#fef2f2">
      <td>-</td>
      <td colspan="5" style="color:#ef4444">${ign.motivo}</td>
      <td style="color:#ef4444">‚ùå Ignorado</td>
    </tr>`).join("");
}

file.onchange = ()=>{
  buffer=[]; ignored=[];
  const reader = new FileReader();
  const f = file.files[0];
  const ext = f.name.split('.').pop().toLowerCase();

  reader.onload = e=>{
    try{
      let data=[];
      if(ext==="xlsx"||ext==="xls"){
        const wb=XLSX.read(e.target.result,{type:"binary"});
        data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
      } else {
        let txt = e.target.result.split(/\r?\n/);
        const headers = txt[0].split(/[,;|\t]/);
        data = txt.slice(1).map(l=>{
          const obj={};
          l.split(/[,;|\t]/).forEach((v,i)=>obj[headers[i].trim()]=v.trim());
          return obj;
        });
      }

      data.forEach((linha,index)=>{
        const d = validateDate(linha.Data);
        const tipo = validateTipo(linha.Tipo);
        const valor = normalizeValue(linha.Valor);
        const cat = String(linha.Categoria||"Sem categoria").trim();
        const obs = String(linha.Observacao||linha.Observa√ß√£o||"").trim();
        if(!tipo) {ignored.push({linha:index+2,motivo:"Tipo inv√°lido"}); return;}
        if(valor===null){ignored.push({linha:index+2,motivo:"Valor inv√°lido"}); return;}
        if(!d){ignored.push({linha:index+2,motivo:"Data inv√°lida"}); return;}
        buffer.push({data:d,cat,tipo,valor,obs});
      });
      renderPreview();
    }catch(err){showStatus("‚ùå Erro: "+err.message,"error");}
  };

  if(ext==="xlsx"||ext==="xls") reader.readAsBinaryString(f);
  else reader.readAsText(f);
}

function confirmar(){
  if(!buffer.length){alert("Nenhum lan√ßamento v√°lido"); return;}
  if(!confirm(`Importar ${buffer.length} lan√ßamentos para "${perfil}"?`)) return;
  buffer.forEach(l=>{
    db.profiles[perfil].push({id:crypto.randomUUID(),...l});
  });
  localStorage.setItem(KEY, JSON.stringify(db));
  alert(`‚úÖ ${buffer.length} lan√ßamentos importados com sucesso`);
  window.close();
}

function cancelar(){if(confirm("Cancelar importa√ß√£o?")) window.close();}
</script>
</body>
</html>
